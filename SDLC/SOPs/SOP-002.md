# SOP-002: Quality Assurance Requirements

**Effective Date:** 2026-01-01

---

## 1. Purpose

When evaluating change control records, SDLC documentation, or other GMP materials, the Quality Assurance representative shall reject any change that does not adhere to the following foundational principles.

Additionally, all other stakeholders involved in the planning, implementation, and review of changes, drafting of documentation, or execution of periodic audits or reviews of the codebase, shall ensure that these principles are followed.

---

## 2. Foundational Principles

### 2.1 Addition via Generalization (AvG)

**Principle:** When fixing a bug or adding a feature, do not solve the specific instance of the problem. Solve the general class of the problem.

#### The Philosophy

| Anti-Pattern | AvG Approach |
|--------------|--------------|
| "The text field in 'Material Properties' is not losing focus." -> Add a check in `MaterialDialog.update()` | "Text fields lack robust focus relinquishment." -> Implement `on_focus_lost()` in base `UIElement` class |
| Hardcoding `if material_widget.is_open: draw()` | Create `OverlayProvider` protocol; UIManager iterates all providers |
| Checking `if save_dialog.is_active or settings_dialog.is_active` | Implement central `modal_stack`; block if stack is non-empty |

#### Canonical Case Studies

| Domain | Rejected Pattern | Approved Pattern |
|--------|-----------------|------------------|
| UI Rendering | `if dropdown.open: draw()` in UIManager | `OverlayProvider` protocol. UIManager iterates all providers. |
| Input Blocking | `if save_dialog.is_active` checks | Centralized `modal_stack` in AppController |
| Focus Management | `widget.active = False` manually | InputHandler manages `session.focused_element` |
| State Reset | Reset specific button on dialog close | Recursive `reset_interaction_state()` on modal push/pop |
| Materials | Modify `material.color` in widget | UI submits `MaterialModificationCommand` to Queue |
| Z-Order | "Render dropdowns last" hack | Relative Z-Order: `child.z = parent.z + 1` |
| Configuration | Inline `mass = 5.0` | Extract to `core/config.py` as `config.DEFAULT_MASS` |

---

### 2.2 The Air Gap

**Principle:** The UI (Tools, Widgets, Inputs) is strictly forbidden from modifying the Data Model (Sketch or Simulation) directly. All mutations must flow through Commands.

| Non-Conforming | Conforming |
|----------------|------------|
| `select_tool.py` directly setting `line.end_point = (10, 10)` | `select_tool.py` submits `SetEntityGeometryCommand` to `scene.execute()` |
| Widget imports `Entity` and mutates properties | Widget communicates only through Commands |
| Direct property assignment on Model objects | All mutations flow through `scene.execute()` |

**Rationale:** If a state change does not happen via a Command, it is not recorded in history. If it isn't in history, the simulation state is corrupted upon replay or undo.

---

### 2.3 The Command Pattern

**Principle:** The Command class is the atomic unit of change in the application. It serves as the primary history chronicle for the project.

| Requirement | Description |
|-------------|-------------|
| Source of Truth | The Command History is the ultimate authority |
| Replayability | Any mutation without a Command breaks the chain of custody |
| Structure | Every command implements `execute()` and `undo()` |
| Historize Flag | Indicates if command enters undo stack (true) or is transient (false) |

#### Undo Strategy by Domain

| Domain | Strategy |
|--------|----------|
| Geometric | Absolute State Snapshots (start pos vs. end pos) - solver nondeterminism requires this |
| Physics | Full State Snapshots - fluid dynamics are irreversible |

---

### 2.4 Configuration Hygiene

**Principle:** No magic numbers. All constants must be extracted to `core/config.py`.

| Non-Conforming | Conforming |
|----------------|------------|
| `mass = 5.0` | `mass = config.DEFAULT_MASS` |
| `color = (255, 0, 0)` | `color = config.ENTITY_COLOR` |
| `friction = 0.3` | `friction = config.DEFAULT_FRICTION` |

---

## 3. The Seven Red Flags

QA shall reject any change exhibiting these patterns:

### 3.1 Boolean Flags for State
- **Violation:** `is_motor`, `is_open`, `is_hovered` as state management
- **Correction:** Use State Enum, Strategy Pattern, or Protocol

### 3.2 Type Checking (isinstance)
- **Violation:** `if isinstance(obj, RectTool): ...`
- **Correction:** Object must implement a Protocol. Consumer must not know concrete type.

### 3.3 Magic Numbers
- **Violation:** `mass = 5.0`, `color = (255, 0, 0)`
- **Correction:** Extract to `core/config.py`

### 3.4 Parallel Hierarchies
- **Violation:** Creating `MotorTool` when `RevoluteJoint` exists
- **Correction:** Parameterize the existing class (e.g., add `driver_speed` to `RevoluteJoint`)

### 3.5 Direct Model Mutation (Air Gap Violation)
- **Violation:** `tool.py` setting `entity.x = 10`
- **Correction:** Must use `CommandQueue.add(SetEntityPositionCommand(...))`

### 3.6 Hardcoded Widget Rendering
- **Violation:** `if widget.active: widget.draw()`
- **Correction:** Register as `OverlayProvider`; let generic renderer handle it

### 3.7 Symptomatic Bug Fixing
- **Violation:** Resetting a specific button's state in a specific dialog's close method
- **Correction:** Reset entire UI tree's interaction state on any modal close

---

## 4. Review Questions

Before approving any change, stakeholders shall verify:

### 4.1 The Potency Test
> Does this change enable future features "for free"?

A new protocol that all future widgets can use passes. A one-off hack fails.

### 4.2 Surgical Precision
> Is this the minimum viable mutation?

Ask: Can I accomplish this by deleting code rather than adding it?

### 4.3 Root Cause Analysis
> Am I treating a symptom or curing the disease?

Symptomatic fixes are rejected. General solutions are approved.

### 4.4 Deletion Preference
> Could this be achieved by removing code rather than adding it?

The best code is no code. Prefer deletion over addition.

---

## 5. References

- `SOP-001` - GMP Governance Framework
- `CLAUDE.md` - Technical Architecture Guide
- Domain-specific SOPs (SOP-003 through SOP-009) for implementation details

---

*Document Control: SOP-002 v1.0*
*Effective: 2026-01-01*
