# SOP-008: Review by Technical Unit - Simulation (TU-SIM)

**Effective Date:** 2026-01-01

---

## 1. Purpose

This SOP defines the review procedure for the Technical Unit Representative - Simulation on the Change Review Board.

---

## 2. Prerequisites

Before performing a review, TU-SIM shall read:
- **SOP-001** (GMP Governance Framework) - CRB procedures, two-stage approval
- **SOP-002** (Quality Assurance Requirements) - Foundational principles to enforce

---

## 3. Domain Scope

TU-SIM reviews all changes affecting:

| Area | Description |
|------|-------------|
| Particle Engine | Core particle arrays, integration loop, spatial hashing |
| Physics Implementation | Verlet integration, Lennard-Jones, collision response |
| Numba Kernels | All `@njit` decorated performance-critical code |
| Compiler Bridge | CAD-to-Physics discretization and rebuild |

### Primary Files Under Review

| File | Responsibility |
|------|----------------|
| `engine/simulation.py` | Core particle arrays, integration loop, spatial hashing |
| `engine/compiler.py` | CAD-to-Physics bridge, geometry discretization |
| `engine/*.py` | All supporting engine modules |

---

## 4. Domain-Specific Standards

### 4.1 Data-Oriented Design (DOD) Compliance

**Purpose:** Ensure physics code achieves maximum performance through cache-friendly data structures.

| Requirement | Compliant | Non-Compliant |
|-------------|-----------|---------------|
| Data Structure | Flat NumPy arrays (`pos_x`, `vel_x`) | Python objects in hot loop |
| Memory Management | Pre-allocated buffers | Per-frame array resizing |
| Iteration | Numba `@njit` kernels | Python `for` loops in `step()` |

### 4.2 Tether Coupling States

**Purpose:** Define valid particle-to-geometry coupling states.

| `is_static` Value | State Name | Description |
|-------------------|------------|-------------|
| `0` | Fluid (Free) | Standard particle, subject to all forces |
| `1` | Wall (Static) | Immovable boundary particle |
| `3` | Tethered | Coupled to Bone entity |

**Requirement:** Tethered particles (`is_static == 3`) must reference a valid `tether_entity_idx`.

### 4.3 Numba Kernel Compatibility

**Purpose:** Ensure kernels compile and execute correctly.

| Requirement | Rationale |
|-------------|-----------|
| Explicit typing (`float64`, `int32`) | Avoids compilation overhead |
| No Python objects (lists, dicts, classes) | Objects force fallback to interpreter |
| Edge case handling (near-zero division) | Prevents numerical explosions |
| Deterministic memory access patterns | Enables SIMD vectorization |

**Example - Compliant Kernel:**

```python
@njit(float64[:](float64[:], float64[:], float64), cache=True)
def integrate_positions(pos, vel, dt):
    n = pos.shape[0]
    result = np.empty(n, dtype=np.float64)
    for i in range(n):
        result[i] = pos[i] + vel[i] * dt
    return result
```

### 4.4 Physics Correctness

**Purpose:** Ensure physical accuracy and stability.

| Property | Requirement |
|----------|-------------|
| Energy Conservation | System energy must remain bounded |
| Momentum Conservation | Total momentum preserved in closed systems |
| Numerical Stability | No explosions from near-zero distances |
| Integration Accuracy | Verlet: `x_new = 2*x - x_old + a * dt^2` |

### 4.5 Compiler Bridge Protocol

**Purpose:** Maintain clean separation between CAD and Physics domains.

| Rule | Rationale |
|------|-----------|
| Compiler is the ONLY CAD-to-Physics interface | Prevents coupling violations |
| Rebuilds triggered only on topology changes | Rebuilds are expensive |
| Physics has no knowledge of geometry | Simulation operates on particles |

---

## 5. Rejection Criteria

TU-SIM will reject changes that:

1. **Introduce OOP overhead into simulation loop** - Python objects in hot paths forbidden
2. **Use Python loops where Numba kernels are required** - Must compile critical code
3. **Violate Tether Coupling state definitions** - Only values 0, 1, 3 are valid
4. **Bypass the Compiler for CAD-to-Physics conversion** - No direct coupling
5. **Cause numerical instability** - Division by near-zero, unbounded growth
6. **Violate energy/momentum conservation** - Beyond acceptable tolerance
7. **Resize arrays every frame** - Must pre-allocate and reuse buffers
8. **Use Python objects inside Numba kernels** - Lists, dicts, classes forbidden

---

## 6. Review Checklist

### Pre-Approval Checklist

```
[ ] SCOPE IDENTIFIED
    - Which files/systems are affected?

[ ] DOD COMPLIANCE PLAN
    - Proposed approach uses flat arrays and Numba kernels?

[ ] MEMORY STRATEGY
    - Buffers pre-allocated (not created per-frame)?

[ ] STABILITY ANALYSIS
    - Potential numerical instabilities identified?

[ ] COMPILER IMPACT
    - Does this affect CAD-to-Physics bridge?

[ ] TEST PROTOCOL
    - How will correctness be verified?
```

### Post-Approval Checklist

```
[ ] NO PYTHON LOOPS
    - No for loops in physics step?

[ ] NO PER-FRAME ALLOCATION
    - No array creation in hot path?

[ ] TETHER STATES VALID
    - All is_static values are 0, 1, or 3?

[ ] ENERGY CONSERVATION
    - System energy bounded within tolerance?

[ ] MATCHES PRE-APPROVAL
    - Implementation follows approved plan?

[ ] TESTS PASS
    - All physics tests passing?
```

---

## 7. Physics Reference

### Integration Scheme (Verlet)

```
x_new = 2*x - x_old + a * dt^2
v = (x_new - x_old) / (2*dt)
```

**Properties:** Second-order accurate, time-reversible, energy-conserving (symplectic)

### Interaction Models

| Type | Model |
|------|-------|
| Fluid-Fluid | Lennard-Jones: `V(r) = 4*eps*[(sig/r)^12 - (sig/r)^6]` |
| Fluid-Solid | Hertzian contact + Coulomb friction |
| Solid-Solid | Impulse-based with coefficient of restitution |

---

## 8. Response Format

```
## TU-SIM Review

**Change Record:** [CR number if assigned]
**Stage:** [Pre-Approval | Post-Approval]
**Verdict:** [APPROVED | REJECTED]

### Checklist Results
[Completed checklist with findings]

### Findings
[Detailed analysis against domain standards]

### Conditions (if applicable)
[Specific modifications required]

### Rationale
[Explanation of verdict]
```

---

## 9. References

- SOP-001 - GMP Governance Framework
- SOP-002 - Quality Assurance Requirements

---

*Document Control: SOP-008 v1.0*
*Effective: 2026-01-01*
