# SOP-004: Review by Technical Unit - User Interface (TU-UI)

**Effective Date:** 2026-01-01

---

## 1. Purpose

This SOP defines the review procedure for the Technical Unit Representative - User Interface on the Change Review Board.

---

## 2. Prerequisites

Before performing a review, TU-UI shall read:
- **SOP-001** (GMP Governance Framework) - CRB procedures, two-stage approval
- **SOP-002** (Quality Assurance Requirements) - Foundational principles to enforce

---

## 3. Domain Scope

TU-UI reviews all changes affecting:

| Area | Description |
|------|-------------|
| Widget Implementation | `ui/` directory |
| Rendering Logic | Draw calls, sprite management, visual output |
| Layout Systems | Panels, containers, positioning |
| Overlay Management | Dropdowns, tooltips, floating elements |
| Z-Order and Depth | Visual layering |
| UI State Management | Hover, click, focus states within widgets |
| Visual Configuration | Colors, sizes, spacing in `core/config.py` |

---

## 4. Domain-Specific Standards

### 4.1 The Air Gap (UI Perspective)

**Requirement:** UI Widgets NEVER mutate the Data Model directly.

| Non-Conforming | Conforming |
|----------------|------------|
| `slider.on_change = lambda: entity.mass = 5` | UI submits `SetEntityPropertyCommand` to Scene |
| Widget imports `Entity` for mutation | Widget communicates only through Commands |

### 4.2 The Overlay Protocol

**Requirement:** Widgets with floating elements must implement the `OverlayProvider` protocol.

| Non-Conforming | Conforming |
|----------------|------------|
| `if dropdown.is_open: draw(dropdown)` in UIManager | Widget implements `OverlayProvider` |
| Hardcoded widget rendering logic | UIManager iterates registered providers |

### 4.3 Z-Order Hygiene

**Requirement:** Overlays render at `parent.z + 1`. No global "render last" hacks.

| Non-Conforming | Conforming |
|----------------|------------|
| Appending widget to "render_last" list | Widget inherits Z from parent with offset |

### 4.4 State Compliance

**Requirement:** Widgets are Views, not Controllers. They do not store authoritative state.

| Non-Conforming | Conforming |
|----------------|------------|
| `self.current_material = Material("Steel")` | Query `MaterialManager` |
| Caching authoritative state in widget | Query `Session.active_material` |

### 4.5 Input Hygiene

**Requirement:** Widgets must respect modal stack and focus management protocols.

- Check modal state before processing input
- Implement `on_focus_lost()` for clean state transitions
- Implement `reset_interaction_state()` for ghost input prevention
- Implement `wants_focus()` appropriately

---

## 5. Review Checklist

```
[ ] AIR GAP COMPLIANCE
    - No direct Model mutation from UI code
    - State changes flow through CommandQueue

[ ] OVERLAY PROTOCOL COMPLIANCE
    - Floating elements use OverlayProvider protocol
    - No hardcoded widget rendering in UIManager

[ ] Z-ORDER COMPLIANCE
    - No global rendering hacks
    - Depth is relative to parent

[ ] STATE COMPLIANCE
    - Widgets query managers rather than caching authoritative state

[ ] CONFIGURATION COMPLIANCE
    - No hardcoded magic numbers for visual properties
    - New constants extracted to core/config.py

[ ] FOCUS HYGIENE
    - New interactive widgets implement on_focus_lost()
    - Widgets implement wants_focus() appropriately
    - reset_interaction_state() implemented where needed
```

---

## 6. Coordination with Other TUs

| Partner | Boundary |
|---------|----------|
| TU-INPUT | TU-UI owns widget-internal focus state; TU-INPUT owns focus switching logic |
| TU-SCENE | TU-UI ensures Commands are submitted; TU-SCENE owns Command implementation |

---

## 7. Response Format

```
## TU-UI Review

**Change Record:** [CR Number/Title]
**Stage:** [Pre-Approval | Post-Approval]

### Checklist Results
- [PASS | FAIL | N/A] Air Gap Compliance: [notes]
- [PASS | FAIL | N/A] Overlay Protocol Compliance: [notes]
- [PASS | FAIL | N/A] Z-Order Compliance: [notes]
- [PASS | FAIL | N/A] State Compliance: [notes]
- [PASS | FAIL | N/A] Configuration Compliance: [notes]
- [PASS | FAIL | N/A] Focus Hygiene: [notes]

### Findings
[Detailed observations, concerns, or commendations]

### Determination

**Status:** [APPROVED | REJECTED]

**Conditions (if applicable):**
- [Required modifications before proceeding]

**Rationale:**
[Explanation of determination]
```

---

## 8. References

- SOP-001 - GMP Governance Framework
- SOP-002 - Quality Assurance Requirements

---

*Document Control: SOP-004 v1.0*
*Effective: 2026-01-01*
