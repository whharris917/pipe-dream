# SOP-007: Review by Technical Unit - CAD/Geometry (TU-SKETCH)

**Effective Date:** 2026-01-01

---

## 1. Purpose

This SOP defines the review procedure for the Technical Unit Representative - CAD/Geometry on the Change Review Board.

---

## 2. Prerequisites

Before performing a review, TU-SKETCH shall read:
- **SOP-001** (GMP Governance Framework) - CRB procedures, two-stage approval
- **SOP-002** (Quality Assurance Requirements) - Foundational principles to enforce

---

## 3. Domain Scope

TU-SKETCH reviews all changes affecting:

| Area | Description |
|------|-------------|
| Geometric Entities | Lines, Circles, Arcs, Points, future primitives |
| Geometric Constraints | Horizontal, Vertical, Perpendicular, Parallel, etc. |
| The Solver | Hybrid PBD architecture (Legacy Python + Numba JIT) |

### Primary Files Under Review

| File | Responsibility |
|------|----------------|
| `model/sketch.py` | Core geometric entities, Sketch container |
| `model/solver.py` | Constraint solver orchestration |
| `model/solver_kernels.py` | Numba-optimized PBD mathematics |
| `model/constraints.py` | Constraint definitions (if separate) |

---

## 4. Domain-Specific Standards

### 4.1 Domain Sovereignty (Critical)

**Standard:** The Sketch domain must remain pure. It models geometry only.

| Requirement | Description |
|-------------|-------------|
| No Physics Imports | `model/` files shall not import from `engine/` |
| No Physics Concepts | Velocity, Mass, Force, Atoms are prohibited in Sketch code |
| One-Way Dependency | Compiler reads Sketch; Sketch never reads Simulation |

**Examples:**

```python
# VIOLATION - Importing physics into geometry
from engine.simulation import Particle  # REJECT

# VIOLATION - Physics concept in geometry code
class Line(Entity):
    def __init__(self):
        self.mass = 1.0  # REJECT

# COMPLIANT - Pure geometry
class Line(Entity):
    def __init__(self, start: Point, end: Point):
        self.start = start
        self.end = end
```

### 4.2 Constraint Stability

**Standard:** All constraints must be mathematically sound and numerically stable.

| Requirement | Description |
|-------------|-------------|
| PBD Compliance | Constraints must define `project()` method |
| Zero Division | Handle degenerate cases (zero-length vectors, coincident points) |
| Convergence | Constraints should converge within reasonable iterations |
| Edge Cases | Document behavior for over/under-determined systems |

**Example - Proper Constraint Implementation:**

```python
class DistanceConstraint(Constraint):
    def project(self, positions):
        delta = positions[self.p2] - positions[self.p1]
        length = np.linalg.norm(delta)

        # REQUIRED: Handle degenerate case
        if length < 1e-10:
            return  # Or apply small perturbation

        direction = delta / length
        correction = (length - self.target_distance) * 0.5
        positions[self.p1] += correction * direction
        positions[self.p2] -= correction * direction
```

### 4.3 Entity Hierarchy

**Standard:** The type hierarchy must remain coherent and extensible.

| Requirement | Description |
|-------------|-------------|
| Base Class | All drawable objects inherit from `Entity` |
| Required Methods | Implement `get_bounds()`, `contains_point()`, etc. |
| Protocol Compliance | New entities must satisfy existing protocols |

---

## 5. Rejection Criteria

Recommend **REJECTED** status for any change that:

1. **Violates Domain Sovereignty** - Imports from `engine/` or introduces physics concepts
2. **Introduces Numerical Instability** - Division by zero risk, non-convergent constraints
3. **Bypasses Entity Hierarchy** - Drawables not inheriting from Entity
4. **Violates AvG Principle** - Creates new class when parameterization suffices
5. **Lacks PBD Compliance** - Constraints without `project()` method

---

## 6. Review Checklist

### Pre-Approval Checklist

```
[ ] IMPORT CHECK
    - Any imports from engine/ in model/ files?
    - Physics modules referenced in Sketch code?

[ ] PHYSICS LEAKAGE CHECK
    - Terms like "velocity", "mass", "force", "atom", "particle" appear?
    - Physics concepts encoded under different names?

[ ] MATH STABILITY CHECK
    - New constraint handles zero-length vectors?
    - New constraint handles coincident points?
    - Division that could produce infinity/NaN?

[ ] PBD COMPLIANCE CHECK
    - New constraint implements project() method?
    - Correction is symmetric/balanced?

[ ] AVG COMPLIANCE CHECK
    - Could this be achieved by parameterizing existing class?
    - Solution is general (serves future use cases)?

[ ] ENTITY HIERARCHY CHECK
    - New drawable types inherit from Entity?
    - Required methods implemented?
```

---

## 7. Response Format

```
## TU-SKETCH Pre-Approval Review

**Change:** [Brief description]
**Files Affected:** [List relevant files]

### Checklist Results

| Check | Status | Notes |
|-------|--------|-------|
| Import Check | PASS/FAIL | [Details] |
| Physics Leakage | PASS/FAIL | [Details] |
| Math Stability | PASS/FAIL | [Details] |
| PBD Compliance | PASS/FAIL | [Details] |
| AvG Compliance | PASS/FAIL | [Details] |
| Entity Hierarchy | PASS/FAIL | [Details] |

### Decision

**Status:** [APPROVED | REJECTED]

**Reasoning:** [Specific findings and rationale]

**Conditions (if applicable):** [Requirements for approval]
```

---

## 8. References

- SOP-001 - GMP Governance Framework
- SOP-002 - Quality Assurance Requirements

---

*Document Control: SOP-007 v1.0*
*Effective: 2026-01-01*
