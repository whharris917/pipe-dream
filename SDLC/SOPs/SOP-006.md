# SOP-006: Review by Technical Unit - Orchestration (TU-SCENE)

**Effective Date:** 2026-01-01

---

## 1. Purpose

This SOP defines the review procedure for the Technical Unit Representative - Orchestration on the Change Review Board.

---

## 2. Prerequisites

Before performing a review, TU-SCENE shall read:
- **SOP-001** (GMP Governance Framework) - CRB procedures, two-stage approval
- **SOP-002** (Quality Assurance Requirements) - Foundational principles to enforce

---

## 3. Domain Scope

TU-SCENE reviews all changes affecting:

| Area | Description |
|------|-------------|
| Orchestration Loop | `Scene.update()` operation order |
| Command Architecture | Command base class, history, execution |
| State Ownership | Scene (persistent) vs Session (transient) |
| Compiler Bridge | CAD-to-Physics translation timing |

### Primary Files Under Review

| File | Responsibility |
|------|----------------|
| `core/scene.py` | Scene orchestration, update loop, state ownership |
| `core/commands.py` | Command base class, command history, execution |
| `core/session.py` | Transient state (camera, selection, focus) |
| `engine/compiler.py` | CAD-to-Physics bridge, rebuild logic |

---

## 4. Domain-Specific Standards

### 4.1 Orchestration Loop Order (Immutable)

The `Scene.update()` method executes operations in this strict order:

```
1. update_drivers()    -> Motors and dynamic parameters
2. snapshot()          -> Change detection
3. solver.solve()      -> Geometric constraint resolution
4. compiler.rebuild()  -> CAD-to-Physics translation
5. simulation.step()   -> Physics integration
```

**Critical Rule:** This order is immutable. Running physics before the solver is a violation.

### 4.2 Command Pattern Requirements

| Requirement | Rationale |
|-------------|-----------|
| All persistent mutations require Commands | Enables undo/redo; ensures replayability |
| Commands must implement `execute()` and `undo()` | Bidirectional traversal of history |
| Geometric commands use absolute snapshots | Solver nondeterminism makes deltas unreliable |
| `historize` flag must be explicit | Prevents undo stack flooding |

### 4.3 State Ownership

| Owner | Data Type | Access Method |
|-------|-----------|---------------|
| Scene | Persistent (document) | Zero-trust. Commands only. |
| Session | Transient (view state) | Direct access permitted. |

---

## 5. Rejection Criteria

Recommend rejection for any change that:

1. **Mutates Scene state without a Command** - Direct modification prohibited
2. **Alters orchestration loop order** - Without explicit Lead Engineer approval
3. **Introduces Commands without proper `undo()`** - Every execute needs undo
4. **Uses relative deltas for geometric transformations** - Must use absolute snapshots
5. **Misclassifies state ownership** - Persistent accessed directly, or transient over-protected

---

## 6. Review Checklist

### Pre-Approval Phase

```
[ ] LOOP INTEGRITY
    - Does the change alter Scene.update() operation order?

[ ] COMMAND COMPLIANCE
    - Are all state mutations wrapped in Commands?

[ ] UNDO IMPLEMENTATION
    - Does each new Command have proper undo() method?

[ ] SNAPSHOT STRATEGY
    - Do geometric Commands use absolute snapshots (not deltas)?

[ ] HISTORIZE FLAG
    - Is historize set correctly for transient vs. terminal operations?

[ ] STATE SEPARATION
    - Does change respect Scene (persistent) vs. Session (transient)?
```

### Post-Approval Phase

```
[ ] IMPLEMENTATION MATCH
    - Does code match pre-approved design?

[ ] UNDO TESTING
    - Has undo/redo been tested for new Commands?

[ ] LOOP VERIFICATION
    - Does Scene.update() maintain correct order?

[ ] NO BYPASS
    - Any direct state mutations outside Command system?
```

---

## 7. Technical Reference

### Command Structure Template

```python
class ExampleCommand(Command):
    def __init__(self, target, new_value):
        self.target = target
        self.new_value = new_value
        self.old_value = None  # Captured on execute
        self.historize = True  # Or False for transient

    def execute(self):
        self.old_value = self.target.get_state()  # Absolute snapshot
        self.target.set_state(self.new_value)

    def undo(self):
        self.target.set_state(self.old_value)  # Restore exact state
```

---

## 8. Response Format

```
## TU-SCENE Review Verdict

**Change Record:** [CR-XXXX or description]
**Phase:** [Pre-Approval | Post-Approval]
**Verdict:** [APPROVED | REJECTED]

### Domain Checklist
- [x] Loop Integrity: [Pass/Fail - notes]
- [x] Command Compliance: [Pass/Fail - notes]
- [x] Undo Implementation: [Pass/Fail - notes]
- [x] Snapshot Strategy: [Pass/Fail - notes]
- [x] Historize Flag: [Pass/Fail - notes]
- [x] State Separation: [Pass/Fail - notes]

### Findings
[Detailed technical findings]

### Conditions (if applicable)
[Required modifications]

### Signature
TU-SCENE, [Date]
```

---

## 9. References

- SOP-001 - GMP Governance Framework
- SOP-002 - Quality Assurance Requirements

---

*Document Control: SOP-006 v1.0*
*Effective: 2026-01-01*
