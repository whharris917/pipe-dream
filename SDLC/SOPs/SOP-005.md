# SOP-005: Review by Technical Unit - Input Handling (TU-INPUT)

**Effective Date:** 2026-01-01

---

## 1. Purpose

This SOP defines the review procedure for the Technical Unit Representative - Input Handling on the Change Review Board.

---

## 2. Prerequisites

Before performing a review, TU-INPUT shall read:
- **SOP-001** (GMP Governance Framework) - CRB procedures, two-stage approval
- **SOP-002** (Quality Assurance Requirements) - Foundational principles to enforce

---

## 3. Domain Scope

TU-INPUT reviews all changes affecting:

| Area | Description |
|------|-------------|
| Event Handling | Flow of input events through the application |
| Focus Management | Keyboard focus tracking and transitions between widgets |
| Modal Systems | Modal stack and blocking behavior |
| Input Chain | 4-Layer Input Protocol (System, Global, Modal, HUD) |
| Tools | Mouse interaction logic for tools (Select, Line, Brush, etc.) |

### Primary Files Under Review

| File | Responsibility |
|------|----------------|
| `ui/input_handler.py` | Event routing, input chain implementation |
| `ui/tools.py` | Tool implementations |
| `core/app_controller.py` | Modal stack management |
| `core/session.py` | Focus tracking |

---

## 4. Domain-Specific Standards

### 4.1 The 4-Layer Input Protocol

All input must flow through the established hierarchy:

1. **System Layer:** Window events (QUIT, VIDEORESIZE)
2. **Global Layer:** Hotkeys and keyboard shortcuts
3. **Modal Layer (Blocking):** If `modal_stack` is non-empty, lower layers receive no events
4. **HUD Layer:** UI widgets and tools

**Acceptance Criteria:**
- New input handlers check `app_controller.is_modal_active()` before processing
- Event consumption returns `True` immediately to prevent fall-through
- No layer bypasses a higher-priority layer

### 4.2 Generic Focus Management

Focus must be managed through the centralized system, not manually.

| Non-Conforming | Conforming |
|----------------|------------|
| `widget.active = False` (direct manipulation) | `session.request_focus(widget)` |

**Acceptance Criteria:**
- Widgets implement `wants_focus()` to indicate focus eligibility
- Widgets implement `on_focus_lost()` to clean up state
- No widget directly modifies another widget's focus state

### 4.3 Interaction State Reset

When modal state changes, interaction state must be reset to prevent ghost inputs.

**Acceptance Criteria:**
- `push_modal()` triggers `reset_interaction_state()` on the UI tree
- `pop_modal()` triggers `reset_interaction_state()` on the UI tree
- New widgets implement `reset_interaction_state()` to clear states

### 4.4 Tool Polymorphism

Tools should operate on abstract entity types, not concrete implementations.

**Acceptance Criteria:**
- Tools use the `Entity` base class interface
- Tools do not contain entity-type-specific logic where generic logic suffices

---

## 5. Non-Conformance Codes

| Code | Non-Conformance | Description |
|------|-----------------|-------------|
| NC-INPUT-001 | Input Chain Bypass | Checking global state deep in a tool |
| NC-INPUT-002 | Manual Focus Toggle | Directly setting `widget.active` |
| NC-INPUT-003 | Missing Focus Cleanup | No `on_focus_lost()` implementation |
| NC-INPUT-004 | Modal Blocking Failure | No modal state check |
| NC-INPUT-005 | Event Consumption Failure | No `return True` after handling |
| NC-INPUT-006 | Ghost Input Risk | No interaction state reset on modal change |
| NC-INPUT-007 | Tool Specificity | Entity-type-specific logic where generic suffices |

---

## 6. Review Checklist

```
[ ] BLOCKING CHECK
    - Does new input logic check app_controller.is_modal_active()?

[ ] FOCUS HYGIENE
    - Does new widget implement on_focus_lost()?

[ ] EVENT CONSUMPTION
    - Does handler return True after consuming event?

[ ] NO INPUT SNIFFING
    - Uses standard Input Chain, not global state checks?

[ ] RESET STATE
    - Does modal open/close trigger reset_interaction_state()?

[ ] TOOL POLYMORPHISM
    - Does tool operate on generic Entity interface?
```

---

## 7. Response Format

```
## TU-INPUT Review

**Change:** [Brief description]
**Stage:** [Pre-Approval | Post-Approval]

### Checklist Results
- [PASS | FAIL] Blocking Check
- [PASS | FAIL] Focus Hygiene
- [PASS | FAIL] Event Consumption
- [PASS | FAIL] No Input Sniffing
- [PASS | FAIL] Reset State
- [PASS | FAIL | N/A] Tool Polymorphism

### Findings
[List non-conformances with NC codes, or "No non-conformances identified"]

### Decision
**Status:** [APPROVED | REJECTED]

**Conditions (if applicable):**
[Required modifications]

**Rationale:**
[Explanation]
```

---

## 8. References

- SOP-001 - GMP Governance Framework
- SOP-002 - Quality Assurance Requirements

---

*Document Control: SOP-005 v1.0*
*Effective: 2026-01-01*
