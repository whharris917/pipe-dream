services:
  claude-agent:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /pipe-dream
    volumes:
      # Production QMS (read-only)
      - ../../:/pipe-dream:ro
      # Workspace (read-write overlay) - per agent via QMS_USER
      - ../../.claude/users/${QMS_USER:-claude}/workspace:/pipe-dream/.claude/users/${QMS_USER:-claude}/workspace:rw
      # Sessions (read-write overlay) - added per CR-046
      - ../../.claude/sessions:/pipe-dream/.claude/sessions:rw
      # MCP config overlay - MUST overlay host's stdio config with container HTTP config
      # (host's .mcp.json has Windows paths that don't work in container)
      - ./.mcp.json:/pipe-dream/.mcp.json:ro
      # Settings overlay - enable the MCP server
      - ./.claude-settings.json:/pipe-dream/.claude/settings.local.json:ro
      # SSH keys (read-only)
      - ~/.ssh:/.ssh:ro
      # Claude Code config (bind mount per agent) - per CR-056
      # Each agent has isolated auth/config in .claude/users/{agent}/container/
      - ../../.claude/users/${QMS_USER:-claude}/container:/claude-config:rw
    environment:
      - HOME=/
      # Point Claude Code to persistent config directory - per GitHub issue #1736
      - CLAUDE_CONFIG_DIR=/claude-config
      # Increase MCP startup timeout (default 30000ms) - per CR-052 investigation
      - MCP_TIMEOUT=60000
      # GitHub token for git operations (per CR-053) - reads from .env file
      - GH_TOKEN=${GH_TOKEN:-}
      # QMS user identity - passed from claude-session.sh
      - QMS_USER=${QMS_USER:-claude}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Linux compatibility
    stdin_open: true
    tty: true
