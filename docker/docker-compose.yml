services:
  claude-agent:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /pipe-dream
    volumes:
      # Production QMS (read-only)
      - ../:/pipe-dream:ro
      # Workspace (read-write overlay)
      - ../.claude/users/claude/workspace:/pipe-dream/.claude/users/claude/workspace:rw
      # Sessions (read-write overlay) - added per CR-046
      - ../.claude/sessions:/pipe-dream/.claude/sessions:rw
      # MCP config overlay - MUST overlay host's stdio config with container HTTP config
      # (host's .mcp.json has Windows paths that don't work in container)
      - ./.mcp.json:/pipe-dream/.mcp.json:ro
      # Settings overlay - enable the MCP server
      - ./.claude-settings.json:/pipe-dream/.claude/settings.local.json:ro
      # SSH keys (read-only)
      - ~/.ssh:/.ssh:ro
      # Claude Code config (persistent via named volume) - per CR-052/issue #1736
      # Auth persists: first run requires login, subsequent runs don't
      - claude-config:/claude-config
    environment:
      - HOME=/
      # Point Claude Code to persistent config directory - per GitHub issue #1736
      - CLAUDE_CONFIG_DIR=/claude-config
      # Increase MCP startup timeout (default 30000ms) - per CR-052 investigation
      - MCP_TIMEOUT=60000
      # GitHub token for git operations (per CR-053) - reads from .env file
      - GH_TOKEN=${GH_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Linux compatibility
    stdin_open: true
    tty: true

# Named volumes for persistent data
volumes:
  claude-config:
