#!/bin/bash
# pd-status — Pipe Dream process overview utility
#
# Shows status of all Pipe Dream background services and containers.
# Zero Python dependencies.
#
# Usage:
#   ./pd-status              # Show status overview
#   ./pd-status --stop-all   # Kill all services and remove containers
#
# Authorized by: CR-062, CR-063

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# --- Service definitions ---
# Format: "label:port:health_path"
SERVICES=(
    "QMS MCP:8000:/mcp"
    "Git MCP:8001:/mcp"
    "Agent Hub:9000:/api/health"
)

# --- Container name patterns from launch.sh ---
# launch.sh names containers "agent-{name}", docker-compose uses "docker-claude-agent-1"
CONTAINER_FILTERS=("name=agent-")

# --- Helpers ---

# Find the PID of the process listening on a given port.
# Returns the PID on stdout, or empty string if no listener found.
find_pid_on_port() {
    local port="$1"
    if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "mingw"* || "$OSTYPE" == "cygwin" ]]; then
        powershell.exe -NoProfile -Command "
            \$c = Get-NetTCPConnection -LocalPort $port -State Listen -ErrorAction SilentlyContinue | Select-Object -First 1
            if (\$c) { \$c.OwningProcess }
        " 2>/dev/null | tr -d '\r\n[:space:]'
    elif command -v lsof &>/dev/null; then
        lsof -ti :"$port" 2>/dev/null | head -1
    elif command -v ss &>/dev/null; then
        ss -tlnp "sport = :$port" 2>/dev/null | { grep -oP 'pid=\K\d+' || true; } | head -1
    fi
}

# Probe a port via curl. Returns 0 if any HTTP response received.
port_alive() {
    local port="$1"
    local path="$2"
    local code
    code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${port}${path}" 2>/dev/null) || code="000"
    [[ "$code" != "000" ]]
}

# Get the HTTP status code from a health endpoint.
health_code() {
    local port="$1"
    local path="$2"
    local code
    code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${port}${path}" 2>/dev/null) || code="000"
    echo "$code"
}

# --- Stop-all mode ---

stop_all() {
    echo -e "${BOLD}Pipe Dream — Stop All${NC}"
    echo -e "═══════════════════════════════════════════════"
    echo ""

    # Enumerate what will be stopped
    local has_work=false

    for svc in "${SERVICES[@]}"; do
        IFS=':' read -r label port healthpath <<< "$svc"
        if port_alive "$port" "$healthpath"; then
            has_work=true
            break
        fi
    done

    local containers
    containers=$(docker ps -a --filter "name=agent-" --format "{{.Names}}" 2>/dev/null || true)
    if [ -n "$containers" ]; then
        has_work=true
    fi

    if [ "$has_work" = false ]; then
        echo -e "  ${DIM}Nothing to stop — no services or containers found.${NC}"
        echo ""
        return 0
    fi

    # Show what will be stopped
    echo -e "  ${YELLOW}The following will be stopped:${NC}"
    echo ""

    for svc in "${SERVICES[@]}"; do
        IFS=':' read -r label port healthpath <<< "$svc"
        if port_alive "$port" "$healthpath"; then
            local pid
            pid=$(find_pid_on_port "$port")
            printf "    %-12s :%-5s" "$label" "$port"
            [ -n "$pid" ] && printf "  (PID %s)" "$pid"
            echo ""
        fi
    done

    if [ -n "$containers" ]; then
        echo ""
        echo "$containers" | while read -r name; do
            echo "    Container: $name"
        done
    fi

    echo ""
    read -r -p "  Proceed? [y/N] " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "  ${DIM}Cancelled.${NC}"
        return 0
    fi

    echo ""

    # Kill services by port-based PID discovery
    for svc in "${SERVICES[@]}"; do
        IFS=':' read -r label port healthpath <<< "$svc"

        local pid
        pid=$(find_pid_on_port "$port")

        if [ -n "$pid" ]; then
            if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "mingw"* || "$OSTYPE" == "cygwin" ]]; then
                taskkill.exe //PID "$pid" //F >/dev/null 2>&1 || true
            else
                kill "$pid" 2>/dev/null || true
            fi
            echo -e "  ${GREEN}✓${NC} Killed $label (PID $pid on :$port)"
        elif port_alive "$port" "$healthpath"; then
            echo -e "  ${YELLOW}!${NC} $label on :$port is responding but could not find owning PID"
        fi
    done

    # Stop containers
    if [ -n "$containers" ]; then
        echo "$containers" | while read -r name; do
            docker rm -f "$name" >/dev/null 2>&1 || true
            echo -e "  ${GREEN}✓${NC} Removed container $name"
        done
    fi

    echo ""
    echo -e "  ${GREEN}Done.${NC}"
    echo ""
}

# --- Status mode ---

show_status() {
    echo -e "${BOLD}Pipe Dream Status${NC}"
    echo -e "═══════════════════════════════════════════════"
    echo ""

    # --- Services ---
    echo -e "${CYAN}Services${NC}"

    for svc in "${SERVICES[@]}"; do
        IFS=':' read -r label port healthpath <<< "$svc"

        if port_alive "$port" "$healthpath"; then
            local status="${GREEN}RUNNING${NC}"
            local suffix=""

            local pid
            pid=$(find_pid_on_port "$port")
            [ -n "$pid" ] && suffix="  ${DIM}(PID ${pid})${NC}"

            # Special: Hub agent summary
            if [ "$label" = "Agent Hub" ]; then
                local hub_json
                hub_json=$(curl -s "http://localhost:${port}/api/status" 2>/dev/null || true)
                if [ -n "$hub_json" ]; then
                    local running stopped
                    running=$(echo "$hub_json" | { grep -o '"state":"running"' || true; } | wc -l)
                    stopped=$(echo "$hub_json" | { grep -o '"state":"stopped"' || true; } | wc -l)
                    if [ "$running" -gt 0 ] 2>/dev/null; then
                        suffix="${suffix}  ${DIM}(${running} agents running, ${stopped} stopped)${NC}"
                    fi
                fi
            fi

            printf "  %-12s :%-5s %b%b\n" "$label" "$port" "$status" "$suffix"
        else
            printf "  %-12s :%-5s ${RED}STOPPED${NC}\n" "$label" "$port"
        fi
    done

    echo ""

    # --- Containers ---
    echo -e "${CYAN}Containers${NC}"

    local has_containers=false
    if command -v docker &>/dev/null; then
        local container_lines
        container_lines=$(docker ps -a --filter "name=agent-" --format "{{.Names}}\t{{.State}}\t{{.Status}}" 2>/dev/null || true)

        if [ -n "$container_lines" ]; then
            has_containers=true
            while IFS=$'\t' read -r name state status_str; do
                local state_color="$DIM"
                case "$state" in
                    running) state_color="$GREEN" ;;
                    exited)  state_color="$RED" ;;
                    *)       state_color="$YELLOW" ;;
                esac
                printf "  %-20s ${state_color}%-10s${NC} %s\n" "$name" "${state^^}" "$status_str"
            done <<< "$container_lines"
        fi
    fi

    if [ "$has_containers" = false ]; then
        echo -e "  ${DIM}No pipe-dream containers found.${NC}"
    fi

    echo ""
}

# --- Main ---

case "${1:-}" in
    --stop-all)
        stop_all
        ;;
    --help|-h)
        echo "Usage: pd-status [--stop-all]"
        echo ""
        echo "Show status of Pipe Dream background services and containers."
        echo ""
        echo "Options:"
        echo "  --stop-all   Kill all services and remove containers"
        echo "  --help       Show this help"
        ;;
    "")
        show_status
        ;;
    *)
        echo "Unknown option: $1"
        echo "Usage: pd-status [--stop-all]"
        exit 1
        ;;
esac
