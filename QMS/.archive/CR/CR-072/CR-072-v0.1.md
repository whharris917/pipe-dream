---
title: Demand-Driven Bootstrap and Terminal Fix
revision_summary: Initial draft
---

# CR-072: Demand-Driven Bootstrap and Terminal Fix

## 1. Purpose

Add demand-driven bootstrapping to the Agent Hub stack so each layer ensures its dependencies are running before proceeding. Fix a terminal escape sequence bug where DA responses appear as literal text in agent prompts. Update READMEs to reflect these changes.

---

## 2. Scope

### 2.1 Context

Independent improvement identified during development. The agent-hub is a three-layer stack (MCP servers -> Hub -> GUI) where each layer currently assumes the one below is already running, requiring manual startup in the correct order.

- **Parent Document:** None

### 2.2 Changes Summary

1. Hub `start` command auto-starts MCP servers before binding
2. Tauri shell scope configured to allow GUI to spawn `agent-hub start`
3. GUI auto-bootstrap: detects Hub down, spawns it, polls until ready
4. Terminal DA escape sequence muting during scrollback buffer replay
5. README updates for both `agent-hub/` and `agent-hub/gui/`

### 2.3 Files Affected

- `agent-hub/agent_hub/cli.py` -- Add `ensure_mcp_servers()` call in `start()` command
- `agent-hub/gui/src-tauri/capabilities/default.json` -- Add `shell:allow-spawn` scoped permission
- `agent-hub/gui/src/ensureHub.ts` -- New file: auto-bootstrap logic
- `agent-hub/gui/src/types.ts` -- Add `"bootstrapping"` to `ConnectionStatus` union
- `agent-hub/gui/src/App.tsx` -- ensureHub-then-connect lifecycle
- `agent-hub/gui/src/components/StatusBar.tsx` -- "Starting Hub..." label for bootstrapping state
- `agent-hub/gui/src/styles/global.css` -- `.bootstrapping` dot style (yellow, pulsing)
- `agent-hub/gui/src/hooks/useHubConnection.ts` -- muteInput guard for buffer replay
- `agent-hub/README.md` -- Fix stale refs, document auto-start
- `agent-hub/gui/README.md` -- Document auto-bootstrap

---

## 3. Current State

- `agent-hub start` starts only the Hub (Layer 2). MCP servers (Layer 1) must already be running.
- The GUI assumes the Hub is already running. If the Hub is down, the GUI shows "Connection error" and enters reconnect-with-backoff.
- When xterm.js processes scrollback buffer containing DA (Device Attributes) requests from tmux/bash, it generates response sequences (e.g., `ESC[>0;276;0c`) that are sent through `terminal.onData()` as user input, appearing as literal text in the Claude Code prompt.
- `agent-hub/README.md` references a stale `services` command (renamed to `status` in CR-071).

---

## 4. Proposed State

- `agent-hub start` calls `ensure_mcp_servers(config)` before instantiating the Hub, auto-starting MCP servers if they are not already running.
- The GUI calls `ensureHub()` on mount: checks Hub health, spawns `agent-hub start` via Tauri shell if down, polls health until ready, then connects the WebSocket. Status bar shows "Starting Hub..." with a pulsing yellow dot during bootstrap.
- During scrollback buffer replay, a `muteInput` guard prevents DA response sequences from being sent to the PTY.
- READMEs accurately reflect the current command names and auto-bootstrap behavior.

---

## 5. Change Description

### 5.1 Hub Auto-Starts MCP Servers (EI-1)

Add a single `ensure_mcp_servers(config)` call in `cli.py`'s `start()` command, after `HubConfig` creation (line 41) and before `AgentHub` instantiation (line 42). Import `ensure_mcp_servers` from `agent_hub.services`. The function is already idempotent (checks `is_port_alive()` first).

### 5.2 Tauri Shell Scope (EI-2)

Add a scoped `shell:allow-spawn` permission entry to `default.json` that restricts execution to the single command `agent-hub start`:

```json
{
  "identifier": "shell:allow-spawn",
  "allow": [
    {
      "name": "agent-hub-start",
      "cmd": "agent-hub",
      "args": ["start"]
    }
  ]
}
```

No changes to `tauri.conf.json` or `lib.rs` -- shell plugin is already loaded.

### 5.3 GUI Auto-Bootstrap (EI-3)

New file `ensureHub.ts`:
- `isHubAlive()` -- fetch `http://localhost:9000/api/health`, return boolean
- `ensureHub()` -- check health; if down, set status to `"bootstrapping"`, spawn `agent-hub start` via Tauri shell `Command.create("agent-hub-start")`, poll health with 1s interval up to 30s timeout, return success/fail

Modified files:
- `types.ts`: Add `"bootstrapping"` to `ConnectionStatus` union
- `App.tsx`: Replace `useHubConnection()` hook call with explicit lifecycle: call `ensureHub()` first, then `hubConnection.connect()`
- `StatusBar.tsx`: Add `"bootstrapping"` case displaying "Starting Hub..."
- `global.css`: Add `.status-bar .status-dot.bootstrapping` style (yellow, pulsing)

Design: GUI depends on `agent-hub` being in PATH (venv active). The Hub's own startup (EI-1) cascades to MCP servers, so the GUI doesn't need to know about MCP. On spawn failure, falls back to existing reconnect-with-backoff behavior.

### 5.4 Terminal DA Escape Sequence Fix (EI-4)

Root cause: When the initial scrollback buffer is written to xterm.js via `term.write()`, the buffer may contain DA requests from tmux/bash. xterm.js processes them and generates a response (`ESC[>0;276;0c`), which fires through `terminal.onData()` and gets sent to the PTY as user input.

Fix: Add a `muteInput` Set to `HubConnection`. During buffer replay:
1. Add agent ID to `muteInput` before calling `term.write()`
2. Use the `term.write(data, callback)` callback to remove from `muteInput` after processing completes
3. In `sendInput()`, skip sending if agent is in `muteInput`

Three surgical edits to `useHubConnection.ts`.

### 5.5 README Updates (EI-5, EI-6)

- `agent-hub/README.md`: Fix stale `services` reference to `status`, update `agent-hub start` description to note MCP auto-start, add "GUI" section
- `agent-hub/gui/README.md`: Replace Hub prerequisite with "Agent Hub CLI installed and venv active", add "Auto-Bootstrap" section, add `ensureHub.ts` to architecture tree

---

## 6. Justification

- Users must currently start services manually in the correct order. This is error-prone and creates a poor first-run experience, especially for the GUI.
- The DA escape sequence bug causes visible garbage text in agent prompts on first tab view, requiring manual clearing.
- Stale README references (from CR-071's `services` -> `status` rename) cause confusion.
- Demand-driven bootstrap is the standard pattern for layered service stacks. Each layer should be self-sufficient in ensuring its dependencies.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/agent_hub/cli.py` | Modify | Add `ensure_mcp_servers()` call + import |
| `agent-hub/gui/src-tauri/capabilities/default.json` | Modify | Add shell:allow-spawn permission |
| `agent-hub/gui/src/ensureHub.ts` | Create | Auto-bootstrap logic |
| `agent-hub/gui/src/types.ts` | Modify | Add "bootstrapping" to ConnectionStatus |
| `agent-hub/gui/src/App.tsx` | Modify | ensureHub-then-connect lifecycle |
| `agent-hub/gui/src/components/StatusBar.tsx` | Modify | Bootstrapping label |
| `agent-hub/gui/src/styles/global.css` | Modify | Bootstrapping dot style |
| `agent-hub/gui/src/hooks/useHubConnection.ts` | Modify | muteInput guard |
| `agent-hub/README.md` | Modify | Fix stale refs, document auto-start |
| `agent-hub/gui/README.md` | Modify | Document auto-bootstrap |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No QMS documents affected |

### 7.3 Other Impacts

None. All changes are backward-compatible. The Hub `start` command still works identically when MCP servers are already running (idempotent check). The GUI falls back to reconnect-with-backoff if `agent-hub` is not in PATH.

---

## 8. Testing Summary

Manual UAT covering the following scenarios:

| # | Scenario | Expected |
|---|----------|----------|
| 1 | Clean state: kill all services, launch GUI | Status bar shows "Starting Hub...", MCP + Hub come up, transitions to "Connected" |
| 2 | Hub already running: launch GUI | Fast path, immediate "Connected" |
| 3 | First tab click after GUI launch | No `[>0;276;0c` or similar escape text in prompt |
| 4 | `agent-hub start` standalone (no prior MCP) | MCP servers auto-start before Hub |
| 5 | `agent-hub launch claude` (clean state) | Full stack starts, no double-start warnings |
| 6 | Venv deactivated, launch GUI | "Starting Hub..." then falls back to reconnect-with-backoff |

---

## 9. Implementation Plan

### Phase 1: Code Changes

Implement EI-1 through EI-4 as described in the Change Description.

### Phase 2: README Updates

Implement EI-5 and EI-6.

### Phase 3: UAT

Execute EI-7 scenarios against the modified codebase.

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Hub auto-starts MCP servers: Add `ensure_mcp_servers(config)` call in `cli.py` `start()` command | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Configure Tauri shell scope: Add scoped `shell:allow-spawn` permission to `default.json` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | GUI auto-bootstrap: Create `ensureHub.ts`, modify `types.ts`, `App.tsx`, `StatusBar.tsx`, `global.css` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Fix terminal DA escape sequence: Add `muteInput` guard to `useHubConnection.ts` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Update `agent-hub/README.md`: Fix stale refs, document auto-start and GUI | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Update `agent-hub/gui/README.md`: Document auto-bootstrap, update prerequisites | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | UAT: Execute all test scenarios from Section 8 | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution

---

**END OF DOCUMENT**
