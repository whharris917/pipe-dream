---
title: Implement QMS MCP Server
revision_summary: Initial draft
---

# CR-041: Implement QMS MCP Server

## 1. Purpose

Implement a Model Context Protocol (MCP) server that exposes QMS operations as native tools for Claude agents. This replaces the current pattern of invoking `python qms-cli/qms.py --user {USER} {COMMAND}` via bash with direct tool calls, providing a cleaner and more reliable interface for agent-QMS interaction.

---

## 2. Scope

### 2.1 Context

Currently, Claude agents interact with the QMS by constructing bash commands that invoke the qms-cli. This approach is functional but cumbersome—agents must format command strings, parse text output, and handle shell-level errors. MCP provides a native tool interface that aligns with how Claude agents naturally operate.

- **Parent Document:** None (independent improvement)

### 2.2 Changes Summary

Create an MCP server that:
- Exposes QMS CLI operations as MCP tools
- Returns structured responses rather than text output
- Integrates natively with Claude's tool-use capabilities

### 2.3 Files Affected

**New Files (MCP Server)**
- `qms-cli/mcp/` - New directory for MCP server code
- `qms-cli/mcp/server.py` - Main MCP server implementation
- `qms-cli/mcp/tools.py` - Tool definitions for QMS operations
- `qms-cli/mcp/__init__.py` - Package initialization

**Configuration Updates**
- `.claude/settings.local.json` - Add MCP server configuration

**SDLC Documents (Re-qualification)**
- `QMS/SDLC-QMS/SDLC-QMS-RS.md` - Add MCP server requirements
- `QMS/SDLC-QMS/SDLC-QMS-RTM.md` - Add traceability for new requirements

**Documentation Updates**
- `CLAUDE.md` - Update QMS identity section with MCP tool examples
- `.claude/agents/qa.md` - Update actions section with MCP syntax
- `.claude/agents/bu.md` - Update actions section with MCP syntax
- `.claude/agents/tu_ui.md` - Update actions section with MCP syntax
- `.claude/agents/tu_scene.md` - Update actions section with MCP syntax
- `.claude/agents/tu_sketch.md` - Update actions section with MCP syntax
- `.claude/agents/tu_sim.md` - Update actions section with MCP syntax

---

## 3. Current State

Claude agents interact with the QMS via bash commands:

```bash
python qms-cli/qms.py --user claude inbox
python qms-cli/qms.py --user claude checkout CR-041
python qms-cli/qms.py --user claude checkin CR-041
```

This requires agents to:
- Construct command strings with proper escaping
- Parse unstructured text output
- Handle shell-level errors separately from QMS-level errors

---

## 4. Proposed State

Claude agents interact with the QMS via native MCP tools:

```
qms_inbox(user="claude")
qms_checkout(user="claude", doc_id="CR-041")
qms_checkin(user="claude", doc_id="CR-041", content="...")
```

Tools return structured responses with clear success/failure indicators and typed data.

---

## 5. Change Description

### 5.1 MCP Server Core

Implement a Python-based MCP server using the `mcp` library:

```python
# qms-cli/mcp/server.py
from mcp.server import Server

server = Server("qms-server")

@server.tool()
async def qms_inbox(user: str) -> str:
    """Check user's QMS inbox for pending tasks."""
    # Delegate to qms-cli internals
```

### 5.2 Tool Set

Expose QMS operations as MCP tools:

**User Commands**

| Tool | Parameters | Description |
|------|------------|-------------|
| `qms_inbox` | user | List pending tasks |
| `qms_workspace` | user | List documents in user's workspace |
| `qms_status` | user, doc_id | Get document status |
| `qms_read` | user, doc_id, [version], [draft] | Read document content |
| `qms_history` | user, doc_id | View audit trail |
| `qms_comments` | user, doc_id, [version] | View review comments |

**Document Lifecycle**

| Tool | Parameters | Description |
|------|------------|-------------|
| `qms_create` | user, doc_type, title | Create new document |
| `qms_checkout` | user, doc_id | Check out document |
| `qms_checkin` | user, doc_id, content | Check in document |
| `qms_cancel` | user, doc_id | Cancel never-effective document (v < 1.0) |

**Workflow**

| Tool | Parameters | Description |
|------|------------|-------------|
| `qms_route` | user, doc_id, target, [retire] | Route for review/approval |
| `qms_assign` | user, doc_id, assignees | Add reviewers (QA only) |
| `qms_review` | user, doc_id, outcome, comment | Submit review |
| `qms_approve` | user, doc_id | Approve document |
| `qms_reject` | user, doc_id, comment | Reject document |

**Execution (Executable Documents)**

| Tool | Parameters | Description |
|------|------------|-------------|
| `qms_release` | user, doc_id | Release for execution |
| `qms_revert` | user, doc_id, reason | Revert to execution |
| `qms_close` | user, doc_id | Close document |

**Administrative**

| Tool | Parameters | Description |
|------|------------|-------------|
| `qms_fix` | user, doc_id | Administrative fix for EFFECTIVE docs (admin only) |

*Note: Setup commands (`init`, `namespace`, `user`, `migrate`) are not exposed as MCP tools.*

### 5.3 Integration with qms-cli

The MCP tools will delegate to existing qms-cli internals rather than re-implementing QMS logic. This ensures consistency between CLI and MCP interfaces.

---

## 6. Justification

- **Ergonomics:** Native tool calls are cleaner than bash command construction
- **Reliability:** Structured responses eliminate text parsing errors
- **Alignment:** MCP is the standard protocol for Claude tool integration
- **Maintainability:** Single source of truth for QMS operations (qms-cli internals)

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/mcp/__init__.py` | Create | Package initialization |
| `qms-cli/mcp/server.py` | Create | MCP server implementation |
| `qms-cli/mcp/tools.py` | Create | Tool definitions |
| `.claude/settings.local.json` | Modify | Add MCP server configuration |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| `SDLC-QMS-RS` | Modify | Add MCP server requirements section |
| `SDLC-QMS-RTM` | Modify | Add traceability for MCP requirements |
| `CLAUDE.md` | Modify | Update QMS identity section with MCP tool syntax |
| `.claude/agents/qa.md` | Modify | Update actions section with MCP syntax |
| `.claude/agents/bu.md` | Modify | Update actions section with MCP syntax |
| `.claude/agents/tu_ui.md` | Modify | Update actions section with MCP syntax |
| `.claude/agents/tu_scene.md` | Modify | Update actions section with MCP syntax |
| `.claude/agents/tu_sketch.md` | Modify | Update actions section with MCP syntax |
| `.claude/agents/tu_sim.md` | Modify | Update actions section with MCP syntax |

### 7.3 Other Impacts

- **qms-cli internals:** May require minor refactoring to expose functions for tool delegation
- **Dependencies:** Adds `mcp` Python package as dependency

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development shall follow these controls:

1. **Test environment isolation:** Development occurs in `.test-env/test-project/qms-cli/` (gitignored), not the production submodule
2. **Branch isolation:** All development occurs on branch `cr-041-mcp` (not main)
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new requirements must have passing qualification tests before merge
5. **CI verification:** Qualification tests must pass on GitHub Actions for the dev branch
6. **PR gate:** Changes merge to qms-cli main only via pull request after RS/RTM approval
7. **Submodule update:** pipe-dream updates its qms-cli submodule pointer only after PR merge

### 7.5 Qualified State Continuity

Development workflow ensures continuous qualification:

| Time | main branch | RS/RTM Status | Qualified Release |
|------|-------------|---------------|-------------------|
| Before CR | Current commit | EFFECTIVE v2.0 | CLI-2.0 |
| During execution | Unchanged | DRAFT (RS/RTM checked out) | CLI-2.0 (unchanged) |
| Post-approval | Merged from cr-041-mcp | EFFECTIVE v3.0 | CLI-3.0 |

Anyone cloning qms-cli from GitHub always gets the qualified `main` branch. The development branch (`cr-041-mcp`) is not qualified until merged.

---

## 8. Testing Summary

**Qualification Testing (required before merge):**
- Each MCP tool shall have qualification tests verifying equivalence to CLI
- Tests shall be documented in SDLC-QMS-RTM with traceability to requirements
- All qualification tests must pass before PR merge

**Test Categories:**
- **Functional equivalence:** Each MCP tool produces equivalent results to corresponding CLI command
- **Error handling:** Structured error responses for invalid operations
- **Permission enforcement:** MCP permission model matches CLI behavior
- **Workflow integration:** Round-trip test: create → checkout → edit → checkin → route → review → approve

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Create `.test-env/test-project/` directory in pipe-dream (gitignored)
2. Clone qms-cli from GitHub into `.test-env/test-project/qms-cli/`
3. Create and checkout branch `cr-041-mcp` in the cloned repo
4. Verify clean test environment

### 9.2 Phase 2: Requirements

1. Checkout SDLC-QMS-RS in production QMS
2. Add REQ-MCP-* requirements for MCP server functionality
3. Checkin RS, route for review and approval

### 9.3 Phase 3: Core Implementation

1. Create `qms-cli/mcp/` package structure
2. Implement MCP server skeleton
3. Implement user tools: `qms_inbox`, `qms_workspace`, `qms_status`
4. Implement read tools: `qms_read`, `qms_history`, `qms_comments`

### 9.4 Phase 4: Lifecycle & Workflow Tools

1. Implement lifecycle tools: `qms_create`, `qms_checkout`, `qms_checkin`, `qms_cancel`
2. Implement workflow tools: `qms_route`, `qms_assign`, `qms_review`
3. Implement approval tools: `qms_approve`, `qms_reject`
4. Implement execution tools: `qms_release`, `qms_revert`, `qms_close`
5. Implement admin tools: `qms_fix`

### 9.5 Phase 5: Qualification

1. Write qualification tests for each MCP tool (test_mcp.py)
2. Run full qualification test suite against development branch
3. Verify CI passes on GitHub Actions for cr-041-mcp branch
4. Document test results with commit hashes

### 9.6 Phase 6: RTM Update

1. Checkout SDLC-QMS-RTM in production QMS
2. Add verification evidence for REQ-MCP-* requirements
3. Reference CI-verified commit from qualification
4. Checkin RTM, route for review and approval

### 9.7 Phase 7: Merge & Submodule Update

1. Once RS and RTM are EFFECTIVE, create PR to merge `cr-041-mcp` to main
2. Merge PR (qms-cli transitions from CLI-2.0 to CLI-3.0)
3. Update qms-cli submodule pointer in pipe-dream
4. Verify qms-cli MCP server works in pipe-dream

### 9.8 Phase 8: Configuration & Documentation

1. Add MCP server configuration to `.claude/settings.local.json`
2. Update CLAUDE.md with MCP tool syntax in QMS Identity section
3. Update all agent definitions (`.claude/agents/*.md`) with MCP syntax
4. Verify agent authentication works via MCP tools

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Create test environment (.test-env/test-project/) and clone qms-cli | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Create and checkout branch cr-041-mcp | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Checkout and update SDLC-QMS-RS with REQ-MCP-* requirements | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Route RS for review and approval | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Create qms-cli/mcp/ package structure | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Implement MCP server skeleton | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Implement user tools: qms_inbox, qms_workspace, qms_status | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-8 | Implement read tools: qms_read, qms_history, qms_comments | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-9 | Implement lifecycle tools: qms_create, qms_checkout, qms_checkin, qms_cancel | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-10 | Implement workflow tools: qms_route, qms_assign, qms_review | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-11 | Implement approval tools: qms_approve, qms_reject | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-12 | Implement execution tools: qms_release, qms_revert, qms_close | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-13 | Implement admin tools: qms_fix | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-14 | Write qualification tests (test_mcp.py) for all MCP tools | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-15 | Run full qualification test suite, verify CI passes | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-16 | Checkout and update SDLC-QMS-RTM with verification evidence | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-17 | Route RTM for review and approval | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-18 | Create PR and merge cr-041-mcp to main (CLI-2.0 → CLI-3.0) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-19 | Update qms-cli submodule pointer in pipe-dream | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-20 | Configure MCP server in .claude/settings.local.json | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-21 | Update CLAUDE.md with MCP tool syntax | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-22 | Update agent definitions (.claude/agents/*.md) with MCP syntax | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-23 | Verify MCP tools work with agent authentication in pipe-dream | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.

EXECUTION SUMMARY GUIDANCE (per CR-036 best practices):
- Include commit hashes for code changes (e.g., "Commit: abc1234")
- Reference CI verification where applicable
- Document specific files modified
- Note any deviations from plan that may require VARs
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-005:** Code Governance
- **SOP-006:** SDLC Governance
- **SDLC-QMS-RS:** QMS CLI Requirements Specification
- **SDLC-QMS-RTM:** QMS CLI Requirements Traceability Matrix
- **CR-036:** Add qms-cli initialization and bootstrapping functionality (requalification precedent)
- **MCP Specification:** https://modelcontextprotocol.io/

---

**END OF DOCUMENT**
