---
title: Fix hardcoded QMS_ROOT in qms_meta.py and qms_audit.py
revision_summary: Initial draft
---

# CR-031: Fix hardcoded QMS_ROOT in qms_meta.py and qms_audit.py

## 1. Purpose

Fix a bug where `qms_meta.py` and `qms_audit.py` use hardcoded path resolution for `QMS_ROOT` instead of importing from `qms_paths.py`. This causes .meta and .audit files to be written to the wrong location when the CLI is invoked from a different working directory (e.g., during pytest execution with temporary directories).

---

## 2. Scope

### 2.1 Context

Bug discovered during qms-cli qualification testing. Tests using `temp_project` fixtures failed because metadata was written to the real QMS directory instead of the temporary test directory.

- **Parent Document:** None (defect discovered during qualification)

### 2.2 Changes Summary

Replace hardcoded `QMS_ROOT` path computation in `qms_meta.py` and `qms_audit.py` with imports from `qms_paths.py`, which uses `find_project_root()` for dynamic discovery.

### 2.3 Files Affected

- `qms-cli/qms_meta.py` - Remove hardcoded QMS_ROOT, import from qms_paths
- `qms-cli/qms_audit.py` - Remove hardcoded QMS_ROOT, import from qms_paths

---

## 3. Current State

`qms_meta.py` and `qms_audit.py` each define their own `QMS_ROOT` using:
```python
QMS_ROOT = Path(__file__).parent.parent / "QMS"
```

This computes the path relative to the source file location, ignoring the current working directory. When pytest patches paths for isolated testing, these modules continue writing to the real QMS directory.

---

## 4. Proposed State

`qms_meta.py` and `qms_audit.py` import `QMS_ROOT` from `qms_paths`:
```python
from qms_paths import QMS_ROOT
```

This centralizes path resolution and ensures all modules use the same dynamically-discovered project root.

---

## 5. Change Description

### 5.1 qms_meta.py

Remove lines 14-16:
```python
# Base paths
QMS_ROOT = Path(__file__).parent.parent / "QMS"
META_ROOT = QMS_ROOT / ".meta"
```

Replace with:
```python
from qms_paths import QMS_ROOT

META_ROOT = QMS_ROOT / ".meta"
```

### 5.2 qms_audit.py

Remove lines 14-16:
```python
# Base paths
QMS_ROOT = Path(__file__).parent.parent / "QMS"
AUDIT_ROOT = QMS_ROOT / ".audit"
```

Replace with:
```python
from qms_paths import QMS_ROOT

AUDIT_ROOT = QMS_ROOT / ".audit"
```

---

## 6. Justification

- **Problem:** Qualification tests cannot run in isolation because metadata/audit writes bypass the temp directory
- **Impact of not fixing:** Cannot verify qms-cli requirements via automated testing; manual testing required
- **Root cause:** Inconsistent path resolution strategy across modules

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_meta.py` | Modify | Replace hardcoded QMS_ROOT with import |
| `qms-cli/qms_audit.py` | Modify | Replace hardcoded QMS_ROOT with import |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | N/A | No document changes required |

### 7.3 Other Impacts

None. This is a bug fix that aligns behavior with the existing design pattern used by other modules.

---

## 8. Testing Summary

- Run existing qualification test `test_sop_lifecycle.py` which previously failed due to this bug
- Verify that .meta files are created in the temp directory, not the real QMS
- Verify that .audit files are created in the temp directory, not the real QMS

---

## 9. Implementation Plan

### 9.1 Code Changes

1. Edit `qms-cli/qms_meta.py` to import QMS_ROOT from qms_paths
2. Edit `qms-cli/qms_audit.py` to import QMS_ROOT from qms_paths

### 9.2 Verification

1. Run qualification tests to confirm fix
2. Verify no real QMS files were modified during testing

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Edit qms_meta.py to import QMS_ROOT from qms_paths | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Edit qms_audit.py to import QMS_ROOT from qms_paths | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Run qualification tests to verify fix | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control

---

**END OF DOCUMENT**
