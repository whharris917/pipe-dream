---
title: Extract Prompts to External YAML Files
revision_summary: 'CR-027: Extract prompts to external YAML files'
---

# CR-027: Extract Prompts to External YAML Files

## 1. Purpose

Extract hard-coded prompt configurations from `prompts.py` into external YAML files in `qms-cli/prompts/`, making them easier to maintain, review, and trace to requirements in future SDLC documentation.

---

## 2. Scope

### 2.1 Context

Independent improvement identified during architectural review (Session-2026-01-11-002). Prompts contain review checklists that must align with SOP requirements. Extracting them to files enables future traceability via SDLC-QMS-RS/RTM.

- **Parent Document:** None

### 2.2 Changes Summary

- Create `qms-cli/prompts/` directory with YAML prompt files
- Modify `prompts.py` to load prompts from files with fallback chain
- Fix bug where `doc_type` is not passed to prompt generation functions

### 2.3 Files Affected

- `qms-cli/prompts/` - New directory with YAML prompt files
- `qms-cli/prompts.py` - Add file loading, maintain PromptRegistry interface
- `qms-cli/commands/route.py` - Pass doc_type to template functions
- `qms-cli/commands/assign.py` - Pass doc_type to template functions

---

## 3. Current State

Prompt configurations (checklist items, critical reminders) are hard-coded in `prompts.py`. The PromptRegistry selects configurations based on task_type, workflow_type, and doc_type using an in-memory dictionary. A bug prevents doc_type from being passed to prompt generation, so doc-type-specific prompts (CR execution checks, SOP procedure checks) do not work correctly.

---

## 4. Proposed State

Prompt configurations are stored as YAML files in `qms-cli/prompts/`. The directory structure mirrors the lookup chain: `{task_type}/{workflow_type}/{doc_type}.yaml`. The PromptRegistry loads configurations from files with a fallback chain. The doc_type bug is fixed, enabling doc-type-specific prompts.

---

## 5. Change Description

### 5.1 Directory Structure

```
qms-cli/prompts/
├── review/                          # task_type = REVIEW
│   ├── default.yaml                 # Fallback for any review workflow
│   ├── review/                      # workflow_type = REVIEW (non-executable)
│   │   ├── default.yaml
│   │   └── sop.yaml                 # doc_type = SOP
│   ├── pre_review/                  # workflow_type = PRE_REVIEW
│   │   └── default.yaml
│   └── post_review/                 # workflow_type = POST_REVIEW
│       ├── default.yaml
│       └── cr.yaml                  # doc_type = CR
│
└── approval/                        # task_type = APPROVAL
    ├── default.yaml                 # Fallback for any approval workflow
    ├── approval/                    # workflow_type = APPROVAL (non-executable)
    │   └── default.yaml
    ├── pre_approval/                # workflow_type = PRE_APPROVAL
    │   └── default.yaml
    └── post_approval/               # workflow_type = POST_APPROVAL
        └── default.yaml
```

### 5.2 YAML File Format

```yaml
checklist:
  - category: Frontmatter
    items:
      - text: "`title:` field present and non-empty"
        evidence_prompt: "quote actual value"

critical_reminders:
  - "**Compliance is BINARY**: Document is either compliant or non-compliant"

custom_header: null
custom_footer: null
```

### 5.3 Lookup Logic

Fallback chain (mirrors current PromptRegistry.get_config):
1. `{task_type}/{workflow_type}/{doc_type}.yaml` (exact match)
2. `{task_type}/{workflow_type}/default.yaml` (any doc_type)
3. `{task_type}/default.yaml` (any workflow_type)

### 5.4 Bug Fix

In `route.py` and `assign.py`, add `doc_type=doc_type` parameter to calls to `generate_review_task_content()` and `generate_approval_task_content()`.

---

## 6. Justification

- **Problem:** Prompts are hard-coded, making them difficult to maintain and trace to SOPs
- **Impact of not making this change:** Prompts may drift out of alignment with SOP requirements; no traceability for future SDLC documentation
- **Solution:** External files enable easier review, maintenance, and future traceability via RTM

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/prompts/` | Create | New directory with YAML prompt files |
| `qms-cli/prompts.py` | Modify | Add file loading with fallback chain |
| `qms-cli/commands/route.py` | Modify | Pass doc_type to template functions |
| `qms-cli/commands/assign.py` | Modify | Pass doc_type to template functions |
| `qms-cli/tests/test_prompts.py` | Modify | Add tests for file loading |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No QMS documents affected |

### 7.3 Other Impacts

None. This is an internal refactoring with no change to external CLI behavior.

---

## 8. Testing Summary

- Existing prompt tests continue to pass
- New tests verify YAML loading and fallback chain
- Manual verification: Route CR for post-review, verify CR-specific execution checks appear
- Manual verification: Route SOP for review, verify SOP-specific procedure checks appear
- Manual verification: Route INV for review, verify default checks appear (fallback)

---

## 9. Implementation Plan

### 9.1 Create Directory Structure and YAML Files

1. Create `qms-cli/prompts/` directory tree
2. Extract DEFAULT_FRONTMATTER_CHECKS to default review YAML
3. Extract DEFAULT_STRUCTURE_CHECKS to default review YAML
4. Extract DEFAULT_CONTENT_CHECKS to default review YAML
5. Extract CR_EXECUTION_CHECKS to `review/post_review/cr.yaml`
6. Extract SOP_CHECKS to `review/review/sop.yaml`
7. Extract DEFAULT_CRITICAL_REMINDERS to review defaults
8. Extract APPROVAL_CRITICAL_REMINDERS to approval defaults

### 9.2 Add File Loading to prompts.py

1. Add `load_prompt_config()` function with file path construction
2. Implement fallback chain using file existence checks
3. Parse YAML into PromptConfig dataclass
4. Add caching to avoid repeated file reads
5. Update PromptRegistry.get_config() to use file loading

### 9.3 Fix doc_type Passthrough Bug

1. In `route.py`: Add `doc_type=doc_type` to generate_*_task_content() calls
2. In `assign.py`: Add `doc_type=doc_type` to generate_*_task_content() calls

### 9.4 Update Tests

1. Add test for YAML file loading
2. Add test for fallback chain with files
3. Verify existing tests pass

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Create directory structure and YAML files | Created `qms-cli/prompts/` with 10 YAML files: review/default.yaml, review/review/default.yaml, review/review/sop.yaml, review/pre_review/default.yaml, review/post_review/default.yaml, review/post_review/cr.yaml, approval/default.yaml, approval/approval/default.yaml, approval/pre_approval/default.yaml, approval/post_approval/default.yaml | Pass | claude - 2026-01-11 |
| EI-2 | Add file loading to prompts.py | Added `load_config_from_yaml()` and `get_prompt_file_path()` functions. Updated `PromptRegistry.get_config()` to try file loading first with fallback chain, then in-memory registry as fallback. | Pass | claude - 2026-01-11 |
| EI-3 | Fix doc_type passthrough bug | Added `doc_type=doc_type` parameter to `generate_review_task_content()` and `generate_approval_task_content()` calls in route.py:157-176 and assign.py:137-156. | Pass | claude - 2026-01-11 |
| EI-4 | Update tests | Added 17 new tests in test_prompts.py: TestYamlFileLoading (9 tests), TestYamlFallbackChain (4 tests), TestYamlIntegration (4 tests). Updated 2 existing tests for new file-first behavior. | Pass | claude - 2026-01-11 |
| EI-5 | Run verification tests | All 195 tests pass. New tests verify YAML loading, fallback chain, and integration with PromptRegistry. | Pass | claude - 2026-01-11 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| All execution items completed successfully. File-based prompt loading now takes priority over in-memory registration, which serves as a fallback. | claude - 2026-01-11 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 5 execution items completed successfully with no deviations from the plan.

**Key accomplishments:**
- Created 10 YAML prompt files with hierarchical structure matching the lookup chain
- Implemented file loading with fallback: exact match → workflow default → task type default
- Fixed doc_type passthrough bug in route.py and assign.py
- Added 17 new tests for YAML loading functionality
- All 195 tests pass

**Files created:**
- `qms-cli/prompts/review/default.yaml` and 5 subdirectory files
- `qms-cli/prompts/approval/default.yaml` and 3 subdirectory files

**Files modified:**
- `qms-cli/prompts.py` - Added YAML loading (lines 52-176)
- `qms-cli/commands/route.py` - Added doc_type parameter (lines 157-176)
- `qms-cli/commands/assign.py` - Added doc_type parameter (lines 137-156)
- `qms-cli/tests/test_prompts.py` - Added 17 new tests

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **Session-2026-01-11-002:** Architectural discussion on prompt extraction

---

**END OF DOCUMENT**
