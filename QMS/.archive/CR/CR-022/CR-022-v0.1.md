---
title: Revert CR-018 metadata injection
revision_summary: Initial draft
---

<!--
================================================================================
QMS DOCUMENT STATUS
================================================================================
Document ID:     CR-022
Version:         0.1
Status:          IN_PRE_APPROVAL
================================================================================
-->

# CR-022: Revert CR-018 metadata injection

## 1. Purpose

Revert the metadata injection feature implemented by CR-018 due to an architectural flaw: the system conflates "source" documents with "viewable renditions," requiring brittle back-calculation of source content through content stripping operations.

---

## 2. Scope

### 2.1 Context

CR-018 introduced metadata injection (version/status headers) and auto-generated revision history into QMS documents. While functional, the approach relies on stripping injected content during checkout to recover the "source" document. This is architecturally unsound because the QMS does not actually store source documents separatelyâ€”it only stores renditions and must back-calculate sources.

- **Parent Document:** CR-018

### 2.2 Changes Summary

1. Remove all helper functions added by CR-018 from qms.py
2. Remove metadata injection calls from state-changing commands
3. Revert cmd_checkout and cmd_checkin to pre-CR-018 behavior
4. Remove approval_date tracking from qms_meta.py
5. Clean up SOP-001 by removing now-static injected content

### 2.3 Files Affected

- `.claude/qms.py` - Remove helper functions and injection logic
- `.claude/qms_meta.py` - Remove approval_date tracking
- `QMS/SOP/SOP-001.md` - Remove static metadata header and revision history

---

## 3. Current State

1. qms.py contains ~200 lines of metadata injection helper functions
2. cmd_checkout strips injected content and writes placeholder to QMS draft
3. cmd_checkin strips workspace content and injects metadata header + revision history
4. State-changing commands (route, review, approve, release, close) call inject_qms_metadata_into_file()
5. qms_meta.py tracks approval_date for approved states
6. SOP-001 contains a static QMS DOCUMENT STATUS comment block and Revision History table

---

## 4. Proposed State

1. qms.py contains no metadata injection logic
2. cmd_checkout copies QMS draft to workspace without transformation
3. cmd_checkin copies workspace to QMS draft without transformation
4. State-changing commands do not inject metadata
5. qms_meta.py does not track approval_date
6. SOP-001 contains no injected metadata blocks

---

## 5. Change Description

### 5.1 Code Removal from qms.py

Remove the following functions and constants:
- `QMS_METADATA_MARKER` constant
- `QMS_CHECKOUT_MARKER` constant
- `build_qms_metadata_header()`
- `build_checkout_placeholder()`
- `strip_qms_metadata_header()`
- `strip_revision_history()`
- `strip_injected_content()`
- `write_checkout_placeholder()`
- `get_archived_revision_summary()`
- `build_revision_history_table()`
- `inject_qms_metadata_into_file()`

### 5.2 Revert cmd_checkout

Remove:
- Call to strip_injected_content() before copying to workspace
- Call to write_checkout_placeholder()

Restore: Simple copy of QMS draft to workspace

### 5.3 Revert cmd_checkin

Remove:
- Call to strip_injected_content() on workspace content
- Call to inject_qms_metadata_into_file()

Restore: Simple copy of workspace to QMS draft

### 5.4 Revert State-Changing Commands

Remove inject_qms_metadata_into_file() calls from:
- cmd_route
- cmd_review
- cmd_approve
- cmd_release
- cmd_close

### 5.5 Revert qms_meta.py

Remove approval_date logic from update_meta_approval()

### 5.6 Clean Up SOP-001

After code reversion, checkout SOP-001 and remove:
- The QMS DOCUMENT STATUS comment block (lines 6-15 approximately)
- The Revision History section at the end of the document

---

## 6. Justification

- **Architectural Flaw:** CR-018 created a false distinction between "source" and "rendition" without actually storing sources separately. The system must back-calculate sources by stripping content, which is brittle and error-prone.
- **Bug History:** CR-018's strip_revision_history() already caused a bug where example code blocks were incorrectly stripped, demonstrating the brittleness of the approach.
- **Simplicity:** The QMS should store documents as-is. If metadata visibility is needed, it should come from querying the .meta sidecar files, not from injecting content into documents.
- **Future Architecture:** If source/rendition separation is truly needed, it should be implemented properly with separate storage locations, not through content transformation.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `.claude/qms.py` | Modify | Remove ~200 lines of injection code |
| `.claude/qms_meta.py` | Modify | Remove approval_date tracking |
| `QMS/SOP/SOP-001.md` | Modify | Remove metadata header and revision history |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SOP-001 | Modify | Remove injected content through normal workflow |

### 7.3 Other Impacts

- Documents that received metadata injection from CR-018 will retain static headers until manually cleaned
- SOP-001 is the only document explicitly cleaned by this CR; others can be cleaned opportunistically

---

## 8. Testing Summary

- Verify `qms checkout` copies content without transformation
- Verify `qms checkin` copies content without transformation
- Verify state-changing commands do not inject metadata
- Verify SOP-001 is clean after workflow completion

---

## 9. Implementation Plan

### 9.1 Phase 1: Revert Code Changes

1. Remove helper functions and constants from qms.py
2. Revert cmd_checkout to simple copy behavior
3. Revert cmd_checkin to simple copy behavior
4. Remove injection calls from state-changing commands
5. Remove approval_date logic from qms_meta.py

### 9.2 Phase 2: Verify Behavior

1. Test checkout/checkin cycle without transformation
2. Verify no metadata injection occurs

### 9.3 Phase 3: Clean Up SOP-001

1. Checkout SOP-001
2. Remove QMS DOCUMENT STATUS comment block
3. Remove Revision History section
4. Checkin SOP-001
5. Complete SOP-001 workflow to EFFECTIVE

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Remove helper functions, constants, and injection logic from qms.py; revert cmd_checkout/checkin; remove injection calls from state-changing commands | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Remove approval_date logic from qms_meta.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Verify checkout/checkin work without transformation | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Checkout SOP-001, remove metadata header and revision history, checkin | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Complete SOP-001 workflow to EFFECTIVE | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-018:** QMS Document Rendition and Checkout Visibility (being reverted)

---

**END OF DOCUMENT**

---

## Revision History

| Version | Date | Author | Summary |
|---------|------|--------|---------|
| 0.1 | 2026-01-09 | claude | Initial draft |

*This revision history is automatically generated from the QMS audit trail.*
