---
title: QMS CLI Qualification Test Coverage Gaps
revision_summary: Initial draft
---

# CR-035: QMS CLI Qualification Test Coverage Gaps

## 1. Purpose

Address qualification test coverage gaps identified during pre-approval verification of SDLC-QMS-RTM. This CR adds and enhances qualification tests to ensure each requirement in SDLC-QMS-RS is fully verified by its mapped test(s), not just partially covered.

---

## 2. Scope

### 2.1 Context

During preparation for RTM approval under CR-028 (QMS CLI Qualification), a rigorous verification audit identified 13 requirements with insufficient test coverage. Tests exist but do not fully exercise all criteria specified in the requirements.

- **Parent Document:** CR-028 (QMS CLI Qualification: RS and RTM)

### 2.2 Changes Summary

Add approximately 15-20 new test functions and enhance existing tests to achieve full coverage of all requirement criteria. No changes to qms-cli source code; test files only.

### 2.3 Files Affected

- `qms-cli/tests/qualification/test_sop_lifecycle.py` - Add invalid transition and audit tests
- `qms-cli/tests/qualification/test_cr_lifecycle.py` - Add terminal state and reversion tests
- `qms-cli/tests/qualification/test_security.py` - Add missing authorization tests
- `qms-cli/tests/qualification/test_document_types.py` - Add cancel and checkout tests
- `qms-cli/tests/qualification/test_prompts.py` - Enhance prompt verification tests
- `qms-cli/tests/qualification/test_templates.py` - Fix template location test

---

## 3. Current State

The qualification test suite contains 84 tests covering 69 requirements. All tests pass. However, 13 requirements have incomplete coverage:

**Critical Gaps (L1-L2):**
- REQ-WF-001: Tests 1 of 20+ invalid transitions
- REQ-AUDIT-001: Tests growth, not immutability
- REQ-WF-011: Tests CLOSED only, not RETIRED
- REQ-DOC-007: Missing EFFECTIVE checkout archive behavior
- REQ-DOC-010: Missing checkout restriction and cleanup verification
- REQ-TEMPLATE-002: Test body is `pass` - no verification

**High Gaps (L3):**
- REQ-SEC-002: Tests 3 of 7 actions
- REQ-SEC-003: Tests 2 of 5 owner-only commands
- REQ-PROMPT-003: Doesn't test hierarchical fallback
- REQ-PROMPT-004: Uses weak assertion (keyword presence)
- REQ-PROMPT-006: Tests YAML parsing, not rendering
- REQ-META-003: No systematic check of all 8 required fields
- REQ-DOC-009: Tests REVIEWED only, not PRE/POST_REVIEWED

---

## 4. Proposed State

The qualification test suite contains 100+ tests covering 69 requirements. All requirements have L4+ coverage (substantial or complete). Each multi-part requirement has explicit assertions for all specified criteria.

---

## 5. Change Description

### 5.1 Critical Gap Remediation (L1-L2)

**REQ-WF-001 - Status Transition Validation:**
Add `test_invalid_transitions_comprehensive` testing multiple invalid paths:
- DRAFT → IN_APPROVAL (skipping review)
- IN_REVIEW → EFFECTIVE (skipping approval)
- EFFECTIVE → IN_REVIEW (backwards)
- IN_EXECUTION → PRE_APPROVED (backwards)

**REQ-AUDIT-001 - Append-Only Logging:**
Add `test_audit_immutability` verifying:
- Audit file exists after operations
- Line count only increases
- Previous entries unchanged after new operations

**REQ-WF-011 - Terminal State Enforcement:**
Add `test_terminal_state_retired` verifying RETIRED state rejects all operations (existing test covers CLOSED).

**REQ-DOC-007 - Checkout Behavior:**
Add `test_checkout_effective_creates_archive` verifying:
- Checkout of EFFECTIVE document archives current version
- Creates new draft at N.1 version

**REQ-DOC-010 - Cancel Restrictions:**
Add `test_cancel_blocked_while_checked_out` and `test_cancel_cleans_workspace_and_inbox` verifying:
- Cancel rejected while document checked out
- Cancel removes workspace copies and inbox tasks

**REQ-TEMPLATE-002 - Template Location:**
Replace `pass` with actual verification that templates exist in QMS/TEMPLATE/.

### 5.2 High Gap Remediation (L3)

**REQ-SEC-002 - Group-Based Authorization:**
Add tests for missing actions: route, release, revert, close rejection for unauthorized groups.

**REQ-SEC-003 - Owner-Only Restrictions:**
Add tests for release, revert, close rejection for non-owners (executables).

**REQ-PROMPT-003 - Hierarchical Lookup:**
Add `test_hierarchical_lookup_fallback` testing 3-level priority chain.

**REQ-PROMPT-004 - Checklist Generation:**
Enhance to verify checklist has structured items with categories.

**REQ-PROMPT-006 - Custom Sections:**
Add `test_custom_sections_render` verifying custom content appears in output.

**REQ-META-003 - Required Metadata Fields:**
Add `test_metadata_required_fields` asserting all 8 fields present.

**REQ-DOC-009 - Checkin Reverts Reviewed:**
Add tests for PRE_REVIEWED and POST_REVIEWED reversion.

---

## 6. Justification

- Qualification quality depends entirely on test rigor
- Partial coverage creates false confidence in verification
- Once RTM is approved, gaps become technical debt
- Full remediation before approval ensures defensible qualification

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/tests/qualification/test_sop_lifecycle.py` | Modify | Add 4 tests |
| `qms-cli/tests/qualification/test_cr_lifecycle.py` | Modify | Add 3 tests |
| `qms-cli/tests/qualification/test_security.py` | Modify | Add 7 tests |
| `qms-cli/tests/qualification/test_document_types.py` | Modify | Add 4 tests |
| `qms-cli/tests/qualification/test_prompts.py` | Modify | Enhance 3 tests |
| `qms-cli/tests/qualification/test_templates.py` | Modify | Fix 1 test |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RTM | Modify | Update test mappings (under CR-028, not this CR) |

### 7.3 Other Impacts

None. Test-only changes do not affect CLI behavior or user workflows.

---

## 8. Testing Summary

- Run full qualification test suite after each file modification
- Verify new tests pass
- Verify existing tests still pass
- Final verification: `pytest tests/qualification/ -v` shows 100+ passing tests

---

## 9. Implementation Plan

### 9.1 Lifecycle Tests (test_sop_lifecycle.py, test_cr_lifecycle.py)

1. Add `test_invalid_transitions_comprehensive` with 4+ transition scenarios
2. Add `test_audit_immutability` verifying append-only behavior
3. Add `test_checkin_reverts_pre_reviewed` for CR documents
4. Add `test_checkin_reverts_post_reviewed` for CR documents
5. Add `test_terminal_state_retired` for RETIRED enforcement

### 9.2 Security Tests (test_security.py)

1. Add `test_unauthorized_route` for non-initiator rejection
2. Add `test_unauthorized_release` for non-initiator rejection
3. Add `test_unauthorized_revert` for non-initiator rejection
4. Add `test_unauthorized_close` for non-initiator rejection
5. Add/verify `test_owner_only_release` for non-owner rejection
6. Add/verify `test_owner_only_revert` for non-owner rejection
7. Add/verify `test_owner_only_close` for non-owner rejection

### 9.3 Document Type Tests (test_document_types.py)

1. Add `test_cancel_blocked_while_checked_out`
2. Add `test_cancel_cleans_workspace_and_inbox`
3. Add `test_checkout_effective_creates_archive`

### 9.4 Prompt Tests (test_prompts.py)

1. Add `test_hierarchical_lookup_fallback`
2. Enhance `test_review_prompt_has_checklist` with structured assertions
3. Add `test_custom_sections_render`

### 9.5 Template Tests (test_templates.py)

1. Replace `pass` in `test_templates_in_qms_template_directory` with actual verification

### 9.6 Metadata Tests

1. Add `test_metadata_required_fields` verifying all 8 fields

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Implement lifecycle test additions (Section 9.1) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Implement security test additions (Section 9.2) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Implement document type test additions (Section 9.3) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Implement prompt test additions (Section 9.4) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Implement template test fix (Section 9.5) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Implement metadata test addition (Section 9.6) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Run full test suite and verify all pass | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

---

## 11. Execution Summary

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-006:** SDLC Governance
- **CR-028:** QMS CLI Qualification: RS and RTM
- **SDLC-QMS-RS:** QMS CLI Requirements Specification (EFFECTIVE v1.0)

---

**END OF DOCUMENT**
