---
title: Identity collision prevention (Phase 2)
revision_summary: Initial draft
---

# CR-074: Identity collision prevention (Phase 2)

## 1. Purpose

Prevent identity collisions between concurrent QMS callers. Phase 1 (CR-073) established transport-based identity resolution -- HTTP headers for containers (enforced mode), user parameter for stdio (trusted mode). Phase 2 adds runtime collision detection so that when a container holds an identity in enforced mode, no other caller can operate under that same identity. This provides defense in depth beyond the agent-hub's container-naming uniqueness checks.

---

## 2. Scope

### 2.1 Context

This CR is Phase 2 of the 5-phase identity management plan designed in Session 2026-02-09-006. Phase 1 (CR-073) is complete and CLOSED.

- **Parent Document:** None (independent improvement, Phase 2 of identity management plan)

### 2.2 Changes Summary

Add an in-memory identity registry to the QMS MCP server that tracks active enforced-mode identities. Inject a unique instance identifier per proxy lifecycle to distinguish container instances. Reject duplicate identity claims with terminal error messages.

### 2.3 Files Affected

- `qms-cli/qms_mcp/server.py` -- Add IdentityCollisionError, IdentityLock, identity registry, collision detection in resolve_identity()
- `agent-hub/docker/scripts/mcp_proxy.py` -- Generate UUID at startup, inject X-QMS-Instance header
- `qms-cli/tests/qualification/test_mcp.py` -- Add qualification tests for REQ-MCP-016
- `QMS/SDLC-QMS/SDLC-QMS-RS.md` -- Add REQ-MCP-016 requirement
- `QMS/SDLC-QMS/SDLC-QMS-RTM.md` -- Add traceability entries for REQ-MCP-016

---

## 3. Current State

The QMS MCP server resolves identity per-request via `resolve_identity()` (REQ-MCP-015). HTTP transport uses the X-QMS-Identity header (enforced mode). Stdio transport uses the user parameter (trusted mode). There is no mechanism to prevent two callers from operating under the same identity simultaneously. A container running as `qa` and a host-spawned sub-agent both claiming `qa` can both execute QMS operations concurrently, potentially causing inbox race conditions and document conflicts.

The agent-hub prevents duplicate containers at the Docker level via container naming uniqueness and Hub state checks, but the MCP server has no independent enforcement.

---

## 4. Proposed State

The MCP server maintains an in-memory identity registry tracking active enforced-mode identities. Each HTTP caller is associated with a unique instance identifier (UUID) injected by the proxy at startup. The server rejects: (1) stdio requests claiming an identity that is active in enforced mode, and (2) HTTP requests from a different container instance claiming an already-registered identity. Identity locks expire via TTL for crash recovery.

---

## 5. Change Description

### 5.1 Identity Registry (server.py)

An in-memory dictionary mapping identity strings to `IdentityLock` objects:

```python
@dataclass
class IdentityLock:
    instance_id: str      # UUID from X-QMS-Instance header
    last_seen: float      # time.monotonic() timestamp
    identity: str         # The claimed identity

IDENTITY_LOCK_TTL_SECONDS: float = 300.0  # 5 minutes
_identity_registry: dict[str, IdentityLock] = {}
```

Three internal functions manage the registry:

- `_register_identity(identity, instance_id)` -- Called on HTTP resolution. Same instance_id refreshes the heartbeat. Different instance_id with non-expired lock raises IdentityCollisionError.
- `_check_identity_available(identity)` -- Called on stdio resolution. Returns the active lock if non-expired, None if available.
- `_cleanup_expired_locks()` -- Called lazily at the start of every resolve_identity() call. Removes entries where monotonic time exceeds TTL.

### 5.2 Modified resolve_identity()

The existing function gains two additions:

1. **After HTTP identity resolution:** Read X-QMS-Instance header and call `_register_identity()`. This detects duplicate containers (Scenario B).
2. **Before stdio fallback return:** Call `_check_identity_available()`. If an active lock exists, raise `IdentityCollisionError` with a terminal error message (Scenario A).

The `IdentityCollisionError` exception propagates through FastMCP as a tool error response. Zero changes to tools.py are needed -- all 20 tools get collision protection automatically.

### 5.3 Instance UUID (mcp_proxy.py)

The proxy generates a UUID4 at startup and injects it as the `X-QMS-Instance` header on every HTTP request, alongside the existing `X-QMS-Identity` header. This UUID is unique per proxy lifecycle (per container start/restart).

### 5.4 TTL and Crash Recovery

Identity locks use `time.monotonic()` timestamps (immune to clock adjustments) and a 5-minute TTL. This is long enough to span idle gaps between MCP calls but short enough for crash recovery. No explicit de-registration mechanism exists -- container stop/crash results in lock expiry via TTL.

### 5.5 Error Message Design

Error messages include:
- "IDENTITY LOCKED:" prefix for easy identification
- Truncated instance ID (first 8 characters)
- Explicit instruction: "Do not attempt to troubleshoot" to prevent rejected agents from entering retry/debug spirals

---

## 6. Justification

- **The problem:** Two callers claiming the same identity can cause inbox race conditions (both see the same task, one fails after the other completes it) and document conflicts.
- **Impact of not making this change:** Duplicate identity operations are possible whenever container infrastructure and host sub-agents overlap, a scenario that occurs naturally when the orchestrator forgets a container is running and spawns a sub-agent for the same role.
- **Defense in depth:** Agent-hub prevents duplicate containers at the Docker level, but that protection does not extend to container-vs-host collisions or to scenarios where containers are launched outside the hub. The MCP server is the authoritative enforcement point.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_mcp/server.py` | Modify | Add IdentityCollisionError, IdentityLock, registry, collision logic in resolve_identity() |
| `agent-hub/docker/scripts/mcp_proxy.py` | Modify | Generate UUID, inject X-QMS-Instance header |
| `qms-cli/tests/qualification/test_mcp.py` | Modify | Add ~15 tests for REQ-MCP-016 |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Modify | Add REQ-MCP-016 |
| SDLC-QMS-RTM | Modify | Add traceability entries, update qualified baseline |

### 7.3 Other Impacts

Docker image rebuild required after mcp_proxy.py changes (`docker-compose build --no-cache`).

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development follows established controls:

1. **Test environment isolation:** Development in a non-QMS-controlled directory (e.g., `.test-env/`)
2. **Branch isolation:** All development on branch `cr-074-identity-collision`
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new/modified requirements must have passing tests before merge
5. **CI verification:** Tests must pass on GitHub Actions for dev branch
6. **PR gate:** Changes merge to main only via PR after RS/RTM approval
7. **Submodule update:** Parent repo updates pointer only after PR merge

### 7.5 Qualified State Continuity

| Phase | main branch | RS/RTM Status | Qualified Release |
|-------|-------------|---------------|-------------------|
| Before CR | Current commit (d2ad514) | EFFECTIVE v9.0 / v11.0 | 378 tests passing |
| During execution | Unchanged | DRAFT (checked out) | Unchanged |
| Post-approval | Merged from cr-074-identity-collision | EFFECTIVE v10.0 / v12.0 | ~393 tests passing |

---

## 8. Testing Summary

- ~15 new qualification tests for REQ-MCP-016 covering:
  - Scenario A: Container identity locks out host sub-agent (stdio rejected when HTTP active)
  - Scenario B: Duplicate container rejected (different instance_id for same identity)
  - TTL expiry and heartbeat refresh
  - Registry cleanup of expired locks
  - Error message content verification
  - End-to-end tool call with colliding identity
- Full regression: all 378 existing tests must continue to pass

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Create `.test-env/qms-cli/` working directory
2. Clone qms-cli from GitHub
3. Create and checkout branch `cr-074-identity-collision`
4. Verify clean test environment (378 tests passing)

### 9.2 Phase 2: Requirements (RS Update)

1. Checkout SDLC-QMS-RS in production QMS
2. Add REQ-MCP-016 (Identity Collision Prevention)
3. Checkin RS, route for review and approval

### 9.3 Phase 3: Implementation

1. Modify `qms_mcp/server.py` -- add IdentityCollisionError, IdentityLock, registry functions, update resolve_identity()
2. Modify `agent-hub/docker/scripts/mcp_proxy.py` -- add UUID generation and X-QMS-Instance header injection
3. Test locally

### 9.4 Phase 4: Qualification

1. Add ~15 qualification tests to `tests/qualification/test_mcp.py`
2. Run full test suite, verify all tests pass
3. Push to dev branch
4. Verify GitHub Actions CI passes
5. Document qualified commit hash

### 9.5 Phase 5: RTM Update and Approval

1. Checkout SDLC-QMS-RTM in production QMS
2. Add verification evidence for REQ-MCP-016 referencing CI-verified commit
3. Checkin RTM, route for review and approval
4. **Verify RTM reaches EFFECTIVE status before proceeding to Phase 6**

### 9.6 Phase 6: Merge and Submodule Update

**Prerequisite:** RS and RTM must both be EFFECTIVE before proceeding (per SOP-006 Section 7.4).

1. Verify RS is EFFECTIVE
2. Verify RTM is EFFECTIVE
3. Create PR to merge dev branch to main
4. Merge PR
5. Update submodule pointer in parent repo
6. Verify functionality in production context

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Test environment setup: clone qms-cli, create branch cr-074-identity-collision, verify 378 tests passing | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | RS update: add REQ-MCP-016 to SDLC-QMS-RS, route through review/approval to EFFECTIVE | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Implementation: add identity registry and collision detection to server.py, add instance UUID to mcp_proxy.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Qualification: add ~15 tests for REQ-MCP-016, run full suite, push to dev branch, verify CI | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | RTM update: add REQ-MCP-016 traceability, update qualified baseline, route through review/approval to EFFECTIVE | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Merge and submodule update: PR to main, merge, update pipe-dream submodule pointer | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution
- **SOP-005:** Code Governance
- **SOP-006:** SDLC Governance
- **SOP-007:** Agent Orchestration
- **CR-073:** Transport-based identity resolution (Phase 1) -- CLOSED
- **Session 2026-02-09-006:** Identity management design exploration (5-phase plan)
- **REQ-MCP-015:** Transport-based identity resolution (Phase 1 requirement)
- **REQ-MCP-016:** Identity collision prevention (this CR's requirement)

---

**END OF DOCUMENT**
