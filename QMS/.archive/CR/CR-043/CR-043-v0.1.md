---
title: Implement Containerized Claude Agent Infrastructure
revision_summary: Address QA feedback - remove TBD placeholder, specify Claude Code
  installation
---

# CR-043: Implement Containerized Claude Agent Infrastructure

## 1. Purpose

Create Docker container infrastructure for running Claude agents with controlled access to the QMS and codebase. The container provides isolation while maintaining QMS integrity through the remote MCP server connection established in CR-042.

---

## 2. Scope

### 2.1 Context

This CR implements the container architecture designed in Session-2026-02-01-001. It builds on CR-042 which added remote transport support to the QMS MCP server, enabling containerized agents to connect via HTTP/SSE.

- **Parent Document:** CR-042 (Add Remote Transport Support to QMS MCP Server)

### 2.2 Changes Summary

1. Create Dockerfile defining the Claude agent container environment
2. Create docker-compose.yml for orchestrating container and MCP server
3. Create startup scripts for host MCP server and container
4. Bake MCP connection configuration into container image
5. Document container usage and development workflows
6. Test container connectivity to host MCP server

### 2.3 Files Affected

- `docker/Dockerfile` - Container image definition
- `docker/docker-compose.yml` - Orchestration configuration
- `docker/.mcp.json` - MCP config baked into image
- `docker/scripts/start-mcp-server.sh` - Host MCP server startup
- `docker/scripts/start-container.sh` - Container startup helper
- `docker/README.md` - Container usage documentation
- `CLAUDE.md` - Add container infrastructure section

---

## 3. Current State

- Claude Code runs directly on the host with full filesystem access
- QMS MCP server supports remote SSE transport (CR-042)
- No containerization infrastructure exists
- No isolation between Claude and production QMS files

---

## 4. Proposed State

- Docker container provides isolated Claude agent environment
- Container has read-only access to production QMS and codebase
- Container has read-write access only to:
  - `/projects/` for code development
  - `/pipe-dream/.claude/users/claude/workspace/` for QMS document checkout
- All QMS write operations flow through host MCP server via SSE
- Container image includes baked-in MCP connection configuration

---

## 5. Change Description

### 5.1 Container Filesystem Structure

```
/                                      # Container root (HOME=/)
├── .mcp.json                          # MCP connection config (baked in)
├── .gitconfig                         # Git configuration
├── .ssh/                              # Deploy keys (mounted at runtime)
├── .claude/                           # Claude Code config
│
├── projects/                          # [R/W] Development workspace
│
└── pipe-dream/                        # Production QMS mount
    ├── CLAUDE.md                      # [READ-ONLY]
    ├── QMS/                           # [READ-ONLY]
    ├── flow-state/                    # [READ-ONLY]
    ├── qms-cli/                       # [READ-ONLY]
    └── .claude/users/claude/
        ├── inbox/                     # [READ-ONLY]
        └── workspace/                 # [R/W]
```

### 5.2 Dockerfile

```dockerfile
FROM python:3.11-slim

# Set container root as home
ENV HOME=/
WORKDIR /

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI
RUN npm install -g @anthropic/claude-code

# Create directory structure
RUN mkdir -p /projects /pipe-dream /.claude /.ssh

# Copy baked-in MCP configuration
COPY .mcp.json /.mcp.json

# Default git config (can be overridden by mount)
RUN git config --global init.defaultBranch main

# Entry point - start Claude Code
CMD ["claude"]
```

**Note:** The Claude Code CLI installation assumes the package is available via npm. If the installation method changes, the Dockerfile will be updated during execution (EI-2).

### 5.3 MCP Configuration (Baked In)

```json
{
  "mcpServers": {
    "qms": {
      "type": "sse",
      "url": "http://host.docker.internal:8000/sse"
    }
  }
}
```

### 5.4 Docker Compose

```yaml
version: '3.8'

services:
  claude-agent:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Production QMS (read-only)
      - ../:/pipe-dream:ro
      # Workspace (read-write overlay)
      - ../.claude/users/claude/workspace:/pipe-dream/.claude/users/claude/workspace:rw
      # SSH keys (read-only)
      - ~/.ssh:/.ssh:ro
    environment:
      - HOME=/
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Linux compatibility
    stdin_open: true
    tty: true
```

### 5.5 Startup Scripts

**start-mcp-server.sh** (run on host):
```bash
#!/bin/bash
cd "$(dirname "$0")/.."
python -m qms_mcp --transport sse --port 8000 --project-root "$(pwd)"
```

**start-container.sh** (convenience wrapper):
```bash
#!/bin/bash
cd "$(dirname "$0")"
docker-compose up -d
docker-compose exec claude-agent bash
```

### 5.6 Access Control Summary

| Path | Access | Mechanism |
|------|--------|-----------|
| `/` (root dotfiles) | R/W | Container filesystem |
| `/projects/` | R/W | Container filesystem |
| `/pipe-dream/` | Read-only | Volume mount `:ro` |
| `/pipe-dream/.claude/users/claude/workspace/` | R/W | Overlay mount `:rw` |

---

## 6. Justification

- **Problem:** Claude currently runs with full filesystem access, risking accidental modification of production QMS files or codebase
- **Impact of not making this change:** No isolation between agent operations and production state; direct file manipulation can bypass QMS controls
- **Solution addresses root cause:** Container enforces filesystem-level access control; all QMS writes must flow through authenticated MCP server on host

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `docker/Dockerfile` | Create | Container image definition |
| `docker/docker-compose.yml` | Create | Orchestration config |
| `docker/.mcp.json` | Create | Baked-in MCP config |
| `docker/scripts/start-mcp-server.sh` | Create | Host startup script |
| `docker/scripts/start-container.sh` | Create | Container startup script |
| `docker/README.md` | Create | Usage documentation |
| `CLAUDE.md` | Modify | Add container section |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| CLAUDE.md | Modify | Add container infrastructure documentation |

### 7.3 Other Impacts

- **Docker requirement:** Host must have Docker Desktop (Mac/Windows) or Docker Engine (Linux)
- **Network:** Container uses `host.docker.internal` to reach host MCP server
- **Linux compatibility:** Requires `extra_hosts` configuration for `host.docker.internal`

---

## 8. Testing Summary

| Test | Description |
|------|-------------|
| Build container image | Verify Dockerfile builds without errors |
| Start MCP server on host | Verify server binds to port 8000 |
| Container connects to MCP | Verify container can reach host.docker.internal:8000 |
| QMS read operations | Verify container can read QMS documents via MCP |
| QMS write operations | Verify checkout/checkin flow works through MCP |
| Read-only enforcement | Verify container cannot write to /pipe-dream/ directly |
| Workspace write access | Verify container can write to workspace directory |
| Git clone to /projects/ | Verify container can clone repos for development |

---

## 9. Implementation Plan

### 9.1 Phase 1: Docker Infrastructure

1. Create `docker/` directory structure
2. Create Dockerfile with base image and directory structure
3. Create `.mcp.json` for baking into image
4. Create docker-compose.yml with volume mounts
5. Create startup scripts

### 9.2 Phase 2: Testing

1. Build container image
2. Start MCP server on host
3. Start container and verify MCP connectivity
4. Test QMS read operations (inbox, status, read)
5. Test QMS write operations (checkout, edit, checkin)
6. Verify read-only mounts prevent direct writes
7. Test git clone to /projects/

### 9.3 Phase 3: Documentation

1. Create README.md with usage instructions
2. Update CLAUDE.md with container infrastructure section
3. Document known limitations and troubleshooting

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Create docker/ directory structure | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Create Dockerfile | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Create .mcp.json for container | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Create docker-compose.yml | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Create startup scripts | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Build container image | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Test MCP server connectivity from container | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-8 | Test QMS read/write operations via MCP | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-9 | Verify read-only mount enforcement | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-10 | Test git clone to /projects/ | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-11 | Create README.md documentation | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-12 | Update CLAUDE.md with container section | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-042:** Add Remote Transport Support to QMS MCP Server
- **Session-2026-02-01-001:** Container Architecture Vision document
- **Docker Documentation:** https://docs.docker.com/
- **Claude Code MCP Docs:** https://code.claude.com/docs/en/mcp

---

**END OF DOCUMENT**
