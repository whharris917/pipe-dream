---
title: Inbox Watcher Notification Injection via tmux
revision_summary: Initial draft
---

# CR-058: Inbox Watcher Notification Injection via tmux

## 1. Purpose

This CR implements notification injection from the inbox watcher into running container agent sessions. When a QMS task (review, approval, etc.) arrives in an agent's inbox, the notification is typed directly into the agent's Claude Code input prompt, waking idle agents and enabling autonomous multi-agent workflow without human intervention.

This fulfills the open execution item from CR-056-VAR-003 (EI-1: Create CR for inbox watcher notification injection).

---

## 2. Scope

### 2.1 Context

CR-056 delivered multi-agent container infrastructure including an inbox watcher that detects new task files. However, the watcher only prints notifications to its own console terminal -- it cannot inject notifications into the target agent's Claude Code session. CR-056-VAR-003 (Type 2, PRE_APPROVED) formally documented this gap and required a follow-up CR.

- **Parent Document:** CR-056-VAR-003

### 2.2 Changes Summary

Run Claude Code inside a tmux session within each container. The inbox watcher uses `docker exec` + `tmux send-keys` to type notification text directly into the target agent's Claude Code input prompt. This is a push-based mechanism that works even when the agent is idle at the prompt.

### 2.3 Files Affected

- `docker/Dockerfile` - Add tmux package to container image
- `launch.sh` - Change `docker exec` to launch Claude Code inside a tmux session
- `docker/scripts/inbox-watcher.py` - Replace `_send_notification()` stub with tmux injection via `docker exec`
- `.claude/agents/qa.md` - Add inbox notification instructions
- `.claude/agents/tu_ui.md` - Add inbox notification instructions
- `.claude/agents/tu_scene.md` - Add inbox notification instructions
- `.claude/agents/tu_sketch.md` - Add inbox notification instructions
- `.claude/agents/tu_sim.md` - Add inbox notification instructions
- `.claude/agents/bu.md` - Add inbox notification instructions

---

## 3. Current State

The inbox watcher (`docker/scripts/inbox-watcher.py`) detects new task files in agent inbox directories and generates ASCII-formatted notifications. The `_send_notification()` method is a stub that only prints to the watcher's own console. Agents running in separate container terminals never receive these notifications. Human intervention is required to switch between terminal windows and alert agents to pending tasks.

Claude Code runs directly via `docker exec -it agent-{name} claude` without any session multiplexer.

---

## 4. Proposed State

Claude Code runs inside a tmux session within each container. When a new inbox item arrives, the inbox watcher uses `docker exec agent-{name} tmux send-keys` to type a notification message directly into the agent's Claude Code input prompt. Idle agents receive the notification immediately and begin processing. Active agents receive the notification when their current task completes and the input prompt appears. The watcher console continues to display ASCII notifications for human observation.

---

## 5. Change Description

### 5.1 tmux Session Architecture

Each container agent's Claude Code session runs inside a tmux session named `agent`. The launch flow changes from:

```
docker exec -it agent-{name} claude
```

To:

```
docker exec -it agent-{name} tmux new-session -s agent "claude"
```

`tmux new-session -s agent "claude"` creates a tmux session running Claude Code as its command. When Claude exits, the tmux session ends and docker exec returns. Cleanup proceeds exactly as before. No changes to `entrypoint.sh` are required -- the tmux session is created at exec time, not during container setup.

**Validation:** Claude Code's own experimental agent teams feature uses tmux for split-pane mode, confirming full compatibility between tmux and Claude Code's terminal rendering.

### 5.2 Notification Injection via tmux send-keys

When the inbox watcher detects a new file in an agent's inbox directory, `_send_notification()` executes:

```bash
docker exec agent-{name} tmux send-keys -t agent -l "Task notification: Review CR-058 is in your inbox. Please run qms_inbox() to see your pending tasks."
docker exec agent-{name} tmux send-keys -t agent Enter
```

Key design decisions:

- **`-l` flag:** Sends text literally, preventing tmux from interpreting key names (e.g., "Enter" as characters E-n-t-e-r, not the Enter key)
- **Separate Enter:** Submitted as a distinct send-keys call without `-l` to actually press the Enter key
- **Message prefix "Task notification:"**: The leading "T" character is not a valid Claude Code permission dialog response (y/n/a/i), mitigating the edge case where send-keys arrives during a permission prompt
- **Agent state handling:**

| Agent State | Behavior | Result |
|-------------|----------|--------|
| Idle at prompt | Text typed and Enter submitted immediately | Agent wakes up and processes notification |
| Generating output | Keystrokes queue in tmux input buffer | Agent receives notification when prompt appears after current task |
| Permission dialog | First character enters dialog context | Edge case (see Section 5.4) |

### 5.3 Inbox Watcher Refactoring

The current `_send_notification()` accepts only a pre-formatted ASCII string. The refactored version receives structured data (agent name, doc_id, action type) to construct both:

1. A concise direct instruction for tmux injection
2. The existing ASCII box notification for the watcher console

The `_generate_notification()` method continues producing ASCII boxes for human-visible console output. A new `_inject_notification()` method handles the tmux send-keys logic.

### 5.4 Known Limitations

**Permission dialog interference:** If tmux send-keys fires while Claude Code is displaying a y/n/a/i permission prompt, the first character of the injected text could be interpreted as a response. The message prefix "Task notification:" starts with "T", which is not a valid permission option, minimizing this risk. The practical window where a permission dialog is active is very brief.

**Message queuing during generation:** When an agent is actively generating output, tmux buffers the injected keystrokes. The notification appears as the next user prompt after the current task completes. This is correct behavior -- the agent finishes its current work before processing the notification.

---

## 6. Justification

- **Autonomous multi-agent operation:** Without notification injection, human intervention is required to switch between terminal windows and alert agents to pending tasks. This breaks the autonomous workflow loop.
- **Impact of not making this change:** Agents remain unaware of incoming tasks until a human notices the watcher console and manually intervenes. Multi-agent sessions require constant human attention.
- **Push-based design:** Most multi-agent frameworks rely on polling (e.g., Redis `brpop` with timeouts). tmux send-keys provides immediate push-based notification, waking idle agents without polling overhead or API token consumption.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `docker/Dockerfile` | Modify | Add `tmux` to apt-get install |
| `launch.sh` | Modify | Change docker exec to use `tmux new-session` |
| `docker/scripts/inbox-watcher.py` | Modify | Replace `_send_notification()` stub with tmux injection |
| `.claude/agents/qa.md` | Modify | Add inbox notification instructions |
| `.claude/agents/tu_ui.md` | Modify | Add inbox notification instructions |
| `.claude/agents/tu_scene.md` | Modify | Add inbox notification instructions |
| `.claude/agents/tu_sketch.md` | Modify | Add inbox notification instructions |
| `.claude/agents/tu_sim.md` | Modify | Add inbox notification instructions |
| `.claude/agents/bu.md` | Modify | Add inbox notification instructions |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No QMS controlled documents modified |

### 7.3 Other Impacts

- **Docker image rebuild required:** Adding tmux to the Dockerfile requires `docker-compose build --no-cache`. This is a known pattern from prior CRs (CR-056, CR-057).
- **Container startup:** No impact. tmux session is created at `docker exec` time, not during entrypoint setup.
- **Single-agent mode:** `./launch.sh qa` now runs Claude Code inside tmux. Functionally transparent to the user.

---

## 8. Testing Summary

- **T1 - tmux rendering:** Launch single agent via `./launch.sh qa`, verify Claude Code renders correctly inside tmux (colors, cursor positioning, input handling)
- **T2 - Session lifecycle:** Verify `exit` in Claude Code cleanly closes tmux session, docker exec returns, container is cleaned up
- **T3 - Idle wake-up:** Start QA agent, let it go idle at prompt. Manually create a task file in QA's inbox. Verify watcher injects notification and QA wakes up.
- **T4 - Active agent notification:** QA is mid-task (generating output). Create task file in QA's inbox. Verify notification queues and appears at next prompt.
- **T5 - End-to-end:** `./launch.sh claude qa`. Claude routes a document for review. Verify QA receives notification, calls `qms_inbox()`, and processes the task.

---

## 9. Implementation Plan

### 9.1 Phase 1: Container Image Update

1. Add `tmux` to `docker/Dockerfile` apt-get install list
2. Rebuild image with `docker-compose build --no-cache`
3. Verify tmux is available inside container

### 9.2 Phase 2: tmux Launch Integration

1. Modify `launch_claude()` in `launch.sh` to use `tmux new-session -s agent "claude"` instead of direct `claude` exec
2. Test single-agent launch: verify Claude Code works correctly inside tmux
3. Test session exit: verify cleanup chain (Claude exit -> tmux exit -> docker exec return -> container stop)

### 9.3 Phase 3: Inbox Watcher Notification Injection

1. Refactor `_send_notification()` in `docker/scripts/inbox-watcher.py`:
   - Add `_inject_notification()` method using `docker exec` + `tmux send-keys`
   - Refactor `on_created()` to pass structured data (agent, doc_id, action) alongside formatted text
   - Preserve existing ASCII box console output
2. Test injection: manually create inbox file, verify tmux send-keys delivers message to agent prompt

### 9.4 Phase 4: Agent Definition Updates

1. Add inbox notification section to all agent definition files (`.claude/agents/*.md`)
2. Instructions explain that agents will receive task notifications as text messages and should call `qms_inbox()` when notified

### 9.5 Phase 5: End-to-End Testing

1. Launch multi-agent session: `./launch.sh claude qa`
2. Route a test document from Claude for QA review
3. Verify: inbox watcher detects file, injects notification into QA's session, QA processes task
4. Test idle wake-up: QA idle at prompt, create inbox file, verify QA wakes up
5. Test active notification: QA mid-task, create inbox file, verify notification queues correctly

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add tmux to Dockerfile, rebuild container image | Added `tmux` to apt-get install list in `docker/Dockerfile`. Image rebuilt with `docker-compose build --no-cache`. Commit `fd05d8e`. | Pass | claude - 2026-02-06 |
| EI-2 | Modify launch.sh to run Claude Code inside tmux session | Changed `launch_claude()` in `launch.sh` line 215: `docker exec -it "$container_name" claude` replaced with `docker exec -it "$container_name" tmux new-session -s agent "claude"`. Commit `fd05d8e`. | Pass | claude - 2026-02-06 |
| EI-3 | Implement tmux send-keys injection in inbox-watcher.py | Refactored `docker/scripts/inbox-watcher.py`: removed `_send_notification()` stub; added `_build_injection_text()` (constructs concise agent instruction per file type) and `_inject_notification()` (executes `docker exec` + `tmux send-keys -t agent -l` + `tmux send-keys -t agent Enter`). Console ASCII output preserved via direct `print()` in `on_created()`. Commit `fd05d8e`. | Pass | claude - 2026-02-06 |
| EI-4 | Update agent definition files with notification instructions | Added "Inbox Notifications" section to all 6 agent definition files: `qa.md`, `bu.md`, `tu_ui.md`, `tu_scene.md`, `tu_sketch.md`, `tu_sim.md`. Each section uses the agent's own identity in the `qms_inbox()` example. Commit `fd05d8e`. | Pass | claude - 2026-02-06 |
| EI-5 | End-to-end testing (T1-T5) | **T1 (tmux rendering):** Claude Code renders correctly inside tmux — colors, cursor, input all normal. **T2 (session lifecycle):** `exit` cleanly closes Claude Code, tmux session, and docker exec; container stops and is removed. **T3 (idle wake-up):** Manually created inbox file; watcher printed ASCII notification and injected text into QA's tmux session; QA received and processed the notification. **T4 (active agent):** Notification injected while QA was mid-task; Claude Code's built-in pending message queue captured it; notification processed at next prompt (see Execution Comments). **T5 (end-to-end):** Multi-agent session `./launch.sh claude qa`; Claude routed document for QA review; inbox watcher detected file, injected notification, QA received and processed task. All tests pass. | Pass | lead - 2026-02-06 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| **T4 observation — queuing mechanism:** Section 5.2 described the active-agent case as "Keystrokes queue in tmux input buffer." Testing revealed that tmux delivers keystrokes immediately through to Claude Code, which catches them in its own **built-in pending message queue** (the native feature where typing during generation queues input). The end result is identical — notification arrives after the current task completes — but the mechanism is Claude Code's native queue, not tmux buffering. This is the ideal behavior: it uses Claude Code's own input handling, shows the pending message indicator, and processes the notification at the correct time. No code changes needed; this is better than designed. | claude - 2026-02-06 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All five execution items completed successfully. EI-1 through EI-4 were implemented per plan in commit `fd05d8e`. EI-5 end-to-end testing (T1-T5) confirmed correct behavior across all scenarios: tmux rendering, session lifecycle, idle wake-up, active agent queuing, and full multi-agent workflow.

One design clarification emerged during T4 testing: the active-agent notification queuing mechanism is Claude Code's native pending message queue, not tmux input buffering as described in Section 5.2. This is a better-than-designed outcome — no code changes required.

No deviations from the approved implementation plan. No VARs filed.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution
- **CR-056:** Multi-Agent Container Session Infrastructure (parent CR that identified the gap)
- **CR-056-VAR-003:** Inbox Watcher Notification Injection Not Implemented (parent variance)
- **CR-057:** MCP Stdio Proxy (related container infrastructure)

---

**END OF DOCUMENT**
