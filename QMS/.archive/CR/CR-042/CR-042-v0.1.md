---
title: Add Remote Transport Support to QMS MCP Server
revision_summary: Initial draft
---

# CR-042: Add Remote Transport Support to QMS MCP Server

## 1. Purpose

Enable the QMS MCP server to run as a standalone host service accessible via HTTP, supporting containerized Claude agents. Currently the MCP server runs only as a Claude Code subprocess using stdio transport. This CR adds remote transport support (SSE/HTTP) so that Claude running inside a Docker container can connect to the MCP server running on the host, enabling filesystem isolation while maintaining QMS access.

---

## 2. Scope

### 2.1 Context

This CR is part of the containerization initiative to run Claude agents in isolated Docker containers. The container architecture requires:
- Claude in container has read-only access to `QMS/`, `flow-state/`, `qms-cli/`
- QMS write operations must flow through the MCP server on the host
- MCP server on host has full filesystem access to perform QMS operations

- **Parent Document:** None (infrastructure improvement for containerization)

### 2.2 Changes Summary

1. Add CLI arguments to qms_mcp server for transport configuration (`--transport`, `--host`, `--port`)
2. Support SSE transport in addition to existing stdio transport
3. Default to stdio for backward compatibility
4. Add qualification tests for remote transport functionality
5. Update RS/RTM with new requirements
6. Document container configuration for remote MCP access

### 2.3 Files Affected

**qms-cli code changes (on development branch):**
- `qms-cli/qms_mcp/server.py` - Add CLI argument parsing and transport selection
- `qms-cli/qms_mcp/__main__.py` - Update entry point for CLI args
- `qms-cli/tests/qualification/test_mcp.py` - Add remote transport tests

**QMS documents (in production pipe-dream/QMS):**
- `QMS/SDLC-QMS/SDLC-QMS-RS.md` - Add REQ-MCP-011 through REQ-MCP-013
- `QMS/SDLC-QMS/SDLC-QMS-RTM.md` - Add verification evidence

**Documentation:**
- `CLAUDE.md` - Add container MCP configuration section

---

## 3. Current State

- The QMS MCP server runs exclusively via stdio transport as a Claude Code subprocess
- Server is spawned by Claude Code and dies when Claude Code exits
- Project root is auto-discovered by walking directory tree from cwd
- No support for remote HTTP connections
- Container-based Claude cannot access QMS without direct filesystem mounts

---

## 4. Proposed State

- The QMS MCP server supports both stdio (default) and SSE/HTTP transports
- Server can run as standalone host service via `python -m qms_mcp --transport sse --port 8000`
- Project root can be specified via `--project-root` argument or `QMS_PROJECT_ROOT` environment variable
- Container-based Claude connects to `http://host.docker.internal:8000/sse`
- Backward compatibility maintained: existing stdio configuration works unchanged

---

## 5. Change Description

### 5.1 CLI Argument Parsing

Add argument parsing to `qms_mcp` server:

```python
import argparse

def parse_args():
    parser = argparse.ArgumentParser(description="QMS MCP Server")
    parser.add_argument(
        "--transport",
        choices=["stdio", "sse"],
        default="stdio",
        help="Transport mode (default: stdio)"
    )
    parser.add_argument(
        "--host",
        default="127.0.0.1",
        help="Host to bind (default: 127.0.0.1)"
    )
    parser.add_argument(
        "--port",
        type=int,
        default=8000,
        help="Port to bind (default: 8000)"
    )
    parser.add_argument(
        "--project-root",
        help="Project root directory (default: auto-discover)"
    )
    return parser.parse_args()
```

### 5.2 Transport Selection

Modify the `main()` function to select transport based on CLI args:

```python
def main():
    args = parse_args()

    # Set project root if specified
    if args.project_root:
        os.environ["QMS_PROJECT_ROOT"] = args.project_root

    # Register tools
    from .tools import register_tools
    register_tools(mcp, run_qms_command)

    # Run with selected transport
    if args.transport == "stdio":
        mcp.run(transport="stdio")
    else:
        mcp.run(transport="sse", host=args.host, port=args.port)
```

### 5.3 Project Root Configuration

Modify `get_qms_root()` to check environment variable first:

```python
def get_qms_root() -> Path | None:
    # Check environment variable first
    env_root = os.environ.get("QMS_PROJECT_ROOT")
    if env_root:
        path = Path(env_root)
        if (path / "QMS").is_dir():
            return path

    # Fall back to directory walking
    cwd = Path.cwd()
    for parent in [cwd] + list(cwd.parents):
        if (parent / "QMS").is_dir():
            return parent

    return None
```

### 5.4 Security Considerations

- Default binding to `127.0.0.1` (localhost only) prevents external access
- No authentication added in this CR (future enhancement if needed)
- Container connects via `host.docker.internal` which resolves to host's localhost

### 5.5 Container Configuration

Container's `.mcp.json` configuration for remote access:

```json
{
  "mcpServers": {
    "qms": {
      "type": "sse",
      "url": "http://host.docker.internal:8000/sse"
    }
  }
}
```

---

## 6. Justification

- **Problem:** Claude running in a Docker container cannot access the QMS MCP server because the server runs as a subprocess of Claude Code (which would be inside the container), but the QMS filesystem is on the host
- **Impact of not making this change:** Containerization initiative cannot proceed; Claude in container would need direct write access to QMS files, defeating the purpose of isolation
- **Solution addresses root cause:** By running the MCP server on the host with HTTP transport, the container can make remote tool calls while the server has full host filesystem access for QMS operations

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_mcp/server.py` | Modify | Add CLI args, transport selection, env var support |
| `qms-cli/qms_mcp/__main__.py` | Modify | Pass CLI args to main() |
| `qms-cli/tests/qualification/test_mcp.py` | Modify | Add remote transport tests |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Modify | Add REQ-MCP-011 through REQ-MCP-013 |
| SDLC-QMS-RTM | Modify | Add verification evidence for new requirements |
| CLAUDE.md | Modify | Add container MCP configuration section |

### 7.3 Other Impacts

- **Dependencies:** No new dependencies (FastMCP already supports SSE transport)
- **Backward compatibility:** Existing stdio configuration continues to work unchanged
- **Docker:** Requires `host.docker.internal` support (available in Docker Desktop)

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development follows established controls:

1. **Test environment isolation:** Development in `.test-env/test-project/qms-cli/` (gitignored)
2. **Branch isolation:** All development on branch `cr-042-remote-mcp`
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new requirements must have passing tests before merge
5. **CI verification:** Tests must pass on GitHub Actions for dev branch
6. **PR gate:** Changes merge to main only via PR after RS/RTM approval
7. **Submodule update:** pipe-dream updates pointer only after PR merge

### 7.5 Qualified State Continuity

| Time | main branch | RS/RTM Status | Qualified Release |
|------|-------------|---------------|-------------------|
| Before CR | Current commit | EFFECTIVE v4.0 | CLI-3.0 |
| During execution | Unchanged | DRAFT (checked out) | CLI-3.0 (unchanged) |
| Post-approval | Merged from cr-042-remote-mcp | EFFECTIVE v5.0 | CLI-4.0 |

---

## 8. Testing Summary

**Qualification Testing (required before merge):**

| Test | Description |
|------|-------------|
| `test_mcp_cli_args_default` | Verify default transport is stdio |
| `test_mcp_cli_args_sse` | Verify --transport sse is accepted |
| `test_mcp_cli_args_host_port` | Verify --host and --port are accepted |
| `test_mcp_project_root_env` | Verify QMS_PROJECT_ROOT env var is respected |
| `test_mcp_project_root_arg` | Verify --project-root arg is respected |
| `test_mcp_sse_server_starts` | Verify SSE server starts and binds to port |
| `test_mcp_sse_endpoint_responds` | Verify SSE endpoint responds to requests |

**Manual Verification:**
- Start MCP server with `python -m qms_mcp --transport sse --port 8000`
- Verify server binds to localhost:8000
- Verify existing stdio mode still works

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Verify `.test-env/test-project/` exists (from prior CRs)
2. Update qms-cli clone from GitHub if needed
3. Create and checkout branch `cr-042-remote-mcp`
4. Verify clean test environment

### 9.2 Phase 2: Requirements (RS Update)

1. Checkout SDLC-QMS-RS in production QMS
2. Add REQ-MCP-011: Remote transport support
3. Add REQ-MCP-012: CLI configuration options
4. Add REQ-MCP-013: Project root configuration
5. Checkin RS, route for review and approval

### 9.3 Phase 3: Implementation

1. Implement CLI argument parsing in `__main__.py` and `server.py`
2. Implement transport selection logic
3. Implement QMS_PROJECT_ROOT environment variable support
4. Implement --project-root CLI argument support
5. Test locally with both stdio and sse transports

### 9.4 Phase 4: Qualification

1. Add qualification tests for CLI arguments
2. Add qualification tests for environment variable
3. Add qualification tests for SSE server startup
4. Run full test suite, verify all tests pass
5. Push to dev branch, verify GitHub Actions passes
6. Document qualified commit hash

### 9.5 Phase 5: RTM Update

1. Checkout SDLC-QMS-RTM in production QMS
2. Add verification evidence for REQ-MCP-011 through REQ-MCP-013
3. Reference CI-verified commit hash
4. Checkin RTM, route for review and approval

### 9.6 Phase 6: Merge and Submodule Update

1. Once RS and RTM are EFFECTIVE, create PR to merge `cr-042-remote-mcp` to main
2. Merge PR (CLI-3.0 â†’ CLI-4.0)
3. Update qms-cli submodule pointer in pipe-dream
4. Verify MCP server works with both transports

### 9.7 Phase 7: Documentation

1. Update CLAUDE.md with container MCP configuration section
2. Document host service startup command
3. Document container `.mcp.json` format for remote access

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Verify test environment and create branch cr-042-remote-mcp | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Checkout and update SDLC-QMS-RS with REQ-MCP-011 through REQ-MCP-013 | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Route RS for review and approval | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Implement CLI argument parsing | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Implement transport selection logic | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Implement project root configuration (env var and CLI arg) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Add qualification tests for remote transport | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-8 | Run full test suite, push to dev branch, verify CI passes | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-9 | Checkout and update SDLC-QMS-RTM with verification evidence | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-10 | Route RTM for review and approval | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-11 | Create PR and merge cr-042-remote-mcp to main | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-12 | Update qms-cli submodule pointer in pipe-dream | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-13 | Update CLAUDE.md with container MCP configuration | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-14 | Verify MCP server works with both transports in pipe-dream | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-005:** Code Governance
- **SOP-006:** SDLC Governance
- **SDLC-QMS-RS:** QMS CLI Requirements Specification
- **SDLC-QMS-RTM:** QMS CLI Requirements Traceability Matrix
- **CR-041:** Implement QMS MCP Server (prerequisite, established MCP infrastructure)
- **FastMCP Documentation:** https://gofastmcp.com/deployment/running-server
- **Claude Code MCP Docs:** https://code.claude.com/docs/en/mcp

---

**END OF DOCUMENT**
