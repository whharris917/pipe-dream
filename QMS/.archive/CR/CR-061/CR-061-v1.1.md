---
title: Launch script Hub integration and obsolete file cleanup
revision_summary: Initial draft
---

# CR-061: Launch script Hub integration and obsolete file cleanup

## 1. Purpose

Integrate the Agent Hub (created in CR-060) into the launch workflow and remove files that the Hub has made obsolete. The launch script currently starts a standalone inbox watcher process for multi-agent sessions; the Hub now provides this functionality along with policy-driven auto-start/stop and a REST API. Additionally, several stale artifacts (debug scripts, path-corruption directories, old log files) have accumulated and should be cleaned up.

---

## 2. Scope

### 2.1 Context

- **Parent Document:** CR-060 (Agent Hub genesis)

### 2.2 Changes Summary

1. Update `launch.sh` to start the Agent Hub instead of the standalone inbox watcher
2. Delete obsolete scripts from `docker/scripts/`
3. Delete empty `;C` directories (Docker/Windows path corruption artifacts)
4. Delete stale `.inbox-watcher.log`
5. Update `CLAUDE.md` to remove reference to deleted `start-container.sh`

### 2.3 Files Affected

- `launch.sh` — Replace `start_inbox_watcher()` with `ensure_hub()` function
- `docker/scripts/inbox-watcher.py` — Delete (absorbed by Hub)
- `docker/scripts/start-container.sh` — Delete (superseded by `launch.sh`)
- `docker/scripts/debug-mcp.sh` — Delete (one-off debug script)
- `docker/scripts/test-proxy-reliability.sh` — Delete (one-off test script)
- `docker/scripts/__pycache__/` — Delete (bytecode cache from inbox-watcher)
- `.inbox-watcher.log` — Delete (stale log)
- 8 empty `;C` directories — Delete (path corruption artifacts)
- `CLAUDE.md` — Remove `start-container.sh` from directory tree listing
- `agent-hub/agent_hub/hub.py` — Add `_container_sync_loop` and `_hub_managed` (UAT fix)

---

## 3. Current State

`launch.sh` starts a standalone `inbox-watcher.py` process in a separate terminal window for multi-agent sessions. The inbox watcher monitors agent inbox directories and injects tmux notifications into running containers.

`docker/scripts/` contains 4 obsolete files: `inbox-watcher.py` (absorbed by Hub), `start-container.sh` (superseded by `launch.sh`), `debug-mcp.sh` (one-off debug script), and `test-proxy-reliability.sh` (one-off test script).

8 empty directories with `;C` suffixes exist throughout the project tree, created by Docker/Windows path corruption on Feb 4.

A stale `.inbox-watcher.log` file remains at the project root from the last standalone watcher run.

---

## 4. Proposed State

`launch.sh` starts the Agent Hub service if it is not already running. The Hub provides inbox monitoring, notification injection, and policy-based agent lifecycle management via its REST API on port 9000.

`docker/scripts/` contains only actively-used files: `mcp_proxy.py`, `start-mcp-server.sh`, and `start-git-mcp.sh`.

All `;C` path corruption artifacts and stale log files are removed.

---

## 5. Change Description

### 5.1 Launch Script Hub Integration

Replace `start_inbox_watcher()` with `ensure_hub()`:

- Check if the Hub is already running by probing `http://localhost:9000/api/health`
- If not running, start it as a background process using `agent-hub start`
- Write PID to `.agent-hub.pid` for later cleanup (consistent with MCP server PID pattern)
- Wait for health check to confirm startup
- Remove `start_inbox_watcher()` function and `.inbox-watcher.pid` handling
- Update post-session info to include Hub in the cleanup message

### 5.2 Obsolete File Deletion

| File | Reason |
|------|--------|
| `docker/scripts/inbox-watcher.py` | Fully absorbed by `agent_hub/inbox.py` + `agent_hub/notifier.py` |
| `docker/scripts/start-container.sh` | Superseded by `launch.sh`; references deprecated SSE endpoint |
| `docker/scripts/debug-mcp.sh` | One-off debug script with hardcoded auth headers |
| `docker/scripts/test-proxy-reliability.sh` | One-off test script for proxy investigation |
| `docker/scripts/__pycache__/` | Bytecode cache, no source remains |
| `.inbox-watcher.log` | Stale log from standalone watcher |

### 5.3 Path Corruption Cleanup

Delete 8 empty directories created by Docker/Windows path mangling on Feb 4:

- `.claude/agents/qa.md;C`
- `.claude/sessions;C`
- `.claude/users/claude/container;C`
- `.claude/users/claude/workspace;C`
- `.claude/users/qa/container;C`
- `.claude/users/qa/workspace;C`
- `docker/.claude-settings.json;C`
- `docker/.mcp.json;C`

### 5.4 CLAUDE.md Update

Remove `start-container.sh` from the `docker/scripts/` directory listing in the Container Infrastructure section, as the file no longer exists.

---

## 6. Justification

- The Hub provides a superset of inbox watcher functionality (monitoring, notification, plus policy engine and REST API). Keeping the standalone script creates confusion about which to use.
- Obsolete scripts accumulate maintenance debt and mislead developers about the active toolchain.
- The `;C` directories are visual clutter and could confuse filesystem operations.
- Removing stale artifacts keeps the repository clean and navigable.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `launch.sh` | Modify | Replace inbox watcher with Hub startup |
| `docker/scripts/inbox-watcher.py` | Delete | Absorbed by Hub |
| `docker/scripts/start-container.sh` | Delete | Superseded by launch.sh |
| `docker/scripts/debug-mcp.sh` | Delete | One-off debug script |
| `docker/scripts/test-proxy-reliability.sh` | Delete | One-off test script |
| `docker/scripts/__pycache__/` | Delete | Stale bytecode cache |
| `.inbox-watcher.log` | Delete | Stale log file |
| 8 `;C` directories | Delete | Empty path corruption artifacts |
| `CLAUDE.md` | Modify | Remove deleted file reference |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| CLAUDE.md | Modify | Remove `start-container.sh` from directory tree |

### 7.3 Other Impacts

None. The `mcp_proxy.py` script remains in place (actively used by Docker image). MCP server start scripts remain in place.

---

## 8. Testing Summary

- Verify `launch.sh` starts the Hub when not running (health check succeeds after startup)
- Verify `launch.sh` skips Hub startup when already running
- Verify single-agent mode still works end-to-end
- Verify multi-agent mode launches Hub instead of inbox watcher
- Verify no broken references to deleted files remain in tracked files

---

## 9. Implementation Plan

| Step | Description |
|------|-------------|
| 1 | Delete obsolete files from `docker/scripts/` |
| 2 | Delete `;C` directories and `.inbox-watcher.log` |
| 3 | Update `launch.sh`: replace `start_inbox_watcher()` with `ensure_hub()` |
| 4 | Update `CLAUDE.md`: remove `start-container.sh` reference |
| 5 | Test launch.sh in single-agent and multi-agent modes |

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Delete obsolete files: `inbox-watcher.py`, `start-container.sh`, `debug-mcp.sh`, `test-proxy-reliability.sh`, `__pycache__/` | Deleted all 5 items from `docker/scripts/`. Directory now contains only `mcp_proxy.py`, `start-mcp-server.sh`, `start-git-mcp.sh`. | Pass | claude - 2026-02-07 |
| EI-2 | Delete `;C` directories (8) and `.inbox-watcher.log` | Deleted 8 empty `;C` directories and `.inbox-watcher.log`. Verified with `find` — none remain. | Pass | claude - 2026-02-07 |
| EI-3 | Update `launch.sh`: replace `start_inbox_watcher()` with `ensure_hub()`, remove `.inbox-watcher.pid` handling, update cleanup messages | Replaced `start_inbox_watcher()` with `ensure_hub()` using curl health check against `:9000/api/health`. Added Hub as step 3/4. Updated multi-agent summary (Hub URL instead of Inbox Watcher terminal). Updated post-session cleanup to include `.agent-hub.pid`. Updated header comment. | Pass | claude - 2026-02-07 |
| EI-4 | Update `CLAUDE.md`: remove `start-container.sh` from directory tree | Replaced `start-container.sh` entry with `mcp_proxy.py`. Also fixed `start-git_mcp.sh` typo to `start-git-mcp.sh` (matching actual filename). | Pass | claude - 2026-02-07 |
| EI-5 | Test: verify Hub starts via launch.sh, verify skip when already running, verify no broken references to deleted files | **Hub start:** Started via `python -m agent_hub.cli start`, health check returned `{"status":"ok"}`, `/api/status` showed all 7 agents as STOPPED. **Skip test:** Second health check returned HTTP 200, confirming `ensure_hub()` would skip. **Broken references:** Grep across all non-archive, non-session tracked files found only two "Ported from" provenance comments in Hub source — no functional references. Fixed stale references discovered in `docker/README.md` (inbox watcher troubleshooting) and `docker/CONTAINER-GUIDE.md` (start-container.sh section). | Pass | claude - 2026-02-07 |
| EI-6 | UAT: end-to-end multi-agent launch and Hub integration | **Test 1 (multi-agent launch):** `./launch.sh claude qa` — both containers started, MCP connected, agents self-identified correctly. **Pass.** **Test 2 (Hub status):** `/api/status` showed both agents STOPPED despite running containers. **Fail.** Root cause: Hub starts before containers (step 3 vs step 4); `_discover_running_containers()` runs once at startup, never re-scans. **Test 3 (notification injection):** No tmux notification in QA terminal when CR routed. **Fail.** Root cause: Hub believed QA was STOPPED, so notification injection was skipped. | Fail | Lead - 2026-02-07 |
| EI-7 | Fix Hub container state sync: add `_container_sync_loop` and `_hub_managed` tracking | Added `_container_sync_loop()` to `hub.py` — polls Docker every 10 seconds, reconciles Hub state with container reality. Added `_hub_managed` set to track containers the Hub started; `stop()` only kills Hub-managed containers (not externally-started ones). Reinstalled agent-hub package. | Pass | claude - 2026-02-07 |
| EI-8 | Re-test: verify sync loop detects containers and notification injection works | Started Hub, then launched `./launch.sh claude qa`. Within 10 seconds, `/api/status` showed both agents as `running`. Logs confirmed `Sync: discovered running container for claude` and `Sync: discovered running container for qa`. Routed CR for QA review — tmux notification appeared in QA terminal. Both original failures resolved. | Pass | Lead - 2026-02-07 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| EI-5 discovered stale references in `docker/README.md` and `docker/CONTAINER-GUIDE.md` — fixed as part of testing. These files were not in the original scope but contained functional references to deleted files. | claude - 2026-02-07 |
| EI-6 UAT revealed Hub doesn't detect containers started after Hub startup. Root cause: launch.sh starts Hub (step 3) before containers (step 4), and the one-time `_discover_running_containers()` scan finds nothing. Fix implemented in EI-7, verified in EI-8. | claude - 2026-02-07 |

---

## 11. Execution Summary

All EIs complete (6 pass, 1 fail-then-fix, 1 re-test pass). Deleted 5 obsolete scripts, 8 path corruption artifacts, and 1 stale log. Replaced `start_inbox_watcher()` with `ensure_hub()` in `launch.sh`. Updated `CLAUDE.md` directory listing. Fixed stale references in `docker/README.md` and `docker/CONTAINER-GUIDE.md`. UAT revealed Hub container state sync gap — fixed by adding `_container_sync_loop` (10s Docker polling) and `_hub_managed` set (prevents Hub from killing externally-started containers). Re-test confirmed both original UAT failures resolved.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-060:** Agent Hub genesis — core infrastructure

---

**END OF DOCUMENT**
