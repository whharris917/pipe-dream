---
title: Container Git Authentication via GitHub CLI
revision_summary: Initial draft
---

# CR-053: Container Git Authentication via GitHub CLI

## 1. Purpose

Enable git push operations from the Docker container environment by implementing GitHub CLI (`gh`) authentication with a scoped Personal Access Token (PAT). This is a prerequisite for productive container-based development sessions.

---

## 2. Scope

### 2.1 Context

Container sessions cannot currently push to GitHub. The host uses Git Credential Manager (Windows) with HTTPS, which stores tokens in the Windows Credential Manager—inaccessible from Linux containers. This CR implements the recommended approach based on research into Anthropic's security guidance and Docker best practices.

- **Parent Document:** None (infrastructure prerequisite identified during container readiness assessment)

### 2.2 Changes Summary

Configure the Docker container to authenticate git operations via GitHub CLI using a scoped Personal Access Token, following security best practices that keep credentials minimal and revocable.

### 2.3 Files Affected

- `docker/Dockerfile` - Install GitHub CLI, add configuration
- `docker/docker-compose.yml` - Add environment variable for PAT
- `docker/entrypoint.sh` - Add `gh` authentication initialization
- `docker/README.md` - Document PAT setup and security considerations
- `CLAUDE.md` - Update container documentation section

---

## 3. Current State

The Docker container environment cannot perform git push operations. The host authenticates via Git Credential Manager (Windows), which stores credentials in the Windows Credential Manager. This credential store is inaccessible from within the Linux container. SSH keys do not exist on the host system.

---

## 4. Proposed State

The Docker container authenticates git operations via GitHub CLI (`gh`) using a scoped Personal Access Token passed as an environment variable. The token is:
- Scoped to only the required repositories (pipe-dream, flow-state, qms-cli)
- Stored outside the container image (in `.env` file or environment)
- Easily revocable if the container is compromised

Git operations (clone, fetch, push) work seamlessly within container sessions.

---

## 5. Change Description

### 5.1 Authentication Architecture

Following Anthropic's security guidance that "sensitive credentials should never be inside the sandbox," this implementation:

1. **Keeps credentials minimal:** Uses a scoped PAT rather than full SSH keys
2. **Keeps credentials external:** Token is passed via environment variable, not baked into image
3. **Enables easy revocation:** If container is compromised, token can be revoked without regenerating SSH keys

```
┌─────────────────────────────────────────────────────────────────┐
│ Host Machine                                                     │
│                                                                  │
│  .env file (gitignored)                                         │
│  ┌─────────────────────────────┐                                │
│  │ GH_TOKEN=ghp_xxxx...        │                                │
│  └─────────────────────────────┘                                │
│              │                                                   │
│              │ docker-compose reads                              │
│              ▼                                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Container                                                    ││
│  │                                                              ││
│  │  GH_TOKEN env var ──► gh auth ──► git credential helper     ││
│  │                                                              ││
│  │  git push ──► gh (credential helper) ──► GitHub API         ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 GitHub CLI Configuration

The `gh` CLI, when authenticated, configures itself as a git credential helper:

```bash
# Authentication (in entrypoint.sh)
echo "$GH_TOKEN" | gh auth login --with-token

# Verify credential helper is configured
gh auth setup-git
```

After this, all git HTTPS operations automatically use `gh` for authentication.

### 5.3 Token Scope Requirements

The PAT should be created with minimal required scopes:

| Scope | Purpose |
|-------|---------|
| `repo` | Full control of private repositories (required for push) |

Optional scopes if needed later:
- `read:org` - If repos are in an organization
- `workflow` - If modifying GitHub Actions workflows

### 5.4 Dockerfile Changes

```dockerfile
# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*
```

### 5.5 Entrypoint Changes

```bash
# Configure GitHub CLI if token provided
if [ -n "$GH_TOKEN" ]; then
    echo "Configuring GitHub CLI..."
    echo "$GH_TOKEN" | gh auth login --with-token 2>/dev/null
    gh auth setup-git 2>/dev/null
    echo "GitHub CLI configured"
fi
```

### 5.6 Docker Compose Changes

```yaml
services:
  claude-agent:
    environment:
      - GH_TOKEN=${GH_TOKEN}  # From .env file
```

---

## 6. Justification

- **Problem:** Container sessions cannot push to GitHub, blocking effective CR execution for code changes
- **Impact of not making this change:** Claude cannot operate productively from within the container; the user's goal of running Claude "in the container for good" cannot be achieved
- **Why this solution:**
  - Aligns with Anthropic's security philosophy (minimal, external, revocable credentials)
  - Recommended by Docker/DevContainer best practices
  - Simpler than SSH key management
  - Works through firewalls (HTTPS on port 443)

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `docker/Dockerfile` | Modify | Add GitHub CLI installation |
| `docker/docker-compose.yml` | Modify | Add GH_TOKEN environment variable |
| `docker/entrypoint.sh` | Modify | Add gh authentication initialization |
| `docker/README.md` | Modify | Document PAT setup and security |
| `docker/.env.example` | Create | Template for environment variables |
| `CLAUDE.md` | Modify | Update container section |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | Infrastructure change only |

### 7.3 Other Impacts

- **Security:** Introduces a credential (PAT) that must be managed securely
- **User action required:** User must create a GitHub PAT and add to `.env` file
- **Revocation procedure:** If container compromised, revoke PAT at github.com/settings/tokens

---

## 8. Testing Summary

1. **Token authentication:** Verify `gh auth status` shows authenticated
2. **Credential helper:** Verify `gh auth setup-git` configures git
3. **Clone operation:** Clone a private repo into `/projects/`
4. **Push operation:** Make a test commit and push to a branch
5. **No token scenario:** Verify graceful handling when GH_TOKEN is not set

---

## 9. Implementation Plan

### 9.1 Phase 1: PAT Creation (User Action)

1. User creates GitHub PAT at github.com/settings/tokens
2. Scope: `repo` (full control of private repositories)
3. Expiration: User's discretion (recommend 90 days with rotation)
4. User saves token securely

### 9.2 Phase 2: Dockerfile Update

1. Add GitHub CLI installation to Dockerfile
2. Rebuild container image

### 9.3 Phase 3: Entrypoint Update

1. Add conditional gh authentication to entrypoint.sh
2. Add git credential helper setup

### 9.4 Phase 4: Docker Compose Update

1. Add GH_TOKEN environment variable
2. Create `.env.example` template
3. User creates `.env` with their token

### 9.5 Phase 5: Documentation

1. Update `docker/README.md` with PAT setup instructions
2. Add security considerations and revocation procedure
3. Update `CLAUDE.md` container section

### 9.6 Phase 6: Verification

1. Start fresh container session
2. Verify `gh auth status` shows authenticated
3. Clone flow-state into `/projects/`
4. Create test branch, make change, push
5. Verify push succeeds
6. Clean up test branch

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | User creates GitHub PAT with `repo` scope | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Update Dockerfile to install GitHub CLI | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Update entrypoint.sh with gh auth initialization | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Update docker-compose.yml with GH_TOKEN env var | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Create docker/.env.example template | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | User creates docker/.env with PAT | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Rebuild container image | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-8 | Verify gh auth status in container | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-9 | Test: Clone repo into /projects/ | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-10 | Test: Push to test branch | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-11 | Update docker/README.md | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-12 | Update CLAUDE.md container section | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-13 | Clean up test branch | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

---

## 11. Execution Summary

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-052:** Zero-friction container session startup (predecessor)
- **External:** [Anthropic - Claude Code Sandboxing](https://www.anthropic.com/engineering/claude-code-sandboxing)
- **External:** [GitHub CLI Documentation](https://cli.github.com/manual/)
- **External:** [VS Code - Sharing Git Credentials with Containers](https://code.visualstudio.com/remote/advancedcontainers/sharing-git-credentials)

---

**END OF DOCUMENT**
