---
title: Container Agent Permissions and State Persistence
revision_summary: Initial draft
---

# CR-059: Container Agent Permissions and State Persistence

## 1. Purpose

Containerized agents currently lack pre-configured tool permissions, forcing the operator to manually approve every action (MCP calls, Bash commands, etc.) at each session start. This CR adds a shared permission allow list to the container project-level settings and preserves agent project state across container restarts, eliminating repetitive approval prompts and enabling agents to accumulate experience.

---

## 2. Scope

### 2.1 Context

Independent improvement identified during Session-2026-02-07-001. Investigation revealed that the container settings overlay (`docker/.claude-settings.json`) contains only MCP server enablement — no `permissions` block. Additionally, the container entrypoint wipes the `projects/` directory and `history.jsonl` on every startup, destroying accumulated per-project state. The `projects/` wipe was introduced during CR-056 debugging as part of a broad state-clearing strategy to resolve MCP connectivity issues, but is not related to MCP reliability (which was resolved by the stdio proxy and surgical jq cleaning of MCP-specific fields).

- **Parent Document:** None

### 2.2 Changes Summary

1. Add a comprehensive permissions block (allow and deny lists) to `docker/.claude-settings.json`
2. Remove `projects/` directory and `history.jsonl` wipes from `docker/entrypoint.sh`

### 2.3 Files Affected

- `docker/.claude-settings.json` — Add `permissions` block with allow/deny lists for all container agents
- `docker/entrypoint.sh` — Remove `rm -rf /claude-config/projects` and `rm -f /claude-config/history.jsonl`

---

## 3. Current State

The container settings overlay (`docker/.claude-settings.json`) contains only MCP server enablement:

```json
{
  "enabledMcpjsonServers": ["qms", "git"]
}
```

No `permissions` block exists. Each agent's user-scoped config (`.claude/users/{agent}/container/.claude.json`) has an empty `allowedTools` array. Every tool invocation in a containerized session triggers an interactive approval prompt.

The container entrypoint (`docker/entrypoint.sh`) wipes `/claude-config/projects` and `/claude-config/history.jsonl` on every startup. This destroys per-project memory, conversation history, and any interactively-approved permissions that Claude Code stores in the `projects/` directory.

---

## 4. Proposed State

The container settings overlay contains a permissions block that pre-authorizes common operations for all container agents: shell utilities, git commands, all QMS MCP tools, the git MCP tool, and web search. Deny rules prevent direct writes to QMS-controlled paths. Agents can begin working immediately without manual approval prompts for standard operations.

The container entrypoint preserves `/claude-config/projects` and `/claude-config/history.jsonl` across restarts, allowing agents to accumulate per-project memory and command history. All other ephemeral state cleaning (cache, debug, telemetry, backups, update locks) and the surgical jq MCP state cleaning are retained.

---

## 5. Change Description

### 5.1 Permission Allow List (`docker/.claude-settings.json`)

The file is mounted read-only into containers as `/pipe-dream/.claude/settings.local.json` (the Local scope in Claude Code's permission hierarchy). Local scope takes precedence over Project and User scopes, so these rules apply to all agents regardless of their individual user-scoped config.

**Allow list categories:**

| Category | Rules | Rationale |
|----------|-------|-----------|
| Shell utilities | `ls`, `cat`, `head`, `tail`, `wc`, `sort`, `diff`, `grep`, `find`, `pwd`, `echo` | Read-only exploration of the codebase |
| Python | `python`, `python3`, `pip show` | Script execution and package inspection |
| Git (read) | `git status`, `git log`, `git diff`, `git show`, `git branch` | Repository inspection |
| Git (write) | `git fetch`, `git checkout`, `git pull`, `git add`, `git commit`, `git push` | Standard development workflow |
| GitHub CLI | `gh` | PR creation, issue management, CI status |
| Utilities | `jq`, `tmux` | JSON processing, terminal multiplexing |
| MCP — QMS | All `mcp__qms__qms_*` tools (17 tools) | Full QMS operations |
| MCP — Git | `mcp__git__git_exec` | Host-side git operations via MCP |
| Web | `WebSearch`, `WebFetch(domain:docs.anthropic.com)` | Research capability |
| Updates | `Update(**)` | File update operations |

**Deny list:**

| Rule | Rationale |
|------|-----------|
| `Edit(QMS/**)`, `Write(QMS/**)` | QMS documents must flow through QMS CLI |
| `Edit(**/QMS/**)`, `Write(**/QMS/**)` | Catch nested path variants |

**Permission scope behavior (confirmed via documentation):**

- Pre-configured rules in `settings.local.json` are read-only policy — Claude Code never writes to this file
- When agents interactively approve additional tools, the approval writes to the user-scoped config (`/claude-config/.claude.json` → `projects["/pipe-dream"].allowedTools`)
- Bash and MCP approvals persist permanently per project; file edit approvals are session-scoped only

### 5.2 Entrypoint State Preservation (`docker/entrypoint.sh`)

**Remove these two lines:**

```bash
rm -rf /claude-config/projects 2>/dev/null
rm -f /claude-config/history.jsonl 2>/dev/null
```

**Retain all other cleanup:**

| Retained cleanup | Purpose |
|-----------------|---------|
| `rm -rf /claude-config/cache` | Ephemeral cache, no value across sessions |
| `rm -rf /claude-config/session-env` | Session environment state |
| `rm -rf /claude-config/debug` | Debug logs |
| `rm -rf /claude-config/telemetry` | Telemetry state |
| `rm -f /claude-config/.claude.json.backup.*` | Accumulated backup files |
| `rm -f /claude-config/.update.lock` | Stale lock files |
| jq MCP state cleaning | Prevents stale MCP config from conflicting with project-level `.mcp.json` |

**Risk assessment:** The `projects/` wipe was part of the broad debugging effort during CR-056. The actual MCP reliability fix was the stdio proxy (`mcp_proxy.py`) and the jq surgical cleaning of MCP-specific fields in `.claude.json`. The `projects/` directory contains per-project memory and conversation state — not MCP configuration. Removing this wipe is low-risk and the jq cleaning (which is retained) provides the targeted MCP state hygiene that was actually needed.

---

## 6. Justification

- **Problem:** Every containerized agent session requires 10+ manual approval clicks before the agent can perform basic operations. This creates operator friction and slows multi-agent workflows significantly.
- **Impact of not making this change:** Continued manual approval overhead for every container session, and loss of agent experience (memory, history) on every restart.
- **How the solution addresses root cause:** Pre-configured permissions eliminate prompts for known-safe operations. Preserving `projects/` allows agents to build on previous sessions' context.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `docker/.claude-settings.json` | Modify | Add `permissions` block with allow/deny lists |
| `docker/entrypoint.sh` | Modify | Remove `projects/` and `history.jsonl` wipes |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | — | No controlled documents affected |

### 7.3 Other Impacts

- All containerized agent sessions will inherit the new permission allow list on next container start (no image rebuild required — file is bind-mounted)
- Agents that have been run previously will retain their `projects/` directories going forward (existing data in `.claude/users/{agent}/container/projects/` is preserved)

---

## 8. Testing Summary

Testing will be performed by launching a containerized agent session and verifying:

1. MCP servers (QMS and Git) connect successfully on initial launch
2. QMS MCP tools execute without permission prompts (e.g., `qms_inbox`, `qms_status`)
3. Git MCP tool executes without permission prompts (e.g., `git_exec("status")`)
4. Bash commands in the allow list execute without prompts (e.g., `ls`, `git log`)
5. Deny rules are enforced (direct writes to `QMS/` paths are blocked)
6. Agent `projects/` directory and `history.jsonl` persist across container restart
7. MCP connectivity remains reliable after removing the `projects/` wipe (i.e., jq cleaning alone is sufficient)

---

## 9. Implementation Plan

### 9.1 Modify Container Settings

1. Add `permissions` block to `docker/.claude-settings.json` with allow and deny lists per Section 5.1

### 9.2 Modify Entrypoint

1. Remove `rm -rf /claude-config/projects` line from `docker/entrypoint.sh`
2. Remove `rm -f /claude-config/history.jsonl` line from `docker/entrypoint.sh`
3. Update the echo message to reflect the reduced scope of cleanup

### 9.3 Testing

1. Start MCP servers on host
2. Launch a containerized agent session
3. Verify MCP connectivity on first launch
4. Test QMS MCP operations without permission prompts
5. Test Git MCP operations without permission prompts
6. Test Bash commands without permission prompts
7. Test deny rules (attempt direct QMS write)
8. Stop and restart the container
9. Verify `projects/` directory persists
10. Verify MCP connectivity after restart (jq cleaning is sufficient)

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Modify `docker/.claude-settings.json`: add permissions block per Section 5.1 | Added `permissions` block with 51 allow rules (shell utilities, Python, git, gh, jq, tmux, all QMS MCP tools, git MCP tool, WebSearch, WebFetch, Update) and 4 deny rules (Edit/Write to QMS paths). File is bind-mounted read-only, so changes take effect on next container start without image rebuild. | Pass | claude - 2026-02-07 |
| EI-2 | Modify `docker/entrypoint.sh`: remove `projects/` and `history.jsonl` wipes per Section 5.2; update echo message | Removed `rm -rf /claude-config/projects` and `rm -f /claude-config/history.jsonl`. Updated comments and echo messages to reflect reduced cleanup scope. Added CR-059 reference in comment for traceability. Note: entrypoint is baked into Docker image; requires `docker-compose build --no-cache` to take effect. | Pass | claude - 2026-02-07 |
| EI-3 | Launch containerized session and verify MCP connectivity on first startup | MCP servers (QMS and Git) connected successfully on first container launch after EI-1/EI-2 changes. Confirmed by successful execution of MCP tools in EI-4. | Pass | lead - 2026-02-07 |
| EI-4 | Verify QMS and Git MCP tools execute without permission prompts | `qms_inbox`, `qms_status`, and `git_exec` all executed without prompts. | Pass | lead - 2026-02-07 |
| EI-5 | Verify Bash allow list commands execute without prompts | 16 commands tested across 5 categories (shell utilities, Python, git read, gh, jq). All passed without prompts. Three minor pattern gaps found: `diff`, `pip show`, and `git -C <path> log` still prompted. Root cause: deprecated `:*` suffix syntax and `git -C` flag insertion breaking subcommand pattern matching. See Execution Comments. | Pass | lead - 2026-02-07 |
| EI-6 | Verify deny rules block direct writes to QMS paths | Bash redirect (`echo >>`) and Edit tool both correctly blocked by deny rules when targeting `QMS/SOP/SOP-001.md`. | Pass | lead - 2026-02-07 |
| EI-7 | Stop container, restart, verify `projects/` persists and MCP connects successfully | First attempt failed: entrypoint changes not yet in image (baked, not mounted). Image rebuild with `--no-cache` in progress. Retest pending. | [Pending] | [PERFORMER] - [DATE] |
| EI-8 | Commit changes to main branch | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| EI-5 findings: Three Bash patterns prompted despite being in allow list. (1) `Bash(diff:*)` — deprecated `:*` syntax may not match in all cases; consider `Bash(diff *)`. (2) `Bash(pip show:*)` — same syntax issue. (3) `Bash(git -C <path> log)` — the `-C` flag between `git` and the subcommand breaks pattern matching for `Bash(git log:*)`. These are minor pattern-matching gaps, not structural failures. Will fix patterns after EI-7 retest. | claude - 2026-02-07 |
| EI-7 first attempt: `projects/` was still wiped on container restart because `docker/entrypoint.sh` is baked into the Docker image, not bind-mounted. The `.claude-settings.json` permissions worked immediately (bind-mounted) but entrypoint changes require `docker-compose build --no-cache`. Image rebuild initiated. | claude - 2026-02-07 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution
- **CR-056:** Multi-Agent Container Infrastructure (introduced the entrypoint state cleaning)
- **Claude Code Permissions Docs:** https://code.claude.com/docs/en/permissions
- **Claude Code Settings Docs:** https://code.claude.com/docs/en/settings

---

**END OF DOCUMENT**
