---
title: Implement RS validation code changes (SC-001, SC-002, CC-001 through CC-011)
revision_summary: Initial draft
---

# CR-034: Implement RS validation code changes (SC-001, SC-002, CC-001 through CC-011)

## 1. Purpose

This CR implements the code changes identified during the comprehensive RS validation review (Session-2026-01-24-001). The changes align the QMS CLI codebase with the revised SDLC-QMS-RS requirements, including structural changes to the user group model, SDLC namespace architecture, and 11 discrete code modifications to ensure code-to-requirement accuracy.

---

## 2. Scope

### 2.1 Context

The RS validation review performed in Session-2026-01-19-004 identified 7 inaccurate requirements, 2 implementation gaps, and 8 missing requirements. The subsequent discussion in Session-2026-01-24-001 finalized the requirement revisions and catalogued the corresponding code changes needed to achieve alignment.

**RS Revision (Out of Scope):** The SDLC-QMS-RS requirement revisions have already been applied under CR-028, which is released and remains in execution. This CR (CR-034) covers only the code implementation changes needed to align the codebase with the revised requirements.

- **Parent Document:** CR-028 (RS revision under execution)

### 2.2 Changes Summary

Two structural changes (SC-001, SC-002) and eleven code changes (CC-001 through CC-011) implementing:
- User group restructuring with hierarchical permissions
- SDLC namespace dynamic registration architecture
- Permission model corrections and enforcement
- Workflow gate implementations
- Template and prompt system fixes

### 2.3 Files Affected

- `qms-cli/qms_config.py` - SC-001, CC-002, CC-004, CC-005
- `qms-cli/qms_auth.py` - SC-001, CC-001, CC-003
- `qms-cli/qms_paths.py` - CC-005, CC-007
- `qms-cli/qms_schema.py` - CC-005, CC-007
- `qms-cli/qms_meta.py` - CC-009
- `qms-cli/commands/route.py` - CC-003, CC-009, CC-010
- `qms-cli/commands/assign.py` - CC-003
- `qms-cli/commands/create.py` - CC-007, CC-008
- `qms-cli/commands/namespace.py` - CC-006 (new file)
- `qms-cli/prompts.py` - CC-011
- `qms-cli/qms.py` - CC-006 (register namespace command)

---

## 3. Current State

1. User groups are named "initiators", "qa", "reviewers" (plural, three groups)
2. Cross-initiator exception allows any initiator to act on other initiators' documents
3. Quality group has route permission (dead code due to owner_only check)
4. No assignment validation for workflow type compatibility
5. DOCUMENT_TYPES contains obsolete entries (CAPA, DS, CS, OQ, QMS-RS, QMS-RTM)
6. SDLC namespaces are hardcoded in qms_paths.py and qms_schema.py
7. TP uses singular ID format (CR-001-TP instead of CR-001-TP-001)
8. TEMPLATE allows sequential fallback when --name is omitted
9. No approval gate checking review outcomes or quality participation
10. No retirement version check (version < 1.0 can be retired)
11. Prompt custom_header and custom_footer fields are loaded but not rendered

---

## 4. Proposed State

1. User groups are "administrator", "initiator", "quality", "reviewer" (singular, four groups with hierarchy)
2. Owner-only restrictions are strictly enforced (no cross-initiator exception)
3. Quality group does not have route permission
4. Assignment validation ensures assignees can complete the workflow action
5. DOCUMENT_TYPES contains only: SOP, CR, INV, TP, ER, VAR, RS, RTM, TEMPLATE
6. SDLC namespaces are dynamically registered via `qms namespace add` command
7. TP uses sequential ID format (CR-001-TP-001, CR-001-TP-002)
8. TEMPLATE requires --name argument (error if omitted)
9. Approval routing blocked unless all reviews recommend AND at least one quality review exists
10. Retirement routing blocked for documents with version < 1.0
11. Prompt custom_header and custom_footer are rendered in output

---

## 5. Change Description

### 5.1 SC-001: User Group Restructuring

Restructure USER_GROUPS with hierarchical model:

| Old Group | New Group | Members | Notes |
|-----------|-----------|---------|-------|
| initiators | administrator | lead, claude | Inherits initiator + fix |
| (new) | initiator | (empty) | Reserved for future |
| qa | quality | qa | Renamed to singular |
| reviewers | reviewer | tu_ui, tu_scene, tu_sketch, tu_sim, bu | Renamed |

Update PERMISSIONS to reference new group names. Administrator inherits all initiator permissions plus `fix`.

### 5.2 SC-002: SDLC Namespace Architecture

Replace hardcoded SDLC namespace handling with dynamic registry:

| Current State | New State |
|---------------|-----------|
| SDLC-FLOW and SDLC-QMS hardcoded in qms_paths.py | Dynamic lookup from SDLC_NAMESPACES registry |
| Adding namespace requires editing source files | `qms namespace add <NAME>` command |
| DS, CS, OQ as separate document types | Removed (obsolete) |
| QMS-RS, QMS-RTM as separate types | RS/RTM available per registered namespace |

Implementation via:
- CC-004: Remove obsolete document types
- CC-005: Add SDLC_NAMESPACES registry and dynamic lookup
- CC-006: Implement `namespace add` command

### 5.3 CC-001: Remove Cross-Initiator Exception

Remove lines 86-88 in `qms_auth.py`:
```python
if user_group == "initiators" and doc_owner in USER_GROUPS.get("initiators", set()):
    pass  # Allow initiators to act on each other's documents
```

Owner-only restrictions now strictly enforced per REQ-SEC-003.

### 5.4 CC-002: Remove Quality from Route Permission

Change PERMISSIONS["route"] from `["initiators", "qa"]` to `["administrator", "initiator"]`. Quality cannot route (and never could due to owner_only).

### 5.5 CC-003: Add Assignment Validation

In `assign.py` and `route.py --assign` handling, validate:
- Review workflows: assignees must be in administrator, initiator, quality, or reviewer
- Approval workflows: assignees must be in quality or reviewer

Reject with clear error if assignee's group is incompatible.

### 5.6 CC-004: Remove Obsolete Document Types

Remove from DOCUMENT_TYPES:
- CAPA (EI type, not standalone)
- DS, CS, OQ (obsolete SDLC types)
- QMS-RS, QMS-RTM (replaced by dynamic namespace)

### 5.7 CC-005: Implement SDLC Namespace Registry

Add SDLC_NAMESPACES set to qms_config.py (initially `{"FLOW", "QMS"}`).

Refactor `qms_paths.py:get_doc_type()` to dynamically match `SDLC-{NAMESPACE}-{TYPE}` pattern.

Refactor `qms_schema.py:DOC_ID_PATTERNS` to generate patterns from namespace registry.

### 5.8 CC-006: Implement Namespace Add Command

Create `commands/namespace.py` with `qms namespace add <NAME>` command:
1. Validate namespace name (uppercase alphanumeric)
2. Add to SDLC_NAMESPACES registry
3. Create QMS/SDLC-{NAME}/ directory structure
4. Persist to configuration

### 5.9 CC-007: Make TP Sequential

Update TP ID generation from singular (CR-001-TP) to sequential (CR-001-TP-001).
- Modify `create.py` TP ID generation
- Update `qms_paths.py` pattern matching
- Update `qms_schema.py` regex pattern

### 5.10 CC-008: Make TEMPLATE --name Required

In `create.py`, when doc_type == "TEMPLATE":
- Require --name argument
- Remove sequential fallback
- Return error: "TEMPLATE documents require --name argument"

### 5.11 CC-009: Implement Approval Gate

In `qms_meta.py`:
- Store review outcomes with reviewer identity in metadata

In `route.py` when --approval:
- Query review outcomes from metadata
- Reject if any outcome is UPDATES_REQUIRED
- Reject if no quality group member has reviewed
- Permit only if all reviews are RECOMMEND and quality participated

### 5.12 CC-010: Implement Retirement Version Check

In `route.py` when --retire:
- Check document version from metadata
- If major version < 1, reject: "Cannot retire document that was never effective (version < 1.0)"

### 5.13 CC-011: Implement Custom Header/Footer Rendering

In `prompts.py`:
- If custom_header present, render before main content
- If custom_footer present, render after main content

---

## 6. Justification

- **Accuracy:** Aligns codebase with revised RS requirements validated by multi-agent review
- **Security:** Removes undocumented cross-initiator exception; enforces strict owner-only
- **Integrity:** Implements approval gate ensuring quality oversight before approval
- **Maintainability:** Replaces hardcoded SDLC namespaces with dynamic registration
- **Consistency:** Eliminates special cases (TP singular ID, TEMPLATE sequential fallback)

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_config.py` | Modify | Groups, permissions, doc types, namespace registry |
| `qms-cli/qms_auth.py` | Modify | Remove cross-initiator exception, update group refs |
| `qms-cli/qms_paths.py` | Modify | Dynamic namespace lookup, TP pattern |
| `qms-cli/qms_schema.py` | Modify | Dynamic patterns, TP regex |
| `qms-cli/qms_meta.py` | Modify | Store review outcomes with identity |
| `qms-cli/commands/route.py` | Modify | Assignment validation, approval gate, retirement check |
| `qms-cli/commands/assign.py` | Modify | Assignment validation |
| `qms-cli/commands/create.py` | Modify | TP sequential, TEMPLATE --name required |
| `qms-cli/commands/namespace.py` | Create | New namespace add command |
| `qms-cli/prompts.py` | Modify | Render custom_header/footer |
| `qms-cli/qms.py` | Modify | Register namespace subcommand |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Out of Scope | Requirements updated under CR-028 (released, in execution) |

### 7.3 Other Impacts

- Existing tests must be updated for new group names
- Any hardcoded "initiators"/"qa"/"reviewers" references must be updated

---

## 8. Testing Summary

All tests will use the existing test patterns in `qms-cli/tests/` which create isolated temporary QMS directory structures. No modifications to the real QMS.

- Test SC-001: Verify new group names resolve correctly
- Test CC-001: Verify owner-only is strictly enforced (initiator cannot act on other's doc)
- Test CC-002: Verify quality cannot route (should already fail due to owner_only)
- Test CC-003: Verify assignment rejects incompatible groups
- Test CC-004: Verify obsolete types are rejected
- Test CC-005/006: Verify namespace add creates structure and enables RS/RTM
- Test CC-007: Verify TP generates sequential IDs
- Test CC-008: Verify TEMPLATE without --name is rejected
- Test CC-009: Verify approval blocked without quality review or with updates-requested
- Test CC-010: Verify retirement blocked for version < 1.0
- Test CC-011: Verify custom_header/footer appear in prompt output

---

## 9. Implementation Plan

### 9.1 Phase 1: Group Restructuring (SC-001)

1. Update USER_GROUPS in qms_config.py with new names and hierarchy
2. Update PERMISSIONS to use new group names
3. Update qms_auth.py to handle administrator inheritance
4. Update all group name references throughout codebase
5. Run existing tests, fix any failures from group name changes

### 9.2 Phase 2: Permission Model Fixes (CC-001, CC-002, CC-003)

1. Remove cross-initiator exception in qms_auth.py
2. Remove quality from route permission
3. Add assignment validation in assign.py and route.py
4. Add tests for strict owner-only enforcement
5. Add tests for assignment validation

### 9.3 Phase 3: Document Type Cleanup (CC-004, CC-007, CC-008)

1. Remove obsolete document types from DOCUMENT_TYPES
2. Update TP ID generation to sequential
3. Make TEMPLATE --name required
4. Update related patterns in qms_paths.py and qms_schema.py
5. Add tests for new behaviors

### 9.4 Phase 4: SDLC Namespace Architecture (CC-005, CC-006)

1. Add SDLC_NAMESPACES registry to qms_config.py
2. Refactor qms_paths.py for dynamic namespace lookup
3. Refactor qms_schema.py for dynamic patterns
4. Create namespace.py with add command
5. Register namespace subcommand in qms.py
6. Add tests for namespace registration

### 9.5 Phase 5: Workflow Gate Implementation (CC-009, CC-010)

1. Update qms_meta.py to store review outcomes with identity
2. Implement approval gate in route.py
3. Implement retirement version check in route.py
4. Add tests for approval gate (quality requirement, outcome check)
5. Add tests for retirement version check

### 9.6 Phase 6: Prompt System Fix (CC-011)

1. Update prompts.py to render custom_header/footer
2. Add tests for header/footer rendering

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Phase 1: Group Restructuring (SC-001) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Phase 2: Permission Model Fixes (CC-001, CC-002, CC-003) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Phase 3: Document Type Cleanup (CC-004, CC-007, CC-008) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Phase 4: SDLC Namespace Architecture (CC-005, CC-006) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Phase 5: Workflow Gate Implementation (CC-009, CC-010) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Phase 6: Prompt System Fix (CC-011) | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Run full test suite, verify all tests pass | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

---

## 11. Execution Summary

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SDLC-QMS-RS:** QMS CLI Requirements Specification (revised)
- **Session-2026-01-19-004:** RS Validation Review (multi-agent)
- **Session-2026-01-24-001:** RS Validation Discussion and Working Copy

---

**END OF DOCUMENT**
