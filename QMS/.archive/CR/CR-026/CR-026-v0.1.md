---
title: QMS CLI Extensibility Refactoring
revision_summary: Initial draft
---

# CR-026: QMS CLI Extensibility Refactoring

## 1. Purpose

Refactor the QMS CLI architecture to make it easy to add, modify, and remove commands; change the workflow state machine; and customize stage-gate prompts per document type and workflow phase. Also fix missing imports that CR-025's tests failed to catch.

---

## 2. Scope

### 2.1 Context

Follow-on improvement to CR-025 (QMS CLI modularization). CR-025 reduced qms.py from 2743 to 206 lines but left qms_commands.py at 1826 lines with hardcoded workflow logic and prompts. This CR addresses the remaining architectural debt.

- **Parent Document:** CR-025 (Refactor QMS CLI with Test Coverage)

### 2.2 Changes Summary

- Create self-registering command pattern (eliminates 3-file changes to add command)
- Create data-driven workflow engine (centralizes state machine logic)
- Create prompt registry (enables per-doc-type, per-workflow prompts)
- Create command context abstraction (eliminates boilerplate)
- Decompose qms_commands.py into individual command files
- Add robust import verification tests

### 2.3 Files Affected

- `qms-cli/qms_commands.py` - Fix imports, then decompose into commands/
- `qms-cli/qms.py` - Refactor to use CommandRegistry
- `qms-cli/qms_templates.py` - Refactor to use PromptRegistry
- `qms-cli/qms_config.py` - Add ExecutionPhase enum
- `qms-cli/workflow.py` - NEW: WorkflowEngine
- `qms-cli/prompts.py` - NEW: PromptRegistry
- `qms-cli/context.py` - NEW: CommandContext
- `qms-cli/registry.py` - NEW: CommandRegistry
- `qms-cli/commands/*.py` - NEW: 21 individual command files
- `qms-cli/tests/test_imports.py` - NEW: Import verification tests
- `qms-cli/tests/test_workflow.py` - NEW: Workflow engine tests
- `qms-cli/tests/test_prompts.py` - NEW: Prompt registry tests

---

## 3. Current State

`qms_commands.py` is an 1826-line monolith containing 21 commands with extensive boilerplate duplication. Adding a command requires 3 file changes. Workflow logic is hardcoded across multiple commands with magic strings. Stage-gate prompts are identical for all document types and workflow phases. Tests pass despite missing imports (sys, USERS_ROOT).

---

## 4. Proposed State

Commands are self-registering via decorators in individual files under `commands/`. Workflow logic is centralized in a declarative `WorkflowEngine`. Prompts are configurable per document type and workflow phase via `PromptRegistry`. Common command boilerplate is handled by `CommandContext`. All imports are verified by automated tests.

---

## 5. Change Description

### 5.1 Command Registry (Self-Registration)

Decorator-based pattern that allows single-file command definition:

```python
@CommandRegistry.register(
    name="create",
    help="Create a new document",
    arguments=[{"flags": ["type"], "help": "Document type"}],
    permission="create"
)
def cmd_create(ctx: CommandContext) -> int:
    # No boilerplate - auth/permission handled by registry
```

### 5.2 Workflow Engine (Data-Driven State Machine)

Centralize all transitions in declarative data structure:

```python
TRANSITIONS = [
    StatusTransition("DRAFT", "IN_REVIEW", WorkflowType.REVIEW, action="route"),
    StatusTransition("IN_APPROVAL", "APPROVED", action="approve", version_bump="major"),
    # All transitions in one place
]
```

### 5.3 Prompt Registry (Configurable Prompts)

Registry for per-doc-type, per-workflow prompts:

```python
PromptRegistry.register_prompt(
    task_type="REVIEW",
    workflow_type="POST_REVIEW",
    doc_type="CR",
    config=PromptConfig(checklist_items=[...], critical_reminders=[...])
)
```

### 5.4 Command Context (Boilerplate Elimination)

Encapsulate common operations:

```python
def cmd_review(ctx: CommandContext) -> int:
    ctx.require_status(REVIEW_STATUSES)
    ctx.require_assignment()
    # Actual command logic
```

---

## 6. Justification

- **Maintainability:** 1826-line monolith is hard to navigate and modify
- **Extensibility:** Adding commands currently requires 3 file changes
- **Configurability:** Hardcoded prompts cannot be customized per document type
- **Testability:** Current tests failed to catch missing imports
- **Consistency:** Workflow logic scattered across commands leads to bugs

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_commands.py` | Delete | Decomposed into commands/ directory |
| `qms-cli/qms.py` | Modify | Use CommandRegistry for dispatch |
| `qms-cli/qms_templates.py` | Modify | Use PromptRegistry |
| `qms-cli/qms_config.py` | Modify | Add ExecutionPhase enum |
| `qms-cli/workflow.py` | Create | WorkflowEngine class |
| `qms-cli/prompts.py` | Create | PromptRegistry class |
| `qms-cli/context.py` | Create | CommandContext class |
| `qms-cli/registry.py` | Create | CommandRegistry class |
| `qms-cli/commands/*.py` | Create | 21 individual command files |
| `qms-cli/tests/test_imports.py` | Create | Import verification tests |
| `qms-cli/tests/test_workflow.py` | Create | Workflow engine tests |
| `qms-cli/tests/test_prompts.py` | Create | Prompt registry tests |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No QMS documents affected |

### 7.3 Other Impacts

None. Internal refactoring only; CLI interface and behavior remain unchanged.

---

## 8. Testing Summary

- **Import tests:** Parameterized tests verify all modules import cleanly
- **Workflow tests:** State machine transitions validated
- **Prompt tests:** Prompt generation verified
- **Command tests:** Each command callable and returns expected result
- **Integration tests:** Full workflows exercised end-to-end
- **CLI smoke test:** Basic commands verified working

---

## 9. Implementation Plan

### 9.1 Phase 0: Fix Critical Bugs + Import Tests

1. Add missing imports to qms_commands.py (sys, USERS_ROOT, etc.)
2. Create test_imports.py with parameterized import verification tests
3. Run tests - verify import tests now pass

### 9.2 Phase 1: Workflow Engine

4. Create workflow.py with WorkflowEngine class and declarative transitions
5. Create test_workflow.py with state machine tests
6. Refactor cmd_route to use WorkflowEngine (validate behavior unchanged)
7. Refactor cmd_assign, cmd_review, cmd_approve to use WorkflowEngine

### 9.3 Phase 2: Prompt Registry

8. Create prompts.py with PromptRegistry and default configs
9. Create test_prompts.py
10. Refactor qms_templates.py to use PromptRegistry
11. Add doc_type parameter to task generation functions

### 9.4 Phase 3: Command Context

12. Create context.py with CommandContext class
13. Add helper methods (require_status, require_assignment, etc.)
14. Refactor 3 simple commands to use CommandContext as proof of concept

### 9.5 Phase 4: Command Registry + Decomposition

15. Create registry.py with CommandRegistry class
16. Create commands/ directory and migrate 3 simple commands
17. Migrate remaining 18 commands to individual files
18. Update qms.py to use CommandRegistry
19. Delete qms_commands.py

### 9.6 Phase 5: Test Coverage Enhancement

20. Add command execution tests (test each command is callable)
21. Add integration tests for key workflows
22. Final comprehensive test run

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add missing imports to qms_commands.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Create test_imports.py with parameterized tests | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Run tests - verify import tests pass | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Create workflow.py with WorkflowEngine | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-5 | Create test_workflow.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-6 | Refactor cmd_route to use WorkflowEngine | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-7 | Refactor cmd_assign, cmd_review, cmd_approve | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-8 | Create prompts.py with PromptRegistry | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-9 | Create test_prompts.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-10 | Refactor qms_templates.py to use PromptRegistry | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-11 | Add doc_type parameter to task generation | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-12 | Create context.py with CommandContext | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-13 | Add helper methods to CommandContext | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-14 | Refactor 3 commands to use CommandContext | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-15 | Create registry.py with CommandRegistry | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-16 | Create commands/ and migrate 3 commands | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-17 | Migrate remaining 18 commands | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-18 | Update qms.py to use CommandRegistry | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-19 | Delete qms_commands.py | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-20 | Add command execution tests | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-21 | Add integration tests for workflows | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-22 | Final comprehensive test run | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-025:** Refactor QMS CLI with Test Coverage (parent)

---

**END OF DOCUMENT**
