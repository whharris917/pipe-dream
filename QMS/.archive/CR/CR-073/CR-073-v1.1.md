---
title: Transport-Based Identity Resolution (Phase 1)
revision_summary: Execution complete. All 6 EIs pass. 378/378 tests, CI verified.
  RS v9.0 and RTM v11.0 EFFECTIVE. PR
---

# CR-073: Transport-Based Identity Resolution (Phase 1)

## 1. Purpose

Implement transport-enforced identity resolution for the QMS MCP server. Container agents currently self-declare their identity via the `user` parameter -- any agent can claim to be any other agent. This CR adds a `resolve_identity()` function that reads identity from HTTP headers (set by infrastructure the agent cannot control) when the caller is a container, and falls back to the `user` parameter for host-side stdio transport.

---

## 2. Scope

### 2.1 Context

Independent improvement identified during Session-2026-02-09-006 design exploration. SOP-007 prohibits impersonation but the system has no technical enforcement. This is Phase 1 of a 5-phase identity management plan.

- **Parent Document:** None

### 2.2 Changes Summary

- Proxy injects `X-QMS-Identity` header from `QMS_USER` environment variable
- MCP server resolves identity from HTTP headers (enforced) or user parameter (trusted fallback)
- All 20 MCP tools receive transport context for identity resolution

### 2.3 Files Affected

- `agent-hub/docker/scripts/mcp_proxy.py` -- Inject X-QMS-Identity header from QMS_USER env var
- `qms-cli/qms_mcp/server.py` -- Add resolve_identity() function, KNOWN_AGENTS set, new imports
- `qms-cli/qms_mcp/tools.py` -- Add ctx: Context to all 20 tools, route through resolve_identity()

---

## 3. Current State

The QMS MCP server accepts a `user` parameter on every tool call. The server trusts this parameter unconditionally regardless of transport. Any container agent can pass `user="qa"` and the system treats the request as coming from QA. There is no technical enforcement of identity -- only the procedural prohibition in SOP-007.

---

## 4. Proposed State

The MCP server resolves caller identity based on transport type. For HTTP requests (containers), identity is read from the `X-QMS-Identity` header, which is injected by the stdio-to-HTTP proxy from an environment variable set at container creation time. The agent cannot forge this header. For stdio requests (host), the existing `user` parameter is trusted as before. The system degrades gracefully -- if the header is missing, it falls back to the user parameter with a warning.

---

## 5. Change Description

### 5.1 Proxy Header Injection (mcp_proxy.py)

In `build_headers()`, after building headers from CLI args, read `QMS_USER` from the environment and inject it as `X-QMS-Identity`. Add a startup log line confirming the injected identity. Add `import os` to the imports.

The proxy is the last piece of container-controlled infrastructure before requests leave for the host. The header is set once at startup and applied to every request automatically. The agent process cannot modify the proxy's already-read environment variable.

### 5.2 Identity Resolution (server.py)

Add a `resolve_identity(ctx, user_param)` function that:

1. Attempts to extract the Starlette `Request` from `ctx.request_context.request`
2. If HTTP transport: reads `x-qms-identity` header. If present, uses it (enforced mode). Logs a warning if the header identity differs from the user parameter, or if the identity is not in `KNOWN_AGENTS`.
3. If HTTP transport but no header: logs a warning and falls through to fallback.
4. If stdio transport (no request context): uses the `user_param` as-is (trusted mode).

The `KNOWN_AGENTS` set contains: `lead`, `claude`, `qa`, `bu`, `tu_ui`, `tu_scene`, `tu_sketch`, `tu_sim`.

The `ctx.request_context.request` chain is verified against MCP SDK v1.26.0:
- `streamable_http.py:264` -> `ServerMessageMetadata(request_context=request)`
- `lowlevel/server.py:733` -> `request_data = message.message_metadata.request_context`
- `lowlevel/server.py:757` -> `RequestContext(request=request_data)`
- `fastmcp/server.py:337-340` -> `Context(request_context=...)`

For stdio transport, `request_context` is `None`, so the function falls through to the user parameter.

### 5.3 Tool Signature Updates (tools.py)

All 20 tools gain a `ctx: Context` parameter (FastMCP auto-injects this). The `resolve_identity` function is passed into `register_tools()` as an additional closure argument (Option A from the plan -- avoids circular imports).

For the 16 tools with a `user` parameter: `resolve_identity(ctx, user)` replaces the raw `user`.
For the 4 tools without a `user` parameter (status, read, history, comments): `resolve_identity(ctx)` is called and the result is passed to `run_qms_command(..., user=resolved)`.

---

## 6. Justification

- SOP-007 prohibits impersonation but has no technical enforcement. Any container agent can claim any identity.
- Container isolation is meaningless for access control if identity is self-declared.
- This is the foundation for the full 5-phase identity management plan. Later phases (collision prevention, Git MCP access control, SOP updates) depend on enforced identity being available.
- The fallback to user parameter for stdio preserves business continuity -- host-mode operation is unchanged.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/docker/scripts/mcp_proxy.py` | Modify | Add `import os`, inject X-QMS-Identity header, add startup log |
| `qms-cli/qms_mcp/server.py` | Modify | Add imports, KNOWN_AGENTS, resolve_identity(), update register_tools() call |
| `qms-cli/qms_mcp/tools.py` | Modify | Add Context import, update register_tools() signature, add ctx param to all 20 tools |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Modify | Add requirement for transport-based identity resolution |
| SDLC-QMS-RTM | Modify | Add verification evidence for new requirement |

### 7.3 Other Impacts

- Docker image must be rebuilt after mcp_proxy.py changes (`docker-compose build --no-cache`)
- Container orchestration must set `QMS_USER` environment variable at creation time (already planned for ContainerManager in later phases; manual override via docker-compose for now)

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development follows established controls:

1. **Test environment isolation:** Development in a non-QMS-controlled directory (e.g., `.test-env/`)
2. **Branch isolation:** All development on branch `cr-073-identity-resolution`
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new/modified requirements must have passing tests before merge
5. **CI verification:** Tests must pass on GitHub Actions for dev branch
6. **PR gate:** Changes merge to main only via PR after RS/RTM approval
7. **Submodule update:** Parent repo updates pointer only after PR merge

### 7.5 Qualified State Continuity

| Phase | main branch | RS/RTM Status | Qualified Release |
|-------|-------------|---------------|-------------------|
| Before CR | Current commit | EFFECTIVE v8.0 / v10.0 | QMS-10.0 |
| During execution | Unchanged | DRAFT (checked out) | QMS-10.0 (unchanged) |
| Post-approval | Merged from cr-073-identity-resolution | EFFECTIVE v9.0 / v11.0 | QMS-11.0 |

---

## 8. Testing Summary

- Host stdio: verify all MCP tools work identically to today (user parameter trusted)
- HTTP with X-QMS-Identity header: verify header overrides user parameter
- HTTP with mismatched header/param: verify warning logged, header wins
- HTTP without header: verify warning logged, falls back to user parameter
- Unknown agent in header: verify warning logged, identity still used

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Create `.test-env/qms-cli/` working directory
2. Clone qms-cli from GitHub
3. Create and checkout branch `cr-073-identity-resolution`
4. Verify clean test environment

### 9.2 Phase 2: Requirements (RS Update)

1. Checkout SDLC-QMS-RS in production QMS
2. Add requirement for transport-based identity resolution
3. Checkin RS, route for review and approval

### 9.3 Phase 3: Implementation

1. Modify `mcp_proxy.py` -- add `import os`, inject X-QMS-Identity in `build_headers()`, add startup log
2. Modify `server.py` -- add imports, KNOWN_AGENTS, resolve_identity(), update register_tools() call
3. Modify `tools.py` -- add Context import, update signature, add ctx to all 20 tools
4. Test locally
5. Commit to dev branch

### 9.4 Phase 4: Qualification

1. Add tests for resolve_identity() (stdio fallback, HTTP enforced, mismatch warning, missing header)
2. Run full test suite, verify all tests pass
3. Push to dev branch
4. Verify GitHub Actions CI passes
5. Document qualified commit hash

### 9.5 Phase 5: RTM Update and Approval

1. Checkout SDLC-QMS-RTM in production QMS
2. Add verification evidence referencing CI-verified commit
3. Checkin RTM, route for review and approval
4. **Verify RTM reaches EFFECTIVE status before proceeding to Phase 6**

### 9.6 Phase 6: Merge and Submodule Update

**Prerequisite:** RS and RTM must both be EFFECTIVE before proceeding (per SOP-006 Section 7.4).

1. Verify RS is EFFECTIVE (document status check)
2. Verify RTM is EFFECTIVE (document status check)
3. Create PR to merge dev branch to main
4. Merge PR
5. Update submodule pointer in parent repo
6. Copy mcp_proxy.py changes to parent repo (not in submodule)
7. Verify functionality in production context

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Test environment setup (Phase 1) | Cloned qms-cli to `.test-env/qms-cli/`, updated to latest main (32324af), created branch `cr-073-identity-resolution`. 369 tests pass. | Pass | claude - 2026-02-10 |
| EI-2 | RS update and approval (Phase 2) | Added REQ-MCP-015 to SDLC-QMS-RS. Updated Section 5.4 authentication exclusion note. QA reviewed and approved. RS now EFFECTIVE v9.0. | Pass | claude - 2026-02-10 |
| EI-3 | Implementation (Phase 3) | Modified server.py: added imports, KNOWN_AGENTS set, resolve_identity(), updated register_tools() call. Rewrote tools.py: all 20 tools with ctx: Context and resolve_identity(). Modified mcp_proxy.py: added import os, X-QMS-Identity injection, startup log. Commit 3127deb. | Pass | claude - 2026-02-10 |
| EI-4 | Qualification (Phase 4) | Added 9 new tests for REQ-MCP-015: stdio default/custom, HTTP header enforced/override/missing, unknown agent, KNOWN_AGENTS, error fallback, end-to-end tool resolution. Updated 7 existing tests for new register_tools() signature. 378/378 pass. CI: run 21878115349. Commit d2ad514. | Pass | claude - 2026-02-10 |
| EI-5 | RTM update and approval (Phase 5) | Added REQ-MCP-015 to summary matrix and detail section. Updated qualified baseline to d2ad514 (378/378). Updated RS ref to v9.0, scope to 105 reqs. Fixed Unicode arrow. Updated Section 5.14 title per QA. RTM now EFFECTIVE v11.0. | Pass | claude - 2026-02-10 |
| EI-6 | Merge and submodule update (Phase 6) | PR #9 merged to main (cce8f2f). CI passed on merge commit. Submodule pointer updated. mcp_proxy.py modified in parent repo. | Pass | claude - 2026-02-10 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| mcp_proxy.py is in parent repo, not qms-cli submodule. Modified directly in pipe-dream. Docker image rebuild required to pick up change. | claude - 2026-02-10 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 6 execution items completed as planned. Transport-based identity resolution implemented across 3 files (server.py, tools.py, mcp_proxy.py). 9 new qualification tests added, 7 existing tests updated. Full suite 378/378 passing with CI verification. RS v9.0 and RTM v11.0 both EFFECTIVE. Changes merged to main via PR #9.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-007:** Agent Orchestration Protocol
- **SDLC-QMS-RS:** QMS CLI Requirements Specification (v9.0)
- **SDLC-QMS-RTM:** QMS CLI Requirements Traceability Matrix (v11.0)
- **Session-2026-02-09-006:** Identity management design exploration (5-phase plan)

---

**END OF DOCUMENT**
