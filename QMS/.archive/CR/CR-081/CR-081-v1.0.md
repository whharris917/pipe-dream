---
title: Fix tmux default terminal dimensions
revision_summary: Initial draft
---

# CR-081: Fix tmux default terminal dimensions

## 1. Purpose

Fix the initial terminal dimension mismatch where tmux sessions start at 80x24 (the default), causing Claude Code to render tables and TUI elements at 80 columns until the GUI sends its first resize event. This produces visually misaligned content during the first moments of terminal display.

---

## 2. Scope

### 2.1 Context

Identified during CR-080 (terminal scrollback fix) execution. When observing agent terminal output in the GUI, content rendered before the first resize event arrives appears misaligned because tmux defaults to 80x24 while the GUI terminal is typically 120-180 columns wide.

- **Parent Document:** None (independent improvement discovered during CR-080)

### 2.2 Changes Summary

1. Add configurable default terminal dimensions to Hub configuration
2. Pass those dimensions to `tmux new-session` via `-x`/`-y` flags
3. Send actual GUI terminal dimensions immediately upon WebSocket subscription

### 2.3 Files Affected

- `agent-hub/agent_hub/config.py` — Add `default_terminal_cols` and `default_terminal_rows` settings
- `agent-hub/agent_hub/container.py` — Pass dimensions to `tmux new-session -x -y`
- `agent-hub/gui/src/hooks/useHubConnection.ts` — Send resize on `subscribed` message

---

## 3. Current State

The `_exec_claude()` method in `container.py:279` creates a tmux session with no dimension flags:

```python
cmd=["tmux", "new-session", "-d", "-s", "agent", "claude"]
```

tmux defaults to 80x24. Claude Code queries the PTY for dimensions, renders at 80 columns, and writes that content to the PTY buffer. The GUI terminal (typically 120-180 columns wide) receives this 80-column content via the scrollback buffer on subscription. The GUI then sends a resize event after `fitAddon.fit()` runs on the next animation frame (16-50ms delay), but content already rendered at 80 columns remains misaligned.

---

## 4. Proposed State

tmux sessions start at configurable default dimensions (120x30). The GUI sends its actual terminal dimensions to the Hub immediately upon subscription confirmation. The combination ensures that:

1. Initial content renders at a reasonable width (120 cols) even without a GUI connected
2. The GUI's actual dimensions are applied as soon as the subscription is established, minimizing the window of mismatch

---

## 5. Change Description

### 5.1 Backend: Configurable Default Dimensions

Add two fields to `HubConfig`:

```python
default_terminal_cols: int = 120
default_terminal_rows: int = 30
```

These are passed through from `ContainerManager` to the `tmux new-session` command. The values 120x30 are a reasonable default that fits most TUI table layouts without being so large that content overflows smaller terminals.

### 5.2 Backend: tmux Session Creation

Modify `_exec_claude()` in `container.py` to include the dimension flags:

```python
cmd=["tmux", "new-session", "-d", "-s", "agent",
     "-x", str(cols), "-y", str(rows), "claude"]
```

The `ContainerManager` receives the config at construction and extracts the default dimensions.

### 5.3 Frontend: Immediate Resize on Subscribe

In `useHubConnection.ts`, the `subscribed` message handler sends the terminal's current dimensions immediately after processing the buffer:

```typescript
case "subscribed": {
  const term = this.terminals.get(msg.agent_id);
  if (term && msg.buffer) {
    this.muteInput.add(msg.agent_id);
    term.write(stripTerminalModes(base64ToBytes(msg.buffer)), () => {
      this.muteInput.delete(msg.agent_id);
    });
  }
  // Sync actual GUI dimensions with the container PTY
  if (term) {
    this.sendResize(msg.agent_id, term.cols, term.rows);
  }
  break;
}
```

This ensures the Hub receives the GUI's actual dimensions as part of the subscription flow, rather than waiting for `fitAddon.fit()` to trigger `onResize` on the next animation frame.

---

## 6. Justification

- **Problem:** Agent TUI tables and content render at 80 columns initially, then reflow when the GUI resize arrives. This creates visual jank and misaligned content in the scrollback buffer.
- **Impact of not making this change:** Every new terminal tab displays misaligned content until the first resize propagates. Previously-rendered content in the scrollback buffer remains permanently misaligned.
- **Root cause addressed:** The fix addresses both the initialization gap (tmux defaults) and the propagation delay (GUI resize timing).

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/agent_hub/config.py` | Modify | Add `default_terminal_cols` and `default_terminal_rows` |
| `agent-hub/agent_hub/container.py` | Modify | Pass dimensions to tmux new-session |
| `agent-hub/gui/src/hooks/useHubConnection.ts` | Modify | Send resize on subscribed message |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | — | No controlled documents affected |

### 7.3 Other Impacts

None. The Hub backend and GUI frontend are not under SDLC governance. No RS/RTM updates required.

---

## 8. Testing Summary

- Manual verification: Start an agent via the GUI and observe that initial terminal content renders at the correct width without visible reflow jank
- Verify that the resize message appears in Hub logs immediately after subscription
- Verify that tmux session dimensions match the GUI terminal dimensions after subscription

---

## 9. Implementation Plan

| Step | Description |
|------|-------------|
| 1 | Add default terminal dimension fields to `HubConfig` |
| 2 | Modify `ContainerManager` to accept and pass dimensions to `_exec_claude()` |
| 3 | Modify `_exec_claude()` to include `-x`/`-y` flags in tmux command |
| 4 | Modify `useHubConnection.ts` to send resize on `subscribed` message |
| 5 | Manual verification with running agent |

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add `default_terminal_cols` and `default_terminal_rows` to `HubConfig` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-2 | Pass config dimensions to `tmux new-session` via `-x`/`-y` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-3 | Send resize on `subscribed` message in `useHubConnection.ts` | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |
| EI-4 | Manual verification with running agent | [SUMMARY] | [Pass/Fail] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| [COMMENT] | [PERFORMER] - [DATE] |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

[EXECUTION_SUMMARY]

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-080:** Terminal scrollback support (where this issue was identified)

---

**END OF DOCUMENT**
