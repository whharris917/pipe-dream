---
title: Agent Hub Genesis - Core Infrastructure
revision_summary: Execution results documented for all 8 EIs
---

# CR-060: Agent Hub Genesis - Core Infrastructure

## 1. Purpose

Create the foundational infrastructure for the Agent Hub — a Python service that manages Docker container lifecycle for QMS agents, provides agent state discovery, enforces launch/shutdown policies, and absorbs inbox watcher functionality. This is the genesis work for what will eventually become a standalone system adopted into QMS governance.

---

## 2. Scope

### 2.1 Context

The multi-agent container infrastructure (CR-056 through CR-059) is operational at Rung 3: `launch.sh` + tmux + inbox-watcher.py + stdio proxy. The Hub (Rung 4) replaces the bash orchestration with a programmable Python service, enabling agent state discovery, policy-driven lifecycle management, and a foundation for the future GUI (Rung 5).

- **Parent Document:** None (genesis work)

### 2.2 Changes Summary

Create a new `agent-hub/` directory containing a Python package that:
1. Manages Docker container lifecycle (start/stop agents)
2. Tracks and exposes agent state (which agents are running, inbox counts)
3. Watches agent inboxes and triggers notifications (absorbs `inbox-watcher.py`)
4. Enforces configurable launch/shutdown policies
5. Exposes a REST API for state queries and lifecycle control
6. Provides a CLI for manual operations

### 2.3 Files Affected

- `agent-hub/` (new directory) - All Hub source code
- `agent-hub/pyproject.toml` - Project configuration and dependencies
- `agent-hub/agent_hub/` - Python package source
- `agent-hub/agent_hub/hub.py` - Core Hub orchestrator class
- `agent-hub/agent_hub/models.py` - Pydantic data models
- `agent-hub/agent_hub/config.py` - Configuration
- `agent-hub/agent_hub/container.py` - Docker container management
- `agent-hub/agent_hub/inbox.py` - Inbox watcher (ported from `docker/scripts/inbox-watcher.py`)
- `agent-hub/agent_hub/notifier.py` - tmux notification injection
- `agent-hub/agent_hub/policy.py` - Launch/shutdown policy engine
- `agent-hub/agent_hub/api/` - FastAPI REST API
- `agent-hub/agent_hub/cli.py` - Click CLI

---

## 3. Current State

Multi-agent orchestration is managed by `launch.sh`, a bash script that starts MCP servers, builds Docker images, launches containers with `docker run`, and opens terminal windows. Inbox watching is a separate standalone process (`docker/scripts/inbox-watcher.py`). There is no programmatic way to query which agents are running, and no policy-driven lifecycle management. Agent state is opaque — the orchestrator must manually inspect Docker containers to determine deployment state.

---

## 4. Proposed State

A Python service (`agent-hub`) manages container lifecycle, tracks agent state, watches inboxes, and enforces policies. Any client (the orchestrating agent, a future GUI, or the CLI) can query `GET /api/agents` to discover which agents are running and what their inbox counts are. Launch and shutdown policies (manual, auto-on-task, always-on, idle-timeout) allow the system to self-coordinate: routing a document to QA can automatically start QA's container if configured.

---

## 5. Change Description

### 5.1 Project Structure

```
agent-hub/
├── pyproject.toml
├── agent_hub/
│   ├── __init__.py
│   ├── __main__.py          # CLI entry point
│   ├── cli.py               # Click CLI commands
│   ├── hub.py               # Core Hub class (orchestrates all components)
│   ├── models.py            # Pydantic models (Agent, AgentState, policies)
│   ├── config.py            # HubConfig (pydantic-settings)
│   ├── container.py         # Docker container lifecycle (start/stop/health)
│   ├── inbox.py             # Inbox watcher (ported from inbox-watcher.py)
│   ├── notifier.py          # tmux send-keys notification injection
│   ├── policy.py            # Policy engine (launch/shutdown rules)
│   └── api/
│       ├── __init__.py
│       ├── server.py        # FastAPI app factory
│       └── routes.py        # REST endpoints
└── tests/
    └── (deferred to adoption CR)
```

### 5.2 Data Models

Agent state lifecycle:

```
STOPPED → STARTING → RUNNING → STOPPING → STOPPED
                         ↓
                       ERROR
```

Launch policies:
- **MANUAL:** Only start on explicit API/CLI request
- **AUTO_ON_TASK:** Start when inbox has tasks; inject notification
- **ALWAYS_ON:** Start with Hub; never auto-stop

Shutdown policies:
- **MANUAL:** Only stop on explicit API/CLI request
- **ON_INBOX_EMPTY:** Stop when inbox empties (with cooldown)
- **IDLE_TIMEOUT:** Stop after configurable idle period

### 5.3 Container Management

The Hub replicates `launch.sh`'s container creation logic in Python using the Docker SDK (`docker` package). Key operations:

1. **Start:** `docker run -d` with SETUP_ONLY=1, wait for entrypoint completion, then `docker exec` to start claude via tmux
2. **Stop:** `docker stop` + `docker rm`
3. **Health:** Check container running state via Docker API

Volume mounts, environment variables, and the SETUP_ONLY two-phase startup pattern remain identical to `launch.sh`.

### 5.4 Inbox Watcher

Ported from `docker/scripts/inbox-watcher.py` into the Hub. Uses `watchdog` for file system monitoring. On inbox change:

1. Update agent's `inbox_count`
2. Evaluate launch policy (auto-start if AUTO_ON_TASK and agent is STOPPED)
3. Inject notification into running agent's tmux session (via `docker exec tmux send-keys`)

### 5.5 REST API

```
GET  /api/status               # Hub status, all agents, MCP health
GET  /api/agents               # List agents with state + inbox count
GET  /api/agents/{id}          # Agent details
POST /api/agents/{id}/start    # Start agent container
POST /api/agents/{id}/stop     # Stop agent container
GET  /api/agents/{id}/policy   # Get launch/shutdown policy
PUT  /api/agents/{id}/policy   # Set launch/shutdown policy
GET  /api/health               # Hub health check
```

### 5.6 CLI

```
agent-hub start                # Start Hub as foreground service
agent-hub status               # Show all agent states (queries API)
agent-hub start-agent {id}     # Start an agent (queries API)
agent-hub stop-agent {id}      # Stop an agent (queries API)
```

### 5.7 Scope Exclusions

The following are explicitly deferred to future work:

- **PTY multiplexing** (Hub Phase 3 in the design docs) — needed for GUI, not for core infrastructure
- **WebSocket API** — needed for GUI terminal streaming
- **GUI** (Rung 5) — separate genesis sandbox
- **MCP health monitoring** — nice to have, not core
- **Formal test suite** — deferred to the Adoption CR when SDLC governance applies
- **`qms message` command** — deferred

---

## 6. Justification

- **Agent state discovery:** The orchestrating agent currently has no way to know which sub-agents are running in containers. This prevents the hybrid orchestration model (spawn sub-agent vs. route to container) from working.
- **Policy-driven lifecycle:** Manual container management via bash scripts doesn't scale. Auto-launch on inbox task is the key enabler for autonomous multi-agent workflows.
- **Infrastructure consolidation:** `launch.sh` and `inbox-watcher.py` are separate bash/Python scripts with overlapping concerns. The Hub unifies them into a single, programmable service.
- **Foundation for GUI:** The Hub's API is the GUI's backend. Building the Hub first establishes the data model and API contract.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/` (entire directory) | Create | New Python package |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | Genesis work; no existing documents affected |

### 7.3 Other Impacts

- The Hub is a new, standalone system. It does not modify any existing infrastructure.
- `launch.sh` and `docker/scripts/inbox-watcher.py` continue to work as-is. The Hub is an alternative, not a replacement (until it proves itself).
- No changes to the Docker image, entrypoint, MCP proxy, or MCP servers.

---

## 8. Testing Summary

Since this is genesis sandbox work (no SDLC governance yet), testing is manual and exploratory:

1. Start Hub, verify it binds to port 9000
2. `agent-hub status` shows all agents as STOPPED
3. `agent-hub start-agent qa` starts a QA container
4. `GET /api/agents` shows qa as RUNNING with correct inbox count
5. Route a document to QA, verify inbox watcher detects the change and injects notification
6. `agent-hub stop-agent qa` stops and removes the container
7. Configure QA with AUTO_ON_TASK policy, route a document, verify auto-launch

---

## 9. Implementation Plan

This is genesis sandbox work. The implementation follows the Hub design phases from the orchestration refresh document, scoped to Phases 1, 2, and 5 (container manager, inbox watcher, policy engine), plus a minimal Phase 4 (API — REST only, no WebSocket).

| EI | Phase | Description |
|----|-------|-------------|
| EI-1 | Setup | Create `agent-hub/` project structure with pyproject.toml, models, config |
| EI-2 | Container | Implement container.py — start/stop containers using Docker SDK |
| EI-3 | Inbox | Implement inbox.py and notifier.py — port inbox-watcher.py logic |
| EI-4 | Policy | Implement policy.py — launch/shutdown policy evaluation |
| EI-5 | Hub Core | Implement hub.py — wire container, inbox, and policy together |
| EI-6 | API | Implement api/ — FastAPI REST endpoints |
| EI-7 | CLI | Implement cli.py — Click CLI commands |
| EI-8 | Integration | End-to-end test: start Hub, manage agents, verify inbox watcher + policies |

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Create project structure (pyproject.toml, models, config) | Created `agent-hub/` with pyproject.toml, `agent_hub/models.py` (Agent, AgentState, LaunchPolicy, ShutdownPolicy, AgentPolicy, AgentSummary, HubStatus), `agent_hub/config.py` (HubConfig with pydantic-settings), `__init__.py`, `__main__.py`. Package installs via `pip install -e .` | Pass | claude - 2026-02-07 |
| EI-2 | Implement container manager (Docker SDK lifecycle) | Created `agent_hub/container.py` using `docker` SDK. Replicates launch.sh's SETUP_ONLY two-phase startup: `docker run -d` with setup, wait for entrypoint completion, `docker exec` to start claude in tmux. Handles volume mounts, env vars, GH_TOKEN, agent definition overlay, Windows path resolution. | Pass | claude - 2026-02-07 |
| EI-3 | Implement inbox watcher and notifier (port from inbox-watcher.py) | Created `agent_hub/inbox.py` (watchdog-based file watcher with async callback bridge) and `agent_hub/notifier.py` (tmux send-keys injection via async subprocess). Ported notification text generation from `docker/scripts/inbox-watcher.py`. | Pass | claude - 2026-02-07 |
| EI-4 | Implement policy engine (launch/shutdown rules) | Created `agent_hub/policy.py` with `evaluate_launch()` and `evaluate_shutdown()` functions. Supports MANUAL/AUTO_ON_TASK/ALWAYS_ON launch policies and MANUAL/ON_INBOX_EMPTY/IDLE_TIMEOUT shutdown policies. Returns PolicyDecision with action and reason. | Pass | claude - 2026-02-07 |
| EI-5 | Implement Hub core (wire all components) | Created `agent_hub/hub.py` — AgentHub class orchestrates ContainerManager, InboxWatcher, and policy engine. Handles agent lifecycle, running container discovery, inbox change callbacks with auto-launch/notification/auto-stop, and idle check loop. Fixed idle check to only evaluate IDLE_TIMEOUT (not ON_INBOX_EMPTY). | Pass | claude - 2026-02-07 |
| EI-6 | Implement REST API (FastAPI endpoints) | Created `agent_hub/api/server.py` (app factory with lifespan) and `agent_hub/api/routes.py` (8 endpoints: health, status, agents list, agent detail, start, stop, get policy, set policy). All endpoints verified via curl. | Pass | claude - 2026-02-07 |
| EI-7 | Implement CLI (Click commands) | Created `agent_hub/cli.py` with 5 commands: `start` (Hub service), `status`, `start-agent`, `stop-agent`, `set-policy`. Entry point registered as `agent-hub` in pyproject.toml. All commands verified. | Pass | claude - 2026-02-07 |
| EI-8 | End-to-end integration test | Started Hub on :9000. Verified: health endpoint returns ok; `/api/agents` lists 7 agents as stopped; `start-agent qa` starts container (confirmed with `docker ps`); `status` shows qa running; `stop-agent qa` stops and removes container; policy set/get works via CLI. Hub correctly discovers and manages Docker containers. | Pass | claude - 2026-02-07 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| Fixed idle check loop to only evaluate IDLE_TIMEOUT shutdown policy, not ON_INBOX_EMPTY. ON_INBOX_EMPTY is correctly evaluated only in the inbox change handler. Without this fix, agents with ON_INBOX_EMPTY policy were auto-stopped by the periodic idle check when inbox was empty, even after manual start. | claude - 2026-02-07 |

---

## 11. Execution Summary

All 8 EIs passed. The Agent Hub genesis infrastructure is functional: a Python service (`agent-hub`) that manages Docker container lifecycle, tracks agent state via REST API, watches inboxes, and enforces launch/shutdown policies. The package installs cleanly, the CLI provides 5 commands, and the API exposes 8 endpoints. End-to-end testing confirmed container start/stop via both CLI and API, with Docker containers correctly created using the SETUP_ONLY two-phase startup pattern from launch.sh. One fix was applied during execution: the idle check loop was scoped to only evaluate IDLE_TIMEOUT policy, preventing unintended auto-stops from ON_INBOX_EMPTY during periodic checks.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-005:** Code Governance (Genesis Sandbox model, Section 7.2)
- **Session-2026-02-04-002:** Hub implementation plan (original design)
- **Session-2026-02-06-004:** Multi-agent orchestration refresh (revised design)
- **Session-2026-02-06-004:** Ouroboros Reactor vision (platform/engine separation)

---

**END OF DOCUMENT**
