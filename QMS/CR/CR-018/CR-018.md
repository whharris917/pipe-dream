---
title: QMS Document Rendition and Checkout Visibility
revision_summary: 'CR-018: Implement metadata injection and checkout placeholders'
---

<!--
================================================================================
QMS DOCUMENT STATUS
================================================================================
Document ID:     CR-018
Version:         2.0
Status:          CLOSED
Approval Date:   2026-01-08
================================================================================
-->

# CR-018: QMS Document Rendition and Checkout Visibility

## 1. Purpose

Improve QMS document visibility and prevent misleading content exposure by:
1. Injecting metadata (version, status, approval date) into viewable renditions
2. Replacing checked-out draft content with placeholders
3. Appending auto-generated revision history tables to documents

---

## 2. Scope

### 2.1 Context

- **Parent Document:** None (independent improvement identified from TO_DO_LIST.md and session discussions)

This CR addresses the "Metadata injection into viewable rendition of QMS documentation" item from the TO_DO_LIST and expands it to include checkout placeholder behavior.

### 2.2 Changes Summary

1. Distinguish between "source documents" (what users edit in workspace) and "viewable renditions" (what exists in QMS/)
2. When a document is checked out, replace QMS draft content with a placeholder message
3. When a document is checked in, inject metadata header and revision history into the viewable rendition
4. Update all state-changing commands to refresh injected metadata

### 2.3 Files Affected

- `.claude/qms.py` - Add helper functions; modify checkout, checkin, and state-change commands
- `.claude/qms_meta.py` - Add approval_date tracking

---

## 3. Current State

1. QMS documents contain only minimal frontmatter (title, revision_summary)
2. To see version/status, users must run `qms status DOC-ID`
3. When a document is checked out, the QMS draft shows stale content that may be superseded by workspace edits
4. No revision history is visible in documents without manual maintenance

---

## 4. Proposed State

1. QMS documents contain an injected metadata comment block showing Document ID, Version, Status, and Approval Date
2. When checked out, the QMS draft shows a placeholder message directing readers to the effective version
3. Documents include an auto-generated Revision History table at the end, built from the audit trail
4. Source documents (in workspace) remain clean with no injected content

---

## 5. Change Description

### 5.1 Conceptual Model: Source vs Rendition

| Aspect | Source Document | Viewable Rendition |
|--------|-----------------|-------------------|
| Location | `.claude/users/{user}/workspace/{DOC_ID}.md` | `QMS/{TYPE}/{DOC_ID}[-draft].md` |
| Purpose | What authors edit | What readers see |
| Frontmatter | Minimal (title, revision_summary) | Minimal + injected metadata header |
| Content | Full document body | Full body OR placeholder if checked out |
| Revision History | None | Auto-generated table at end |

### 5.2 Metadata Header Format

For checked-in or effective documents:

    <!--
    ================================================================================
    QMS DOCUMENT STATUS
    ================================================================================
    Document ID:     CR-015
    Version:         2.0
    Status:          CLOSED
    Approval Date:   2026-01-08
    ================================================================================
    -->

For checked-out documents:

    <!--
    ================================================================================
    DOCUMENT CHECKED OUT
    ================================================================================
    Document ID:     CR-015
    Version:         1.1
    Status:          DRAFT
    Checked Out By:  claude
    Checked Out On:  2026-01-08
    ================================================================================
    -->

### 5.3 Checkout Placeholder Body

When checked out, the document body is replaced with:

    > **This document is currently checked out for editing.**
    >
    > The document content is in the user's workspace and will become visible
    > when checked back in.
    >
    > **Checked out by:** claude
    > **Checked out on:** 2026-01-08
    >
    > To view the last approved version, use `qms read DOC-ID` which shows
    > the effective version by default.

### 5.4 Revision History Table

Appended to the end of each document:

    ---

    ## Revision History

    | Version | Date | Author | Summary |
    |---------|------|--------|---------|
    | 2.0 | 2026-01-08 | claude | CR-017: Description |
    | 1.0 | 2026-01-06 | claude | Initial release |

    *This revision history is automatically generated from the QMS audit trail.*

### 5.5 Helper Functions

| Function | Purpose |
|----------|---------|
| `build_qms_metadata_header()` | Generate metadata comment block |
| `build_checkout_placeholder()` | Generate placeholder body for checked-out docs |
| `strip_qms_metadata_header()` | Remove injected content (for clean workspace copy) |
| `strip_revision_history()` | Remove revision history section |
| `inject_qms_metadata_into_file()` | Write metadata + revision history to file |
| `build_revision_history_table()` | Generate revision history from audit trail |
| `get_archived_revision_summary()` | Extract revision_summary from archived versions |

---

## 6. Justification

- **Visibility:** Users can see document status at a glance without running separate commands
- **Accuracy:** Checked-out drafts no longer show potentially stale content
- **Traceability:** Revision history is automatically maintained from audit trail
- **Separation of Concerns:** Source documents remain clean; renditions are enhanced for readers

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `.claude/qms.py` | Modify | Add 7 helper functions; modify cmd_checkout, cmd_checkin, cmd_route, cmd_review, cmd_approve, cmd_release, cmd_close |
| `.claude/qms_meta.py` | Modify | Add approval_date field to update_meta_approval() |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| All QMS documents | Modify | Will have metadata headers injected on next state change |

### 7.3 Other Impacts

- Existing documents will not have metadata until they go through a state change (checkout/checkin, route, approve, etc.)
- This is acceptable as it provides a gradual rollout

---

## 8. Testing Summary

- Verify `qms checkout` replaces QMS draft with placeholder; workspace has full content
- Verify `qms checkin` restores QMS draft with full content + metadata header + revision history
- Verify `qms read` (checked out) shows placeholder
- Verify `qms approve` injects metadata into effective version
- Verify revision history table shows correct versions from audit trail
- Verify `qms status` still works (reads from .meta, not document)

---

## 9. Implementation Plan

### 9.1 Phase 1: Add Helper Functions

1. Add constants `QMS_METADATA_MARKER` and `QMS_CHECKOUT_MARKER`
2. Implement `build_qms_metadata_header()`
3. Implement `build_checkout_placeholder()`
4. Implement `strip_qms_metadata_header()`
5. Implement `strip_revision_history()`

### 9.2 Phase 2: Add Revision History Functions

1. Implement `build_revision_history_table()`
2. Implement `get_archived_revision_summary()`
3. Implement `inject_qms_metadata_into_file()` which combines all injection

### 9.3 Phase 3: Modify cmd_checkout

1. Save clean content before updating meta
2. Write placeholder to QMS draft
3. Copy clean content to workspace

### 9.4 Phase 4: Modify cmd_checkin

1. Strip any injected content from workspace
2. Write to QMS draft
3. Inject metadata header and revision history

### 9.5 Phase 5: Update State-Changing Commands

1. Add refresh call after each status change in: cmd_route, cmd_review, cmd_approve, cmd_release, cmd_close

### 9.6 Phase 6: Add approval_date Tracking

1. Modify `update_meta_approval()` to set approval_date on APPROVED/EFFECTIVE/CLOSED transitions

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add helper functions (metadata header, placeholder, stripping) | Added constants and 6 helper functions to qms.py: build_qms_metadata_header(), build_checkout_placeholder(), strip_qms_metadata_header(), strip_revision_history(), strip_injected_content(), write_checkout_placeholder() | Pass | claude - 2026-01-08 |
| EI-2 | Add revision history functions | Added get_archived_revision_summary(), build_revision_history_table(), inject_qms_metadata_into_file() to qms.py | Pass | claude - 2026-01-08 |
| EI-3 | Modify cmd_checkout for placeholder behavior | Modified cmd_checkout to strip injected content before copying to workspace, write placeholder to QMS draft | Pass | claude - 2026-01-08 |
| EI-4 | Modify cmd_checkin to inject metadata + revision history | Modified cmd_checkin to strip injected content from workspace, inject metadata header and revision history into QMS draft | Pass | claude - 2026-01-08 |
| EI-5 | Update state-changing commands (route, review, approve, release, close) | Added inject_qms_metadata_into_file() calls to cmd_route, cmd_review, cmd_approve, cmd_release, cmd_close | Pass | claude - 2026-01-08 |
| EI-6 | Add approval_date tracking to .meta | Modified update_meta_approval() in qms_meta.py to set approval_date for APPROVED/EFFECTIVE/PRE_APPROVED/POST_APPROVED/CLOSED states | Pass | claude - 2026-01-08 |
| EI-7 | Test all scenarios | Tested checkout placeholder, checkin metadata injection, route refresh, approval EFFECTIVE transition. All tests passed. SOP-001 tested through full workflow to v14.0 EFFECTIVE showing approval_date. | Pass | claude - 2026-01-08 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| Testing was inadvertently performed on SOP-001 (effective document). Document completed full review cycle to restore to EFFECTIVE status at v14.0. Lesson learned: use test documents for future CR testing. | claude - 2026-01-08 |
| Bug found during post-review: strip_revision_history() was too aggressive, stripping example code blocks containing revision history patterns. Fixed by searching backwards from auto-generation notice and limiting distance. | claude - 2026-01-08 |

---

## 11. Execution Summary

All execution items completed successfully. The QMS now injects metadata headers and revision history into viewable renditions while keeping source documents clean. Checkout creates placeholder content in QMS drafts. All state-changing commands refresh the injected metadata. approval_date is tracked in .meta for approved states.

Bug fix applied: strip_revision_history() updated to search backwards from auto-generation notice, preventing false matches on example code blocks.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **TO_DO_LIST.md:** "Metadata injection into viewable rendition of QMS documentation"

---

**END OF DOCUMENT**

---

## Revision History

| Version | Date | Author | Summary |
|---------|------|--------|---------|
| 2.0 | 2026-01-09 | claude | â€” |
| 1.0 | 2026-01-09 | qa | CR-018: Implement metadata injection and checkout placeholders |
| 0.1 | 2026-01-08 | claude | Initial draft |

*This revision history is automatically generated from the QMS audit trail.*
