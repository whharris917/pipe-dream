---
{}
---

---
title: Fix qualification test gaps - RS/Implementation alignment
revision_summary: CR-032: Address QA feedback - updated RS to include route in REQ-SEC-003
---

# CR-032: Fix qualification test gaps - RS/Implementation alignment

## 1. Purpose

Align qms-cli implementation with SDLC-QMS-RS requirements by fixing five gaps discovered during qualification testing. These gaps represent functionality that the RS correctly specifies but the code does not implement.

---

## 2. Scope

### 2.1 Context

Qualification testing of qms-cli (Session-2026-01-18-001) identified five gaps between the Requirements Specification and the actual implementation. The RS correctly describes the intended behavior; the code must be updated to match.

- **Parent Document:** SDLC-QMS-RS (Requirements Specification)

**Note (v0.2):** During pre-review, QA identified that REQ-SEC-003 did not originally include "route" in its owner-only restrictions. SDLC-QMS-RS has been updated to add "route" to REQ-SEC-003, establishing the requirement traceability for Gap 2.

### 2.2 Changes Summary

Five fixes to align code with RS:
1. **Gap 1:** Update `fix` command to read status from `.meta` instead of frontmatter
2. **Gap 2:** Enforce owner-only routing per REQ-SEC-003
3. **Gap 3:** Implement TP parent enforcement for child document creation
4. **Gap 4:** Fix VAR path resolution to adapt to parent type (CR or INV)
5. **Gap 5:** Add `--name` argument for TEMPLATE document type

### 2.3 Files Affected

- `qms-cli/commands/fix.py` - Read status from .meta instead of frontmatter
- `qms-cli/commands/route.py` - Add owner-only check
- `qms-cli/commands/create.py` - Handle TP parent and TEMPLATE --name
- `qms-cli/qms_config.py` - Add owner_only flag to route permission
- `qms-cli/qms_paths.py` - Fix VAR path resolution for INV parents

---

## 3. Current State

1. The `fix` command reads document status from frontmatter, which may be stale after workflow transitions.
2. Any user in initiators/qa groups can route any document, regardless of ownership.
3. Creating TP documents ignores `--parent` argument, generating sequential IDs like "TP-001".
4. VAR documents under INV parents are stored in `QMS/CR/INV-001/` instead of `QMS/INV/INV-001/`.
5. TEMPLATE documents cannot have name-based IDs; only sequential IDs are supported.

---

## 4. Proposed State

1. The `fix` command reads document status from `.meta` files (authoritative source).
2. Only the document owner can route their documents for review/approval.
3. TP documents require `--parent` and generate IDs like "CR-001-TP".
4. VAR documents are stored in their parent's directory regardless of parent type.
5. TEMPLATE documents support `--name` for IDs like "TEMPLATE-CR", "TEMPLATE-SOP".

---

## 5. Change Description

### 5.1 Gap 1: Fix Command Status Source

**File:** `qms-cli/commands/fix.py`

Current code reads status from frontmatter:
```python
frontmatter, body = read_document(doc_path)
status = frontmatter.get("status", "")
```

Change to read from `.meta`:
```python
from qms_meta import read_meta
from qms_paths import get_doc_type

doc_type = get_doc_type(doc_id)
meta = read_meta(doc_id, doc_type)
status = meta.get("status", "") if meta else ""
```

### 5.2 Gap 2: Owner-Only Routing

**File:** `qms-cli/commands/route.py`

Add owner check after permission check (around line 48):
```python
# Check document ownership
if meta.get("responsible_user") != user:
    print(f"Error: Only the document owner can route {doc_id}")
    print(f"Current owner: {meta.get('responsible_user')}")
    return 1
```

**File:** `qms-cli/qms_config.py`

Update route permission to include owner_only flag (documentation, enforcement is in route.py):
```python
"route": {"groups": ["initiators", "qa"], "owner_only": True},
```

### 5.3 Gap 3: TP Parent Enforcement

**File:** `qms-cli/commands/create.py`

Extend parent handling to include TP type:
```python
# Handle parent document requirement for TP and VAR types
parent_id = getattr(args, 'parent', None)
if doc_type in ("VAR", "TP"):
    if not parent_id:
        print(f"Error: {doc_type} documents require --parent flag")
        return 1
    # Validate parent exists and is correct type
    parent_type = get_doc_type(parent_id)
    if doc_type == "TP" and parent_type != "CR":
        print("Error: TP documents must have a CR parent")
        return 1
```

Update ID generation for TP:
```python
elif doc_type == "TP" and parent_id:
    # TP has singular ID: CR-001-TP (not CR-001-TP-001)
    doc_id = f"{parent_id}-TP"
```

### 5.4 Gap 4: VAR Path Resolution

**File:** `qms-cli/qms_paths.py`

Update `get_doc_path` to determine VAR path from parent type:
```python
if doc_type == "VAR":
    # Extract parent ID and determine parent type
    match = re.match(r"((?:CR|INV)-\d+)", doc_id)
    if match:
        parent_id = match.group(1)
        parent_type = "CR" if parent_id.startswith("CR-") else "INV"
        parent_config = DOCUMENT_TYPES[parent_type]
        base_path = QMS_ROOT / parent_config["path"] / parent_id
```

### 5.5 Gap 5: TEMPLATE --name Argument

**File:** `qms-cli/commands/create.py`

Add --name argument to create command:
```python
{"flags": ["--name"], "help": "Name for TEMPLATE type (e.g., CR, SOP)"},
```

Handle name-based ID generation:
```python
if doc_type == "TEMPLATE":
    name = getattr(args, 'name', None)
    if name:
        doc_id = f"TEMPLATE-{name.upper()}"
    else:
        next_num = get_next_number(doc_type)
        doc_id = f"{config['prefix']}-{next_num:03d}"
```

---

## 6. Justification

- **Problem:** Five qualification tests are skipped because the code doesn't implement RS requirements
- **Impact of not fixing:** RS and implementation remain inconsistent; qualification cannot be completed
- **Solution:** Code changes align implementation with documented requirements, enabling full qualification

The RS correctly specifies the intended behavior for a GMP-compliant QMS. These are not documentation errors but implementation gaps that must be closed.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/commands/fix.py` | Modify | Read status from .meta |
| `qms-cli/commands/route.py` | Modify | Add owner-only check |
| `qms-cli/commands/create.py` | Modify | TP parent, TEMPLATE --name |
| `qms-cli/qms_config.py` | Modify | Add owner_only to route |
| `qms-cli/qms_paths.py` | Modify | VAR path from parent type |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RTM | Update | Mark tests as passing after fixes |

### 7.3 Other Impacts

None. Changes are internal to qms-cli and do not affect external interfaces.

---

## 8. Testing Summary

Run the five previously-skipped qualification tests:

1. `test_fix_authorization` - Verify fix command works on EFFECTIVE documents
2. `test_owner_only_route` - Verify non-owners cannot route documents
3. `test_create_tp_under_cr` - Verify TP creation with --parent CR-001
4. `test_create_var_under_inv` - Verify VAR stored in INV folder
5. `test_template_name_based_id` - Verify TEMPLATE-CR created with --name CR

After fixes, run full qualification suite:
```
pytest qms-cli/tests/qualification/ -v
```

Expected: 54 tests, 54 passed, 0 skipped.

---

## 9. Implementation Plan

### 9.1 Gap 1: Fix Command

1. Import read_meta and get_doc_type in fix.py
2. Replace frontmatter status read with meta status read
3. Remove pytest.mark.skip from test_fix_authorization
4. Run test to verify

### 9.2 Gap 2: Owner-Only Route

1. Add owner check in route.py after meta is loaded
2. Update qms_config.py route permission (documentation)
3. Remove pytest.mark.skip from test_owner_only_route
4. Run test to verify

### 9.3 Gap 3: TP Parent Enforcement

1. Extend parent validation in create.py to include TP
2. Add TP ID generation logic (singular: CR-001-TP)
3. Remove pytest.mark.skip from test_create_tp_under_cr
4. Run test to verify

### 9.4 Gap 4: VAR Path Resolution

1. Update get_doc_path in qms_paths.py to derive path from parent type
2. Remove pytest.mark.skip from test_create_var_under_inv
3. Run test to verify

### 9.5 Gap 5: TEMPLATE --name

1. Add --name argument to create command registration
2. Add name-based ID generation for TEMPLATE type
3. Remove pytest.mark.skip from test_template_name_based_id
4. Run test to verify

### 9.6 Final Verification

1. Run full qualification suite
2. Verify 54 passed, 0 skipped
3. Verify no production QMS contamination

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Fix Gap 1: Update fix.py to read from .meta | Added read_meta import, replaced frontmatter.get("status") with meta.get("status") | Pass | claude - 2026-01-19 |
| EI-2 | Fix Gap 2: Add owner-only check in route.py | Added owner check after meta load; updated qms_config.py route permission | Pass | claude - 2026-01-19 |
| EI-3 | Fix Gap 3: Implement TP parent enforcement in create.py | Extended parent validation to TP; added TP ID generation (CR-001-TP format) | Pass | claude - 2026-01-19 |
| EI-4 | Fix Gap 4: Fix VAR path resolution in qms_paths.py | Modified get_doc_path and get_archive_path to derive VAR/TP/ER paths from parent type | Pass | claude - 2026-01-19 |
| EI-5 | Fix Gap 5: Add --name argument for TEMPLATE in create.py | Added --name to qms.py argparse and create.py; added TEMPLATE name-based ID generation | Pass | claude - 2026-01-19 |
| EI-6 | Remove skip markers from 5 tests | Removed @pytest.mark.skip from test_fix_authorization, test_owner_only_route, test_create_tp_under_cr, test_create_var_under_inv, test_template_name_based_id | Pass | claude - 2026-01-19 |
| EI-7 | Run full qualification suite (expect 54 pass) | pytest qms-cli/tests/qualification/ -v: 54 passed in 106.53s | Pass | claude - 2026-01-19 |
| EI-8 | Verify no production QMS contamination | git status QMS/: Only expected changes (RS update, CR-032 files) | Pass | claude - 2026-01-19 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|

---

## 11. Execution Summary

All 8 execution items completed successfully. Five code fixes implemented across fix.py, route.py, create.py, qms_paths.py, qms_config.py, and qms.py. All 5 previously-skipped qualification tests now pass. Full qualification suite: 54 tests passed, 0 skipped, 0 failed. No unintended QMS contamination.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SDLC-QMS-RS:** QMS CLI Requirements Specification (defines intended behavior)
- **SDLC-QMS-RTM:** Requirements Traceability Matrix (maps tests to requirements)
- **Session-2026-01-18-001:** Qualification session where gaps were identified

---

**END OF DOCUMENT**
