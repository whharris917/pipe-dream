---
title: Consolidate services into status command with robustness improvements
revision_summary: 'Revised: three sections always shown, expanded Agents table (uptime,
  start/stop policy), authoritative empty states, model/API expansion'
---

# CR-071: Consolidate services into status command with robustness improvements

## 1. Purpose

Make `agent-hub status` the single, authoritative overview of the Pipe Dream project's runtime state. The command should be clear, complete, and honest -- showing services, containers, and agents in every invocation regardless of whether the Hub is up or down. Additionally, prevent duplicate agent launches that can silently destroy running containers.

---

## 2. Scope

### 2.1 Context

Independent improvement identified during UAT of Agent Hub CLI (CR-069/CR-070). The `status` and `services` commands overlap in purpose, the `status` command fails ungracefully when the Hub is down, and there is no guard against launching an already-running agent.

- **Parent Document:** None

### 2.2 Changes Summary

1. **Consolidate `services` into `status`** -- the `status` command shows both service health and agent state in one view
2. **Honest output when Hub is down** -- fall back to Docker container listing with a disclaimer instead of failing
3. **Container classification** -- distinguish Hub-managed (`agent-{id}`) from manual (`docker-claude-agent-N`) containers
4. **Duplicate launch prevention** -- Hub API and CLI refuse to start an already-running agent

### 2.3 Files Affected

- `agent-hub/agent_hub/cli.py` -- Rewrite `status` command, remove `services` command, add duplicate guard to `launch`
- `agent-hub/agent_hub/services.py` -- Add `classify_container()` helper
- `agent-hub/agent_hub/hub.py` -- Change `start_agent()` to error on RUNNING
- `agent-hub/agent_hub/container.py` -- Add running-container guard in `start()`
- `agent-hub/agent_hub/models.py` -- Expand `AgentSummary` with shutdown policy and `started_at`
- `agent-hub/agent_hub/api/routes.py` -- Populate new `AgentSummary` fields in status/list endpoints

---

## 3. Current State

1. The `status` command only queries the Hub API and exits with an error if the Hub is not running.
2. The `services` command shows service health and Docker containers, duplicating some of `status`.
3. When the Hub is down, `status` prints "Hub is not running" with no container information.
4. `hub.start_agent()` silently returns the agent if it is already RUNNING, which causes `launch` to silently attach to an existing container after tearing it down via `_remove_if_exists()`.
5. There is no distinction between Hub-managed containers (e.g., `agent-claude`) and manually started containers (e.g., `docker-claude-agent-1`).

---

## 4. Proposed State

1. The `status` command always shows three sections: Services, Containers, and Agents -- regardless of whether the Hub is running.
2. The Services section always shows health of QMS MCP, Git MCP, and Agent Hub (via direct port probing).
3. The Containers section always shows Docker containers (via direct `docker ps` query -- does not depend on Hub). Containers are classified as "managed" (`agent-{id}`) or "manual" (everything else). When no containers exist, an authoritative message clarifies that this is a definitive answer, not a "Hub is down so I don't know" answer.
4. The Agents section shows full agent state (state, uptime, inbox count, start policy, stop policy) when the Hub is up, or a clear "unavailable" message when the Hub is down.
5. The `services` command is removed.
6. `hub.start_agent()` raises `RuntimeError` when the agent is already RUNNING, mapped to HTTP 409 by the API route.
7. `container.start()` checks for a running container before calling `_remove_if_exists()` and raises `RuntimeError` if one exists.
8. The CLI `launch` command catches HTTP 409 and displays a helpful message suggesting `agent-hub attach`.

---

## 5. Change Description

### 5.1 Consolidated `status` command (`cli.py`)

Replace the current `status` command with a unified, always-complete view. The command always shows three sections in fixed order: Services, Containers, Agents. The goal is that an operator can run `agent-hub status` in any circumstance and get a clear, complete, authoritative, honest picture of what's going on.

**Three sections, always present:**

1. **Services** -- Direct port probing via `get_services_status()`. Independent of Hub.
2. **Containers** -- Direct `docker ps` query via `get_containers()`. Independent of Hub. Containers classified as "managed" or "manual". When empty: `No containers found (direct Docker query -- does not depend on Hub).`
3. **Agents** -- When Hub is UP: full agent table (state, uptime, inbox, start policy, stop policy) from `/api/status`. When Hub is DOWN: `Agent state unavailable. Start Hub with: agent-hub start`

**Sample output (Hub UP):**

```
=== Services ===

  SERVICE        PORT     STATE      PID      INFO
  ----------------------------------------------------------
  QMS MCP        :8000    UP         12345    -
  Git MCP        :8001    UP         12346    -
  Agent Hub      :9000    UP         12347    (2 running, 5 stopped)

=== Containers ===

  NAME                 TYPE       DOCKER STATE     STATUS
  ----------------------------------------------------------------
  agent-claude         managed    running          Up 2 minutes
  agent-qa             managed    running          Up 5 minutes

=== Agents ===

  AGENT          STATE        UPTIME     INBOX    START POLICY     STOP POLICY
  -------------------------------------------------------------------------------
  claude         running      3h 12m     3        manual           manual
  qa             running      0h 05m     0        auto_on_task     on_inbox_empty
  tu_ui          stopped      -          0        manual           manual
  tu_scene       stopped      -          0        manual           manual
  tu_sketch      stopped      -          0        manual           manual
  tu_sim         stopped      -          0        manual           manual
  bu             stopped      -          0        manual           manual
```

**Sample output (Hub DOWN):**

```
=== Services ===

  SERVICE        PORT     STATE      PID      INFO
  ----------------------------------------------------------
  QMS MCP        :8000    UP         12345    -
  Git MCP        :8001    DOWN       -        -
  Agent Hub      :9000    DOWN       -        -

=== Containers ===

  NAME                       TYPE       DOCKER STATE     STATUS
  ----------------------------------------------------------------
  agent-claude               managed    running          Up 2 minutes
  docker-claude-agent-1      manual     running          Up 10 minutes

=== Agents (Hub not running) ===

  Agent state unavailable. Start Hub with: agent-hub start
```

**Sample output (no containers):**

```
=== Containers ===

  No containers found (direct Docker query -- does not depend on Hub).
```

### 5.2 Remove `services` command (`cli.py`)

The `services` command was only added in CR-069 and is not widely used. Since `status` now absorbs all its functionality, `services` is removed entirely rather than deprecated.

### 5.3 Container classification (`services.py`)

Add `classify_container()` helper:

```python
def classify_container(name: str, valid_agents: list[str], prefix: str = "agent-") -> str:
    """Classify a container as 'managed' or 'manual'.

    Managed: matches {prefix}{known_agent_id} exactly.
    Manual: anything else matching the docker ps filter.
    """
    for agent_id in valid_agents:
        if name == f"{prefix}{agent_id}":
            return "managed"
    return "manual"
```

### 5.4 Expanded agent summary (`models.py`, `routes.py`)

The `AgentSummary` model currently only includes `launch_policy`. Expand it with:

- `shutdown_policy: ShutdownPolicy` -- the agent's shutdown policy
- `started_at: datetime | None` -- when the container started (used by CLI to compute uptime)

The `/api/status` and `/api/agents` endpoints populate these new fields from the `Agent` record.

The CLI computes uptime display from `started_at`:
- Running agent with `started_at`: show relative duration (e.g., `3h 12m`)
- Stopped agent or `started_at` is null: show `-`

### 5.5 Duplicate launch prevention

**Hub API (`hub.py` -- `start_agent()`):**

Change lines 114-115 from a silent return to raising `RuntimeError`:
- Current: `if agent.state == AgentState.RUNNING: return agent`
- New: `if agent.state == AgentState.RUNNING: raise RuntimeError(f"Agent {agent_id} is already running. Use 'agent-hub attach {agent_id}' to connect.")`

The API route already maps `RuntimeError` to HTTP 409.

**Container level (`container.py` -- `start()`):**

Before `_remove_if_exists()`, check if a container with this name exists and is running. If so, raise `RuntimeError` instead of silently force-removing it.

**CLI level (`cli.py` -- `launch`):**

After getting Hub API response, detect 409 status and display: "Agent '{id}' is already running. Use 'agent-hub attach {id}' to connect."

---

## 6. Justification

- **One command, complete picture:** An operator should be able to run a single command and know exactly what's going on. Two overlapping commands (`status` and `services`) with different failure modes undermine this.
- **Honesty over false confidence:** When the Hub is down, the current `status` shows nothing -- which can mislead operators into thinking no agents are active. The new design shows everything it can determine authoritatively (services and containers via direct queries) and clearly labels what it cannot determine (agent state requires Hub).
- **Authoritative empty states:** When there are no containers, the output explicitly says so and confirms the answer is definitive -- not a consequence of the Hub being down.
- **Silent replacement is dangerous:** The current code silently destroys a running container when `launch` is called for an already-running agent, which can interrupt active work.
- **Container provenance:** Without classification, it's unclear which containers are Hub-managed and which were started manually via docker-compose.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/agent_hub/cli.py` | Modify | Rewrite `status`, remove `services`, add 409 handling to `launch` |
| `agent-hub/agent_hub/services.py` | Modify | Add `classify_container()` helper |
| `agent-hub/agent_hub/hub.py` | Modify | Change `start_agent()` RUNNING guard from silent return to RuntimeError |
| `agent-hub/agent_hub/container.py` | Modify | Add running-container guard before `_remove_if_exists()` |
| `agent-hub/agent_hub/models.py` | Modify | Expand `AgentSummary` with `shutdown_policy` and `started_at` fields |
| `agent-hub/agent_hub/api/routes.py` | Modify | Populate new `AgentSummary` fields in `/api/status` and `/api/agents` |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No controlled documents affected |

### 7.3 Other Impacts

- CLI users who use `agent-hub services` will need to use `agent-hub status` instead. Since `services` was added in CR-069 (recent, not widely adopted), this is low-impact.
- Callers of the Hub API `POST /api/agents/{id}/start` that currently rely on the silent return for already-running agents will now receive HTTP 409. This is a behavioral change but the correct semantic response.

---

## 8. Testing Summary

- Manual verification: `agent-hub status` with Hub running shows all three sections (Services, Containers, Agents) with full data
- Manual verification: `agent-hub status` with Hub down shows Services and Containers with real data, Agents section with "unavailable" message
- Manual verification: `agent-hub status` with no containers shows authoritative "No containers found (direct Docker query -- does not depend on Hub)."
- Manual verification: Container classification correctly distinguishes managed (`agent-claude`) from manual (`docker-claude-agent-1`)
- Manual verification: `agent-hub launch claude` when claude is already running shows error with attach suggestion
- Manual verification: `agent-hub services` returns "command not found"

---

## 9. Implementation Plan

### 9.1 Phase 1: Hub and Container Guards

1. Modify `hub.py` `start_agent()` to raise `RuntimeError` when agent is already RUNNING
2. Modify `container.py` `start()` to check for running container before `_remove_if_exists()`

### 9.2 Phase 2: Model and API Expansion

1. Expand `AgentSummary` in `models.py` with `shutdown_policy` and `started_at`
2. Update `/api/status` and `/api/agents` in `routes.py` to populate new fields

### 9.3 Phase 3: Services Helper

1. Add `classify_container()` to `services.py`

### 9.4 Phase 4: CLI Changes

1. Rewrite `status` command to show unified output with all three sections
2. Remove `services` command entirely
3. Add HTTP 409 handling to `launch` command for single-agent and multi-agent paths

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Modify `hub.py` to raise RuntimeError when agent is already RUNNING | Changed `hub.py:114-118` from silent `return agent` to `raise RuntimeError` with helpful attach suggestion. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-2 | Modify `container.py` to guard against removing running containers | Added running-container check in `container.py:49-58` before `_remove_if_exists()`. Uses Docker SDK `containers.get()` and checks status; raises `RuntimeError` if running, passes through on `NotFound`. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-3 | Expand `AgentSummary` in `models.py` and populate in `routes.py` | Added `shutdown_policy: ShutdownPolicy` and `started_at: datetime | None` to `AgentSummary` in `models.py:65-66`. Updated both `/api/status` and `/api/agents` in `routes.py` to populate new fields. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-4 | Add `classify_container()` helper to `services.py` | Added `classify_container()` function in `services.py:313-327`. Matches container name against `{prefix}{known_agent_id}` to return "managed" or "manual". Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-5 | Rewrite `status` command in `cli.py` with unified three-section output | Rewrote `status` command in `cli.py:53-170`. Always shows Services (port probing), Containers (docker ps with classification), and Agents (Hub API or unavailable message). Includes per-agent uptime, start/stop policy columns. Authoritative empty-state message for no containers. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-6 | Remove `services` command from `cli.py` | Removed `services_cmd` function and `@cli.command("services")` decorator (~50 lines). All functionality absorbed by `status`. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-7 | Add HTTP 409 handling to `launch` command in `cli.py` | Added 409 handling to both single-agent path (`cli.py:466-472`) and multi-agent path (`cli.py:497-503`). Single-agent exits with suggestion; multi-agent continues with warning per agent. Commit 6a33f1a. | Pass | claude - 2026-02-09 |
| EI-8 | Manual UAT verification of all test scenarios | All 7 scenarios verified: (1) Status with Hub down shows three sections with authoritative empty messages -- Pass. (2) `services` command returns "No such command" -- Pass. (3) Status with Hub up shows full three-section output with all agents -- Pass. (4) API returns `shutdown_policy` and `started_at` fields -- Pass. (5) Container classification (managed vs manual) -- Pass. (6) Duplicate launch returns HTTP 409 with helpful message -- Pass. (7) Per-agent uptime display -- initially showed timezone mismatch (~5h offset), fixed in commit 1e05cb0 by using naive local time consistently, re-tested and confirmed accurate. | Pass | claude - 2026-02-09 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| EI-1 through EI-7 implemented in a single commit (6a33f1a). EI-8 (UAT) pending. | claude - 2026-02-09 |
| EI-8 UAT complete. Timezone bug found during uptime verification (naive vs UTC datetime), fixed in commit 1e05cb0. All 7 scenarios pass. | claude - 2026-02-09 |
| Pre-existing cp1252 encoding bug: Unicode checkmark/cross characters (`\u2713`, `\u2717`) and em-dash (`\u2014`) in `click.echo()` calls crash on Windows cp1252 console. Replaced with ASCII equivalents (`+`, `x`, `--`) in both `services.py` and `cli.py`. Commit 3ea50db. Discovered during UAT when `agent-hub launch` failed before reaching the 409 test path. | claude - 2026-02-09 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 8 execution items completed successfully. The core implementation (EI-1 through EI-7) was delivered in commit 6a33f1a. Two bugs were found and fixed during UAT (EI-8): (1) timezone mismatch in uptime computation -- Hub stores `started_at` as naive local time, CLI was comparing against UTC, fixed in commit 1e05cb0; (2) pre-existing cp1252 encoding crash -- Unicode symbols in `click.echo()` calls fail on Windows console, replaced with ASCII equivalents in commit 3ea50db. All 7 UAT scenarios pass after fixes. No VARs required.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-069:** Agent Hub CLI Consolidation (introduced `services` command)
- **CR-070:** Agent Session Health Detection

---

**END OF DOCUMENT**
