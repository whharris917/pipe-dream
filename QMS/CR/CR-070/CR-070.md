---
title: Agent Session Health Detection
revision_summary: Initial draft
---

# CR-070: Agent Session Health Detection

## 1. Purpose

Add session-level health detection to the Agent Hub so the system distinguishes between "container running" and "agent session active." When a user exits Claude Code (instead of detaching from tmux), the container stays alive but the agent session is dead. The Hub currently has no way to detect this, leading to false-positive "running" reports and broken `attach` attempts.

---

## 2. Scope

### 2.1 Context

Identified during UAT of the primary CLI surface commands (Session 2026-02-09-001). When a user exits Claude Code inside a container instead of detaching with Ctrl-B D, the tmux session dies but the container persists because PID 1 is `sleep infinity` (the SETUP_ONLY entrypoint pattern). The Hub reports the agent as RUNNING when it is effectively dead.

- **Parent Document:** None (gap identified during UAT)

### 2.2 Changes Summary

Introduce session health checking into the Hub's container sync loop. Add a `STALE` agent state for containers whose tmux session has died. Update CLI commands (`attach`, `services`) to detect and handle stale agents with recovery options.

### 2.3 Files Affected

- `agent-hub/agent_hub/models.py` — Add `STALE` to `AgentState` enum
- `agent-hub/agent_hub/container.py` — Add `is_session_alive()` method
- `agent-hub/agent_hub/hub.py` — Enhance `_container_sync_loop` to check session health
- `agent-hub/agent_hub/cli.py` — Handle STALE state in `attach` and `services`
- `agent-hub/agent_hub/api/routes.py` — Include session health in status responses

---

## 3. Current State

The Hub tracks agent state via a `_container_sync_loop` that runs every 10 seconds (hub.py:328-373). It reconciles Hub state with Docker container state: if Docker says the container is running, the Hub sets the agent to RUNNING; if stopped, STOPPED.

The `AgentState` enum has five values: `STOPPED`, `STARTING`, `RUNNING`, `STOPPING`, `ERROR` (models.py:9-16).

There is no check for whether the tmux session or Claude Code process is alive inside a running container. The system equates "container running" with "agent active."

**Symptoms of the gap:**
- `agent-hub services` reports the agent as `running` when the session is dead
- `agent-hub attach {agent}` fails with "no sessions" because tmux is gone
- The Hub's agent count ("1 agents running") is misleading
- No automatic recovery path — user must manually `docker rm -f` the container

---

## 4. Proposed State

The Hub distinguishes between container health and session health. The `_container_sync_loop` checks tmux session existence inside running containers. When a container is running but the tmux session is dead, the agent transitions to a new `STALE` state.

CLI commands handle `STALE` gracefully:
- `services` shows the agent as `stale` (distinct from `running`)
- `attach` detects the stale state and offers the user a choice: restart the session in the existing container, or tear down the container entirely

The Hub API includes session health in agent status responses, enabling the GUI to display accurate state.

---

## 5. Change Description

### 5.1 New Agent State: STALE

Add `STALE` to the `AgentState` enum in `models.py`. The state means: the Docker container is running, but the agent's tmux session (and therefore Claude Code) has exited. The agent is not doing work and cannot be attached to without intervention.

State transitions involving STALE:

```
RUNNING ──(tmux dies)──► STALE
STALE ──(session restart)──► RUNNING
STALE ──(container teardown)──► STOPPED
```

### 5.2 Session Health Check

Add `is_session_alive(agent_id)` to `ContainerManager`. This executes:

```bash
docker exec agent-{id} tmux has-session -t agent
```

Return code 0 means the session exists; non-zero means it's dead. This is a lightweight, non-intrusive check suitable for running every 10 seconds in the sync loop.

### 5.3 Enhanced Container Sync Loop

In `hub.py`, `_container_sync_loop` currently checks Docker container state. Extend it:

1. For each agent in RUNNING state, call `is_session_alive()`
2. If the session is dead, transition to STALE
3. Log the transition for observability
4. Broadcast the state change to WebSocket clients (GUI gets real-time updates)

For agents in STALE state, continue checking — if the container stops (e.g., manual `docker rm`), transition to STOPPED normally.

### 5.4 CLI: `attach` Recovery

When `attach` encounters a STALE agent, present the user with options:

```
Agent 'claude' is stale (container running, session dead).

  [R] Restart session - launch Claude Code in a new tmux session
  [T] Teardown      - remove the container entirely
  [C] Cancel

Choice:
```

- **Restart**: Executes the same `_exec_claude()` and `_wait_for_ready()` sequence used during initial launch (container.py:240-286), then attaches. The Hub transitions the agent back to RUNNING.
- **Teardown**: Removes the container (`docker rm -f`), Hub transitions to STOPPED.
- **Cancel**: No action.

### 5.5 CLI: `services` Display

Update the services display to show STALE distinctly:

```
Containers:
  agent-claude    stale     (container running, session dead)
```

### 5.6 Hub API Enhancement

The `GET /agents/{id}` and `GET /status` endpoints include a `session_alive` boolean alongside the existing state field. This allows the GUI to render accurate badges without needing to interpret state semantics.

---

## 6. Justification

- **Accurate observability:** Users and the GUI currently receive false-positive "running" reports for dead agents. This erodes trust in the system's status reporting.
- **Recovery path:** Without this change, the only recovery from an orphaned container is manual Docker commands. Users shouldn't need to know Docker internals.
- **Foundation for session management:** Introducing STALE as a state and session health as a concept positions the architecture for future session lifecycle features (automatic recovery, session history, session-first management) without requiring a larger refactor later.
- **Impact of inaction:** Every time a user exits Claude Code instead of detaching, they hit a dead end that requires manual intervention and Docker knowledge.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/agent_hub/models.py` | Modify | Add STALE to AgentState enum |
| `agent-hub/agent_hub/container.py` | Modify | Add `is_session_alive()` method |
| `agent-hub/agent_hub/hub.py` | Modify | Extend sync loop with session health check |
| `agent-hub/agent_hub/cli.py` | Modify | STALE handling in `attach` and `services` |
| `agent-hub/agent_hub/api/routes.py` | Modify | Add `session_alive` to agent responses |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | — | No controlled documents affected |

### 7.3 Other Impacts

- **Docker exec overhead:** One `docker exec tmux has-session` per running agent per 10-second sync cycle. This is negligible (sub-100ms, no I/O).
- **Backward compatibility:** Adding a new enum value is additive. Existing code that checks for RUNNING/STOPPED is unaffected; STALE agents simply won't match RUNNING checks, which is correct behavior.
- **GUI:** WebSocket broadcasts will include STALE state changes. The GUI should handle unknown states gracefully already, but the Tauri GUI may want a dedicated badge/color for STALE in a follow-up.

---

## 8. Testing Summary

- **Simulate orphan:** Launch agent, exit Claude Code (not detach), verify Hub transitions to STALE within 10s
- **Verify `services` display:** Confirm stale agent shows distinct status
- **Test `attach` recovery:** Confirm restart option relaunches Claude Code in existing container
- **Test `attach` teardown:** Confirm teardown removes container cleanly
- **Normal flow unchanged:** Launch, detach, reattach — verify no false STALE detection
- **Hub restart:** Start Hub when a stale container already exists — verify it discovers the STALE state

---

## 9. Implementation Plan

### 9.1 Phase 1: State Model

1. Add `STALE` to `AgentState` enum in `models.py`
2. Verify no existing code breaks with the new enum value

### 9.2 Phase 2: Session Health Check

1. Add `is_session_alive(agent_id)` to `ContainerManager`
2. Implement via `docker exec ... tmux has-session -t agent`
3. Handle edge cases: container not running, Docker errors

### 9.3 Phase 3: Sync Loop Enhancement

1. Extend `_container_sync_loop` to call `is_session_alive()` for RUNNING agents
2. Transition to STALE when session is dead
3. Broadcast state change via WebSocket
4. For STALE agents, continue monitoring container state

### 9.4 Phase 4: CLI Updates

1. Update `attach` command to detect STALE and offer recovery options
2. Update `services` display to show STALE state distinctly
3. Implement restart path: reuse `_exec_claude()` + `_wait_for_ready()` via Hub API
4. Implement teardown path: stop container via Hub API

### 9.5 Phase 5: Hub API

1. Add `session_alive` field to agent status responses
2. Add restart endpoint or extend existing start endpoint for session-only restart

### 9.6 Phase 6: Manual Testing

1. Execute all test scenarios from Section 8
2. Document results

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add STALE to AgentState enum | Added `STALE = "stale"` to `AgentState` enum in `models.py:13`. Added `session_alive: bool = False` field to `Agent` model in `models.py:54`. Verified enum loads correctly: `['stopped', 'starting', 'running', 'stale', 'stopping', 'error']`. | Pass | claude - 2026-02-09 |
| EI-2 | Implement `is_session_alive()` in ContainerManager | Added `is_session_alive(agent_id)` method at `container.py:98-115`. Uses `docker exec ... tmux has-session -t agent` with 5s timeout. Returns `True`/`False`. Also added `restart_session(agent_id)` at `container.py:305-313` which reuses `_exec_claude()` + `_wait_for_ready()` to restart Claude in an existing container. | Pass | claude - 2026-02-09 |
| EI-3 | Extend `_container_sync_loop` with session health check | Extended sync loop in `hub.py` to: (1) check session health when discovering new containers, (2) detect session death in RUNNING agents and transition to STALE, (3) handle STALE→STOPPED when container stops. Updated `_discover_running_containers` with same logic. Updated `start_agent` to accept STALE state. Updated `stop_agent` to accept STALE state and reset `session_alive`. Added `restart_agent_session()` method for STALE recovery. | Pass | claude - 2026-02-09 |
| EI-4 | Update `attach` CLI command with STALE recovery | Rewrote `attach` command in `cli.py:206-300`. When agent is `stale`, presents interactive menu: [R] Restart session (calls `/api/agents/{id}/restart-session`), [T] Teardown (calls `/api/agents/{id}/stop`), [C] Cancel. After restart, falls through to normal tmux attach. | Pass | claude - 2026-02-09 |
| EI-5 | Update `services` CLI display for STALE state | Updated `services` command to query Hub API for agent states and enrich Docker container display. Stale containers show `stale` in yellow with "container running, session dead" status. Added `stale: yellow` to `status` command color map. | Pass | claude - 2026-02-09 |
| EI-6 | Add `session_alive` to Hub API responses | `session_alive` field automatically included via Pydantic serialization (Agent model updated in EI-1). Added `POST /agents/{id}/restart-session` endpoint in `routes.py` that calls `hub.restart_agent_session()`. Returns 409 if agent is not STALE. | Pass | claude - 2026-02-09 |
| EI-7 | Manual testing of all scenarios | UAT performed by lead across two test rounds. Results: (1) Stale detection — PASS: `services` shows `stale` with "container running, session dead" after Claude Code exit. (2) Attach recovery menu — PASS: R/T/C prompt appears for stale agents. (3) Restart session — PASS: choosing R restarts Claude Code in existing container, attach works. (4) Normal flow after restart — PASS: `services` shows `running`, attach/detach cycle works. (5) Teardown — PASS: choosing T removes container, `services` shows no containers. (6) Hub restart discovers stale — PASS: killed Hub via `taskkill`, started fresh with `agent-hub start`, Hub log shows "Discovered stale container for claude (container running, session dead)", `status` and `services` both correctly report `stale`. Additional finding during testing: stale count missing from Hub info line — fixed in `services.py`. Also found `services` shows raw Docker state when Hub is down — fixed to show "session state unknown (Hub down)" for running containers when Hub is unavailable. | Pass | lead, claude - 2026-02-09 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| All 5 files pass Python syntax check (`ast.parse`). Import chain verified: `AgentState` enum contains all 6 values including STALE. `restart_session` in ContainerManager reuses existing `_exec_claude` + `_wait_for_ready` methods, avoiding code duplication. | claude - 2026-02-09 |
| During UAT, found stale agents not counted in Hub info line (`services.py`). Fixed to show "(1 stale, 6 stopped)" format. Also found `services` displays raw Docker "running" state when Hub is down — fixed to show "session state unknown (Hub down)" as status text. Both fixes are in scope of EI-5 (services display). | claude - 2026-02-09 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 7 execution items completed successfully. Implementation adds session health detection to the Agent Hub via a new `STALE` agent state, `tmux has-session` health checks in the container sync loop, and a recovery menu in the `attach` CLI command. Two minor issues found during UAT were fixed in-flight: (1) stale agents missing from the Hub info count in `services.py`, and (2) `services` showing raw Docker state with no session health caveat when the Hub is unavailable — now displays "session state unknown (Hub down)". Commits: f2c64ec (implementation), 54da65f (UAT results and services display fixes).

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution
- **CR-069:** Agent Hub Consolidation (established current architecture)
- **Session 2026-02-09-001:** UAT results identifying the orphaned container gap

---

**END OF DOCUMENT**
