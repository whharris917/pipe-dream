---
title: 'Pre-Integration Hardening: Security and Resilience Fixes'
revision_summary: Initial draft
---

# CR-077: Pre-Integration Hardening: Security and Resilience Fixes

## 1. Purpose

This CR addresses four findings from the Session-2026-02-14-001 code review that should be fixed before Phase A integration testing begins. The findings span security (command injection, CORS), resilience (error boundary), and UX (silent bootstrap failure). Fixing them before integration testing prevents misleading test results and security exposure during multi-agent workflows.

---

## 2. Scope

### 2.1 Context

Independent improvements identified during the comprehensive code review performed in Session-2026-02-14-001. Findings C1, C2, H2, and H3 from that review are bundled here because they are all pre-conditions for reliable integration testing.

- **Parent Document:** None

### 2.2 Changes Summary

Four fixes across three subsystems (Git MCP server, Hub API server, GUI frontend):

1. **C1:** Eliminate shell injection in Git MCP by switching from `shell=True` to `shell=False` with argument list parsing
2. **C2:** Restrict CORS origins in Hub API from wildcard (`*`) to GUI-specific origins
3. **H2:** Check `ensureHub()` return value before connecting WebSocket
4. **H3:** Add React ErrorBoundary to prevent white-screen crashes

### 2.3 Files Affected

- `agent-hub/mcp-servers/git_mcp/server.py` — Refactor command execution (C1)
- `agent-hub/agent_hub/api/server.py` — Restrict CORS origins (C2)
- `agent-hub/gui/src/App.tsx` — Check ensureHub return value (H2)
- `agent-hub/gui/src/components/ErrorBoundary.tsx` — New file: React error boundary (H3)
- `agent-hub/gui/src/main.tsx` — Wrap root with ErrorBoundary (H3)

---

## 3. Current State

1. The Git MCP server executes commands via `subprocess.run()` with `shell=True`, enabling shell metacharacter injection (e.g., `status ; whoami`, `status $(cat /etc/passwd)`). The `validate_command()` blocklist does not cover all injection vectors.

2. The Hub API server allows CORS requests from any origin (`allow_origins=["*"]`), enabling cross-site request forgery from any website to `localhost:9000`.

3. `App.tsx` calls `hubConnection.connect()` unconditionally after `ensureHub()` resolves, regardless of whether the Hub actually started. If `ensureHub()` returns `false`, the WebSocket enters an infinite reconnect loop with no user-facing error.

4. No React ErrorBoundary exists in the GUI. Any unhandled exception in any component crashes the entire GUI to a blank white screen with no recovery mechanism.

---

## 4. Proposed State

1. The Git MCP server executes commands via `subprocess.run()` with `shell=False` and argument lists parsed via `shlex.split()`. Chained commands (`&&`, `||`) are split and executed sequentially. Shell metacharacters (`;`, `` ` ``, `$(`, `>`, `<`) are blocked by validation.

2. The Hub API server restricts CORS to GUI-specific origins: `http://localhost:1420`, `http://127.0.0.1:1420`, and `tauri://localhost`.

3. `App.tsx` checks the `ensureHub()` return value. On failure, connection status is set to `"error"` and the WebSocket connection is not attempted.

4. A React ErrorBoundary wraps the root component, catching unhandled exceptions and displaying a fallback UI with error details and a recovery button.

---

## 5. Change Description

### 5.1 C1: Git MCP Command Injection Fix

**Root cause:** `subprocess.run(cmd, shell=True)` passes the entire command string to the system shell (`/bin/sh` on Unix, `cmd.exe` on Windows), which interprets metacharacters.

**Fix approach:**

1. Add shell metacharacter validation to `validate_command()`:
   - Block `;`, `` ` ``, `$(`, `${`, `>`, `<`, and newlines
   - These have no legitimate use in git commands passed to this tool

2. Refactor command execution:
   - For simple commands: parse with `shlex.split()`, execute with `shell=False`
   - For chained commands (`&&`): split on operator, parse each segment with `shlex.split()`, execute sequentially (stop on first failure)
   - For `||` chains: execute sequentially (stop on first success)
   - Ensure each segment has `git` prefix

3. Remove the `shell=True` codepath entirely.

**Behavioral change:** Commands using shell-specific features (piping with `|`, glob expansion, redirection) will no longer work. These were never part of the intended use case — `git_exec` is for git operations, not general shell scripting.

### 5.2 C2: CORS Origin Restriction

**Root cause:** The FastAPI CORS middleware is configured with `allow_origins=["*"]`, which was a development convenience that was never tightened.

**Fix:** Replace the wildcard with the specific origins the GUI uses:
- `http://localhost:1420` — Vite dev server
- `http://127.0.0.1:1420` — Vite dev server (alternate)
- `tauri://localhost` — Tauri production build

### 5.3 H2: ensureHub Return Value Check

**Root cause:** The `.then()` callback in `App.tsx` does not check the boolean return value of `ensureHub()`.

**Fix:** Check the return value. On `false`, set connection status to `"error"` instead of attempting WebSocket connection.

### 5.4 H3: React ErrorBoundary

**Root cause:** No error boundary exists in the component tree. React's default behavior on unhandled errors is to unmount the entire tree, resulting in a blank white screen.

**Fix:** Create an `ErrorBoundary` class component (React error boundaries must be class components) that:
- Catches errors via `componentDidCatch()`
- Displays a fallback UI with the error message and a "Reload" button
- Logs the error details to console for debugging

Wrap the root `<App />` in `main.tsx` with this boundary.

---

## 6. Justification

- **C1 (Critical):** The Git MCP server runs on the **host**, not in a container. Shell injection enables arbitrary host command execution. Even in a trusted-agent environment, defense in depth requires eliminating this vector.
- **C2 (Critical):** Any website can currently make cross-origin requests to the Hub API, potentially starting/stopping agents or injecting terminal input via CSRF.
- **H2 (High):** Without this fix, GUI testing during Phase A will produce false negatives — the GUI will appear broken (infinite "Connecting...") when the real issue is Hub startup failure.
- **H3 (High):** Without this fix, any single component error during Phase A testing will crash the entire GUI with no diagnostic information.

Not making these changes would reduce the reliability and diagnostic value of Phase A integration testing.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `agent-hub/mcp-servers/git_mcp/server.py` | Modify | Refactor command execution to use shell=False |
| `agent-hub/agent_hub/api/server.py` | Modify | Restrict CORS origins |
| `agent-hub/gui/src/App.tsx` | Modify | Check ensureHub return value |
| `agent-hub/gui/src/components/ErrorBoundary.tsx` | Create | React error boundary component |
| `agent-hub/gui/src/main.tsx` | Modify | Wrap root with ErrorBoundary |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | — | No controlled documents modified |

### 7.3 Other Impacts

- **Git MCP behavioral change:** Shell features (piping, globbing, redirection) will no longer work in `git_exec`. This is intentional — these were unintended capabilities.
- **CORS restriction:** If the GUI dev server port changes from 1420, the CORS origins list must be updated.

---

## 8. Testing Summary

- **C1:** Manual verification that (a) normal git commands work, (b) injection attempts are blocked, (c) chained commands with `&&` work correctly
- **C2:** Visual verification of CORS config in source code
- **H2:** Code review verification that return value is checked and error state is set
- **H3:** Code review verification that ErrorBoundary wraps root and renders fallback

---

## 9. Implementation Plan

### 9.1 EI-1: Fix Git MCP Command Injection (C1)

1. Add shell metacharacter patterns to `validate_command()`
2. Implement `_split_chain()` to parse `&&`/`||` chains
3. Implement `_execute_single()` using `shlex.split()` and `shell=False`
4. Refactor `git_exec()` to use new execution path
5. Remove `shell=True` codepath
6. Test with representative commands

### 9.2 EI-2: Restrict CORS Origins (C2)

1. Replace `allow_origins=["*"]` with specific GUI origins in `server.py`

### 9.3 EI-3: Fix ensureHub Return Value (H2)

1. Modify `.then()` callback in `App.tsx` to check boolean return
2. Set connection status to `"error"` on failure

### 9.4 EI-4: Add React ErrorBoundary (H3)

1. Create `ErrorBoundary.tsx` component
2. Wrap `<App />` in `main.tsx` with `<ErrorBoundary>`

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Fix Git MCP command injection: replace shell=True with shlex parsing and shell=False | Added `BLOCKED_SHELL_CHARS` list (`;`, `` ` ``, `$(`, `${`, `><`, `\n`) to `validate_command()`. Refactored execution: `_split_chain()` parses `&&`/`||` chains, `_execute_single()` uses `shlex.split()` + `shell=False`, `_ensure_git_prefix()` adds `git` to each segment. Removed all `shell=True` codepaths. File: `agent-hub/mcp-servers/git_mcp/server.py` | Pass | claude - 2026-02-14 |
| EI-2 | Restrict CORS origins to GUI-specific origins | Replaced `allow_origins=["*"]` with `["http://localhost:1420", "http://127.0.0.1:1420", "tauri://localhost"]`. File: `agent-hub/agent_hub/api/server.py:36-39` | Pass | claude - 2026-02-14 |
| EI-3 | Check ensureHub() return value before WebSocket connect | Changed `.then(() => {` to `.then((ok) => {` with conditional: connect on `true`, set `connectionStatus("error")` on `false`. File: `agent-hub/gui/src/App.tsx:18-24` | Pass | claude - 2026-02-14 |
| EI-4 | Add React ErrorBoundary to GUI | Created `ErrorBoundary.tsx` class component with `getDerivedStateFromError`, `componentDidCatch`, fallback UI (error message + Reload button). Wrapped `<App />` in `main.tsx` with `<ErrorBoundary>`. Files: `agent-hub/gui/src/components/ErrorBoundary.tsx` (new), `agent-hub/gui/src/main.tsx` (modified) | Pass | claude - 2026-02-14 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| All four fixes implemented in a single pass. No deviations from plan. | claude - 2026-02-14 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All four execution items completed as planned with Pass outcomes. No VARs required.

**C1 (EI-1):** Git MCP `git_exec` now uses `shell=False` with `shlex.split()` for argument parsing. Shell metacharacters are blocked at the validation layer. Chained commands (`&&`, `||`) are parsed and executed sequentially with correct short-circuit semantics.

**C2 (EI-2):** CORS origins restricted from wildcard to three specific GUI origins.

**H2 (EI-3):** `ensureHub()` return value is now checked; failure sets connection status to `"error"` instead of attempting blind WebSocket connection.

**H3 (EI-4):** React ErrorBoundary wraps the root component, preventing white-screen crashes and displaying diagnostic fallback UI.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-004:** Document Execution
- **Session-2026-02-14-001:** Code review document (findings C1, C2, H2, H3)

---

**END OF DOCUMENT**
