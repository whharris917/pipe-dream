---
title: Git MCP Server for Container Operations
revision_summary: Initial draft
---

# CR-054: Git MCP Server for Container Operations

## 1. Purpose

Enable agents running in Docker containers to execute git commands on the host's pipe-dream repository via a controlled MCP interface, while protecting submodules from modification and blocking destructive operations.

---

## 2. Scope

### 2.1 Context

Independent infrastructure improvement identified during multi-agent container architecture design (Session 2026-02-03-003). Containers mount pipe-dream as read-only, which prevents all git operations (the `.git/` directory is read-only). A host-side MCP server is needed to proxy git commands.

- **Parent Document:** None

### 2.2 Changes Summary

Create a new Git MCP server that:
- Accepts git command strings from containers via HTTP transport
- Validates commands to block submodule references and destructive operations
- Executes validated commands on the host's pipe-dream repository
- Returns command output to the caller

### 2.3 Files Affected

- `git-mcp/` - New directory for Git MCP server
- `git-mcp/server.py` - MCP server implementation
- `git-mcp/requirements.txt` - Python dependencies
- `docker/scripts/start-git-mcp.sh` - Startup script
- `docker/README.md` - Documentation updates
- `CLAUDE.md` - Documentation updates

---

## 3. Current State

Agents in containers cannot execute any git commands. The pipe-dream repository is mounted read-only, including the `.git/` directory. Even commands like `git status` that don't modify tracked files fail because git cannot write to its internal data structures (index, objects, refs).

---

## 4. Proposed State

A Git MCP server runs on the host alongside the QMS MCP server. Agents in containers can call `git_exec(command)` to execute git commands on the host. Commands referencing submodules (flow-state, qms-cli) or using destructive flags are blocked. All other git operations pass through and execute normally.

---

## 5. Change Description

### 5.1 MCP Server Architecture

The Git MCP server follows the same pattern as the QMS MCP server:
- Python-based using the MCP SDK
- Streamable HTTP transport for container access
- Runs on a configurable port (default: 8001)
- Executes in the pipe-dream repository root

```
Container                              Host
─────────                              ────
Agent
  │
  └─► git_exec(command)  ──────────►   Git MCP Server (:8001)
                                           │
                                           ├─► Validate command
                                           ├─► Execute: git {command}
                                           └─► Return stdout/stderr
```

### 5.2 Command Interface

Single tool with pass-through semantics:

| Tool | Parameters | Description |
|------|------------|-------------|
| `git_exec` | `command: str` | Execute git command(s) with validation |

The command parameter accepts full git command strings including chained commands:

```python
git_exec("status")
git_exec("add .claude/sessions/ && commit -m 'Session notes' && push")
git_exec("log --oneline -10")
```

Note: The `git` prefix is optional; the server prepends it if missing.

### 5.3 Validation Rules

**Blocked Patterns (Submodule Protection):**

| Pattern | Rationale |
|---------|-----------|
| `flow-state` | Submodule - changes must go through proper PR workflow |
| `qms-cli` | Submodule - changes must go through proper PR workflow |

**Blocked Patterns (Destructive Operations):**

| Pattern | Rationale |
|---------|-----------|
| `push --force` | Rewrites remote history |
| `push -f` | Shorthand for --force |
| `reset --hard` | Discards uncommitted changes |
| `clean -f` | Deletes untracked files |
| `checkout .` | Discards working tree changes |
| `restore .` | Discards working tree changes |

**Implementation:**

```python
import re
import shlex
import subprocess

BLOCKED_SUBMODULES = [r'\bflow-state\b', r'\bqms-cli\b']
BLOCKED_DESTRUCTIVE = [
    r'push\s+.*--force',
    r'push\s+-[a-zA-Z]*f',
    r'reset\s+--hard',
    r'clean\s+-[a-zA-Z]*f',
    r'checkout\s+\.',
    r'restore\s+\.',
]

def validate_command(command: str) -> None:
    """Raise PermissionError if command is blocked."""
    for pattern in BLOCKED_SUBMODULES:
        if re.search(pattern, command, re.IGNORECASE):
            raise PermissionError(f"Blocked: command references protected submodule")

    for pattern in BLOCKED_DESTRUCTIVE:
        if re.search(pattern, command, re.IGNORECASE):
            raise PermissionError(f"Blocked: destructive operation not permitted")

def git_exec(command: str) -> str:
    """Execute git command(s) with validation."""
    validate_command(command)

    # Ensure command starts with 'git'
    if not command.strip().startswith('git'):
        command = f"git {command}"

    result = subprocess.run(
        ["bash", "-c", command],
        capture_output=True,
        cwd=PROJECT_ROOT,
        timeout=60
    )

    output = result.stdout.decode() + result.stderr.decode()
    if result.returncode != 0:
        return f"[Exit code: {result.returncode}]\n{output}"
    return output
```

### 5.4 Container Configuration

Containers connect to the Git MCP server via HTTP:

```bash
claude mcp add --transport http git http://host.docker.internal:8001/mcp
```

Or via `.mcp.json` baked into the container image:

```json
{
  "mcpServers": {
    "qms": {
      "type": "http",
      "url": "http://host.docker.internal:8000/mcp"
    },
    "git": {
      "type": "http",
      "url": "http://host.docker.internal:8001/mcp"
    }
  }
}
```

---

## 6. Justification

- **Problem:** Agents in containers cannot commit session notes, CR execution evidence, or other work products to git because the repository is mounted read-only
- **Impact of not making this change:** All git operations must be performed manually by the Lead, or containers must be given write access to the repository (which defeats the security model)
- **Solution:** A controlled proxy that allows git operations while enforcing submodule protection and blocking destructive commands

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `git-mcp/server.py` | Create | MCP server implementation |
| `git-mcp/requirements.txt` | Create | Python dependencies |
| `git-mcp/__init__.py` | Create | Package marker |
| `docker/scripts/start-git-mcp.sh` | Create | Startup script |
| `docker/.mcp.json` | Modify | Add git MCP server endpoint |
| `docker/README.md` | Modify | Document git MCP server |
| `CLAUDE.md` | Modify | Document git MCP usage |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | — | No QMS documents affected |

### 7.3 Other Impacts

- Containers will have a new MCP server to connect to
- Host must run two MCP servers (QMS on :8000, Git on :8001)
- Startup scripts should be updated to start both servers

---

## 8. Testing Summary

- **Allowed operations:** Verify `status`, `add`, `commit`, `push`, `log`, `diff`, `stash`, `branch` work correctly
- **Chained commands:** Verify `add && commit && push` chains execute correctly
- **Submodule blocking:** Verify commands referencing `flow-state` or `qms-cli` are rejected
- **Destructive blocking:** Verify `push --force`, `reset --hard`, `clean -f` are rejected
- **Error handling:** Verify failed git commands return appropriate error messages

---

## 9. Implementation Plan

### 9.1 Phase 1: Create Git MCP Server

1. Create `git-mcp/` directory structure
2. Implement `server.py` with `git_exec` tool
3. Implement validation logic for submodule and destructive patterns
4. Create `requirements.txt` with MCP SDK dependency
5. Test server locally

### 9.2 Phase 2: Container Integration

1. Create `docker/scripts/start-git-mcp.sh` startup script
2. Update `docker/.mcp.json` to include git MCP endpoint
3. Test from inside container

### 9.3 Phase 3: Documentation

1. Update `docker/README.md` with git MCP server instructions
2. Update `CLAUDE.md` with git MCP usage section

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Create `git_mcp/` directory structure and `server.py` | Created `git_mcp/server.py` with FastMCP server, `git_exec` tool, validation logic, CLI argument parsing, and transport support. | Pass | claude - 2026-02-04 |
| EI-2 | Implement validation logic (submodule + destructive patterns) | Implemented `validate_command()` with regex patterns for submodules (`flow-state`, `qms-cli`) and destructive ops (`push --force`, `reset --hard`, `clean -f`, `checkout .`, `restore .`). | Pass | claude - 2026-02-04 |
| EI-3 | Create `requirements.txt` and `__init__.py` | Created `git_mcp/requirements.txt` (mcp>=1.0.0), `git_mcp/__init__.py` (version 0.1.0), `git_mcp/__main__.py` (module entry point). | Pass | claude - 2026-02-04 |
| EI-4 | Test server locally on host | Tested validation: `status` passes, `add flow-state/` blocked with submodule error, `push --force` blocked with destructive error. All tests pass. | Pass | claude - 2026-02-04 |
| EI-5 | Create `docker/scripts/start-git-mcp.sh` | Created startup script with foreground/background modes, PID file management, and proper project root detection. Made executable. | Pass | claude - 2026-02-04 |
| EI-6 | Update `docker/.mcp.json` with git endpoint | Added `git` server entry pointing to `http://host.docker.internal:8001/mcp`. | Pass | claude - 2026-02-04 |
| EI-7 | Test from inside container | All 4 tests passed. (1) `git status` returned branch info and modified files. (2) `git log --oneline -3` returned commits f4b6102, c9086c7, ca83bda. (3) `add flow-state/` blocked with submodule error. (4) `push --force` blocked with destructive error. | Pass | lead - 2026-02-04 |
| EI-8 | Update `docker/README.md` | Added "Git Operations from Containers" section with startup instructions, usage examples, and protected operations list. Added CR-054 to references. | Pass | claude - 2026-02-04 |
| EI-9 | Update `CLAUDE.md` with git MCP usage | Added "Git MCP Server" section after QMS MCP section. Updated Container Infrastructure to list `start-git-mcp.sh`. | Pass | claude - 2026-02-04 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| Directory named `git_mcp/` (underscore) for Python package compatibility, not `git-mcp/` (hyphen) as originally planned. | claude - 2026-02-04 |
| Additional fixes required during container testing: (1) `docker/scripts/start-mcp-server.sh` needed to cd into qms-cli/ before running module. (2) Script needed `--background` flag support with PID management. (3) `docker/.claude-settings.json` needed "git" added to `enabledMcpjsonServers`. (4) `docker/entrypoint.sh` needed Git MCP registration block. (5) `git_mcp/server.py` changed from `bash -c` to `shell=True` for Windows compatibility. | claude - 2026-02-04 |

---

## 11. Execution Summary

All execution items complete. The Git MCP server is implemented and fully tested from inside a Docker container.

**Results:**
- Normal git operations (`status`, `log`) work correctly
- Submodule protection blocks references to `flow-state` and `qms-cli`
- Destructive command protection blocks `push --force` and similar operations

**Deviations from plan:**
1. Directory named `git_mcp/` instead of `git-mcp/` for Python package compatibility
2. Additional container integration work required: settings enablement, entrypoint registration, Windows shell compatibility

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-005:** Code Governance
- **Session 2026-02-03-003:** Multi-agent container architecture design (context)

---

**END OF DOCUMENT**
