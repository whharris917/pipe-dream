---
title: Streamline Container Session Startup
revision_summary: 'Session 2026-02-03: BOTH ISSUES RESOLVED. Auth persistence via
  CLAUDE_CONFIG_DIR + named volume. MCP auto-connect via multiple headers workaround
  (GitHub #7290). Zero-friction container startup achieved.'
---

# CR-052: Streamline Container Session Startup

## 1. Purpose

Reduce the friction of starting a Claude session in a container from a multi-step, multi-terminal process to a single command.

---

## 2. Scope

### 2.1 Context

The containerization infrastructure (CR-042 through CR-048) is complete and operational, but starting a container session requires multiple manual steps across two terminals. This CR streamlines the startup process to make containerized sessions the default, low-friction way to interact with Claude.

- **Parent Document:** None (usability improvement)

### 2.2 Changes Summary

1. Add `working_dir: /pipe-dream` to docker-compose.yml so Claude finds MCP config automatically
2. Create a unified startup script that handles MCP server and container lifecycle
3. Update documentation to reflect the simplified process

### 2.3 Files Affected

- `claude-session.sh` (new) - Single entry point script at repo root
- `docker/docker-compose.yml` - Add `working_dir: /pipe-dream`
- `docker/CONTAINER-GUIDE.md` - Update to reflect simplified startup
- `.gitignore` - Add transient files created by the script

---

## 3. Current State

Starting a containerized Claude session requires:

1. **Terminal 1:** Start MCP server manually and keep terminal open
   ```bash
   cd qms-cli
   python -m qms_mcp --transport streamable-http --host 0.0.0.0 --port 8000 --project-root "..."
   ```

2. **Terminal 2:** Start container and enter bash
   ```bash
   cd docker
   docker-compose up -d
   docker-compose exec claude-agent bash
   ```

3. **Inside container:** Configure MCP connection
   ```bash
   claude mcp add --transport http qms http://host.docker.internal:8000/mcp
   ```

4. **Inside container:** Start Claude
   ```bash
   claude
   ```

This process:
- Requires two terminals (MCP server must remain running in foreground)
- Requires remembering multiple commands
- Requires manual MCP configuration inside the container each session
- Creates friction that discourages container use

---

## 4. Proposed State

Starting a containerized Claude session requires one command:

```bash
./claude-session.sh
```

This command:
- Starts the MCP server in background (if not already running)
- Starts the container (if not already running)
- Launches Claude Code with MCP automatically configured

The user is immediately in a Claude session with full QMS MCP access.

---

## 5. Change Description

### 5.1 How Claude Code Discovers MCP Configuration

Research based on [official documentation](https://code.claude.com/docs/en/settings) and [GitHub issue #4976](https://github.com/anthropics/claude-code/issues/4976) revealed:

| File | Scope | Discovery |
|------|-------|-----------|
| `.mcp.json` | Project | Discovered in **project root** (working directory) |
| `.claude/settings.local.json` | Project | Discovered in project root, contains `enabledMcpjsonServers` |

**Root cause of current friction:** The container starts Claude at `/` (per Dockerfile WORKDIR), but the MCP config is mounted at `/pipe-dream/.mcp.json`. Claude doesn't find it because `/` is not the project root.

**Solution:** Add `working_dir: /pipe-dream` to docker-compose.yml. This makes Claude start in `/pipe-dream/`, where it will find:
- `/pipe-dream/.mcp.json` (HTTP transport config for container)
- `/pipe-dream/.claude/settings.local.json` (with `enabledMcpjsonServers: ["qms"]`)

This eliminates the need for manual `claude mcp add` entirely.

### 5.2 MCP Auto-Connect via User Scope

**Problem discovered during testing:** Project-scoped MCP servers require user approval before auto-connecting. The approval state is stored in `~/.claude.json` keyed by project path. Since the container sees `/pipe-dream` while the host sees `C:/Users/wilha/projects/pipe-dream`, there's no shared approval state—the container can never inherit the host's approval.

**Solution:** Pre-configure the MCP server at **user scope** in the container's `/.claude.json`:

```json
{
  "mcpServers": {
    "qms": {
      "type": "http",
      "url": "http://host.docker.internal:8000/mcp"
    }
  }
}
```

User-scoped MCP servers (defined at root level in `~/.claude.json`) auto-connect immediately without approval prompts. The Dockerfile copies `docker/.claude-container.json` to `/.claude.json` to establish this configuration.

**Two-tier configuration:**
- `/.claude.json` (user scope): Auto-connects the QMS MCP server
- `/pipe-dream/.mcp.json` (project scope): Kept for reference/fallback

### 5.3 Auth Persistence via CLAUDE_CONFIG_DIR

**Problem discovered during testing:** Simply mounting `~/.claude/.credentials.json` is insufficient for auth persistence. Claude Code stores authentication state across multiple files.

**Solution per [GitHub issue #1736](https://github.com/anthropics/claude-code/issues/1736):** Use the `CLAUDE_CONFIG_DIR` environment variable to point Claude Code at a persistent directory. This was confirmed as the correct approach by an Anthropic contributor.

**Implementation:**
1. Add named Docker volume `claude-config` for persistent storage
2. Set `CLAUDE_CONFIG_DIR=/claude-config` environment variable
3. Create `entrypoint.sh` that copies initial MCP config on first run

**Behavior:**
- First container start: User authenticates once, credentials stored in volume
- Subsequent starts: Credentials persist, no re-authentication required
- MCP config: Initialized by entrypoint script, persists in volume

### 5.4 Docker Compose Change

Add one line to `docker/docker-compose.yml`:

```yaml
services:
  claude-agent:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /pipe-dream          # <-- ADD THIS LINE
    volumes:
      # ... existing mounts unchanged ...
```

### 5.5 Unified Startup Script

Create `claude-session.sh` at the repository root:

1. Check if MCP server is running on port 8000
2. If not, start it in background (with PID file and log file)
3. Ensure container is running (`docker-compose up -d`)
4. Exec into container and run `claude`

The script will be idempotent - safe to run whether services are already running or not.

---

## 6. Justification

- **Friction reduction:** Current process discourages container use; streamlining makes it the natural default
- **Error reduction:** Manual steps are error-prone; automation ensures consistent setup
- **Onboarding:** New users (or returning after absence) can start immediately without remembering the process

Impact of not making this change:
- Container sessions remain underused due to friction
- Users default to local Claude, missing isolation benefits
- Multi-step process continues to waste time each session

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `claude-session.sh` | Create | Unified startup script |
| `docker/docker-compose.yml` | Modify | Add `working_dir`, `CLAUDE_CONFIG_DIR`, named volume |
| `docker/Dockerfile` | Modify | Add entrypoint script, MCP config initialization |
| `docker/entrypoint.sh` | Create | First-run config initialization script |
| `docker/.claude-container.json` | Create | User-scoped MCP server config for container |
| `docker/CONTAINER-GUIDE.md` | Modify | Update Quick Start section |
| `.gitignore` | Modify | Add `.mcp-server.pid`, `.mcp-server.log` |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| None | - | No controlled documents affected |

### 7.3 Other Impacts

None - this CR modifies docker infrastructure only, not controlled code.

---

## 8. Testing Summary

Verification will be manual:

1. **Fresh start test:** Run `./claude-session.sh` with no MCP server or container running
2. **MCP verification:** Inside Claude, verify `qms_inbox` tool works
3. **Idempotency test:** Exit and re-run `./claude-session.sh` - should handle already-running services
4. **Platform test:** Verify script works in Windows Git Bash environment

---

## 9. Implementation Plan

### 9.1 Phase 1: Docker Configuration

1. Add `working_dir: /pipe-dream` to `docker/docker-compose.yml`
2. Verify manually that Claude finds MCP config without `claude mcp add`

### 9.2 Phase 2: Create Startup Script

1. Create `claude-session.sh` with MCP server startup logic
2. Add container startup logic
3. Add Claude exec logic
4. Test end-to-end

### 9.3 Phase 3: Documentation and Cleanup

1. Update `docker/CONTAINER-GUIDE.md` with new Quick Start
2. Add transient files to `.gitignore`
3. Final verification

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Add working_dir to docker-compose.yml | Added `working_dir: /pipe-dream` after `dockerfile: Dockerfile` line | Pass | claude - 2026-02-02 |
| EI-2 | Verify MCP auto-discovery works | MCP config found at `/pipe-dream/.mcp.json`. However, MCP doesn't auto-connect on Claude startup - user must run `/mcp` to reconnect. Config is discovered but connection is not automatic. | Partial | claude/lead - 2026-02-03 |
| EI-3 | Create claude-session.sh | Created script with MCP server startup, container startup, and claude exec logic | Pass | claude - 2026-02-02 |
| EI-4 | End-to-end testing | Multiple issues found and fixed during testing. See Execution Comments. Core infrastructure works but two UX issues remain: (1) auth required each session, (2) MCP reconnect required. | Partial | claude/lead - 2026-02-03 |
| EI-5 | Update CONTAINER-GUIDE.md | Updated Quick Start to single-command approach, moved manual steps to reference section | Pass | claude - 2026-02-02 |
| EI-6 | Update .gitignore | Added `.mcp-server.pid` and `.mcp-server.log` | Pass | claude - 2026-02-02 |
| EI-7 | Fix venv PATH issue in claude-session.sh | Windows venv activate script clobbers Git Bash PATH, breaking Unix utilities (sleep, curl, etc.). Fixed by calling Python directly instead of activating venv. | Pass | claude - 2026-02-03 |
| EI-8 | Fix MCP server HTTP status detection | MCP server returns HTTP 406 which curl treats as error. Fixed host-side and container-side checks to accept any HTTP response as success. | Pass | claude - 2026-02-03 |
| EI-9 | Add container MCP connectivity verification | Added step [3/4] to script - verifies container can reach MCP server before launching Claude. | Pass | claude - 2026-02-03 |
| EI-10 | Change credentials mount to read-write | Changed `:ro` to `:rw` to allow Claude Code to refresh OAuth tokens. Did not resolve auth issue. | Pass | claude - 2026-02-03 |
| EI-11 | Remove obsolete version attribute | Removed `version: '3.8'` from docker-compose.yml to eliminate deprecation warning. | Pass | claude - 2026-02-03 |
| EI-12 | Investigate authentication requirement | **ROOT CAUSE FOUND per [GitHub #1736](https://github.com/anthropics/claude-code/issues/1736):** Mounting only `.credentials.json` is insufficient. Claude Code requires the full config directory. **SOLUTION:** Use `CLAUDE_CONFIG_DIR` environment variable pointing to a persistent named volume. | Pass | claude - 2026-02-03 |
| EI-15 | Implement CLAUDE_CONFIG_DIR persistence | Added `CLAUDE_CONFIG_DIR=/claude-config` env var and `claude-config` named volume to docker-compose.yml. Created entrypoint.sh to initialize MCP config on first run. Auth and MCP config now persist across container restarts. | Pass | claude - 2026-02-03 |
| EI-13 | Investigate MCP auto-connect failure | **ROOT CAUSE FOUND:** Project-scoped MCP servers (`.mcp.json`) require approval stored in `~/.claude.json` per-project-path. Container has path `/pipe-dream` vs host `C:/Users/wilha/projects/pipe-dream`. Different paths = no inherited approval. **SOLUTION:** Added user-scoped MCP config at `/.claude.json`. User-scoped servers auto-connect without approval. | Pass | claude - 2026-02-03 |
| EI-14 | Implement user-scoped MCP auto-connect | Created `docker/.claude-container.json` with user-scoped MCP server config. Updated `Dockerfile` to copy it to `/.claude.json`. User-scoped servers bypass the project trust dialog. | Pass | claude - 2026-02-03 |
| EI-16 | Round 2 end-to-end testing | Clean slate test (down -v). First run: auth required (expected), MCP reconnect required. Second run: **NO auth prompt** (persistence works!), MCP reconnect still required. Auth persistence FIXED. MCP auto-connect remains an issue. | Partial | lead - 2026-02-03 |
| EI-17 | Investigate MCP auto-connect (Round 2) | Verified `/claude-config/.claude.json` contains correct user-scoped `mcpServers` config. Config persists correctly. Issue is Claude Code does not auto-connect to HTTP MCP servers on startup despite correct config. Likely Claude Code limitation/behavior with HTTP transport vs stdio. | N/A | claude - 2026-02-03 |
| EI-18 | Fix MCP auto-connect via multiple headers | **ROOT CAUSE per [GitHub #7290](https://github.com/anthropics/claude-code/issues/7290):** Claude Code ignores authentication headers and always attempts OAuth discovery first for HTTP transports. Our server returns 404 on OAuth endpoints, causing connection failure. **WORKAROUND:** Adding multiple headers (`X-API-Key` + `Authorization`) bypasses the OAuth discovery flow. Updated `docker/.mcp.json` and `docker/entrypoint.sh` with both headers. | Pass | claude - 2026-02-03 |
| EI-19 | Final end-to-end verification | Clean slate test with rebuilt container. MCP server auto-connected on startup without manual `/mcp` intervention. Zero-friction startup achieved. | Pass | lead - 2026-02-03 |
| EI-20 | Update documentation | Updated `docker/CONTAINER-GUIDE.md` and `docker/README.md` to reflect new architecture: single-command startup, auth persistence via named volume, MCP auto-connect via dual headers. Added references to CR-052 and GitHub issues. | Pass | claude - 2026-02-03 |
| EI-21 | Cleanup transient files | Deleted `mcp-test.log` (transient debug output from testing). | Pass | claude - 2026-02-03 |

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| EI-2 and EI-4 require user to test the container startup. User should run `./claude-session.sh` and verify MCP tools work. | claude - 2026-02-02 |
| **Session 2026-02-03 Testing Results:** Script initially failed - Windows venv activation destroys Git Bash PATH. Fixed in EI-7. | claude - 2026-02-03 |
| MCP server returns HTTP 406 (Not Acceptable) for raw GET requests. This is correct behavior but curl exits non-zero. Fixed checks to accept any HTTP response. | claude - 2026-02-03 |
| Added container-side MCP connectivity check as step [3/4]. Required `--max-time` and HTTP code parsing to handle docker-compose stderr warnings. | claude - 2026-02-03 |
| User tested twice with same results: (1) authentication required on Claude startup, (2) MCP shows initial connection failure, reconnects after `/mcp` command. Once reconnected, MCP tools work correctly (`qms_inbox` returns expected response). | lead - 2026-02-03 |
| Investigated auth issue: `/.claude/.credentials.json` exists (451 bytes), contains valid OAuth tokens, is writable. Claude Code creates additional state (cache, history, plugins, projects, todos) in `/.claude/`. Host `~/.claude/` contains much more state including project-specific session data (~330MB for pipe-dream project). Hypothesis: auth tokens may be machine-bound or require additional state not being mounted. | claude - 2026-02-03 |
| Investigated MCP issue: Container can reach `host.docker.internal:8000` (verified via curl returning HTTP 406). Config at `/pipe-dream/.mcp.json` is correct. Claude Code discovers the config (evidenced by `/mcp` showing `qms` server and successful reconnect). Issue appears to be startup timing or auto-connect behavior. | claude - 2026-02-03 |
| **MCP Auto-Connect Root Cause Analysis:** Per Claude Code documentation, project-scoped MCP servers (from `.mcp.json`) require user approval before auto-connecting. The approval state is stored in `~/.claude.json` under `projects.<project-path>.enabledMcpjsonServers`. Since the container sees project path `/pipe-dream` while host sees `C:/Users/wilha/projects/pipe-dream`, there's no shared approval state. The solution is to configure the MCP server at **user scope** (root `mcpServers` field in `~/.claude.json`) instead of project scope. User-scoped servers don't require approval and auto-connect immediately. | claude - 2026-02-03 |
| Created `docker/.claude-container.json` containing user-scoped MCP server definition. Updated `Dockerfile` to copy this file to `/.claude.json`. This pre-configures the QMS MCP server at user scope, bypassing the project trust dialog entirely. | claude - 2026-02-03 |
| **Auth Persistence Root Cause Analysis per [GitHub #1736](https://github.com/anthropics/claude-code/issues/1736):** Simply mounting `.credentials.json` is insufficient. Claude Code stores auth state across multiple files in `~/.claude/` and `~/.claude.json`. The confirmed solution from Anthropic contributor is to use `CLAUDE_CONFIG_DIR` environment variable pointing to a persistent volume. | claude - 2026-02-03 |
| Implemented `CLAUDE_CONFIG_DIR=/claude-config` with a Docker named volume `claude-config`. Created `entrypoint.sh` that copies initial MCP config to the volume on first run. First container start requires auth (stored in volume), subsequent starts reuse persisted credentials. | claude - 2026-02-03 |
| **Round 2 Test Results:** Clean slate test (`docker-compose down -v`). First run: auth required (expected), MCP showed failed and required `/mcp` reconnect. Second run: **NO authentication prompt - auth persistence confirmed working!** However, MCP still required `/mcp` reconnect. | lead - 2026-02-03 |
| Verified container config at `/claude-config/.claude.json` - user-scoped `mcpServers.qms` config is present and persists correctly. The MCP server URL and type are correct. Despite correct config, Claude Code does not auto-connect to HTTP transport MCP servers on startup. This appears to be a Claude Code limitation - stdio transport servers (spawned by Claude) auto-connect, but HTTP transport servers (external) require manual reconnect. | claude - 2026-02-03 |
| **Current State Summary:** (1) Single-command startup via `./claude-session.sh` - WORKING. (2) Auth persistence across sessions - FIXED. (3) MCP config persistence - WORKING. (4) MCP auto-connect on startup - NOT WORKING (Claude Code limitation). User must run `/mcp` once per session to reconnect. This is a significant UX improvement over the original multi-terminal, auth-every-time process. | claude - 2026-02-03 |
| **MCP Auto-Connect Root Cause per [GitHub #7290](https://github.com/anthropics/claude-code/issues/7290):** Claude Code has a bug where it ignores authentication headers configured in `.mcp.json` and always attempts OAuth2 Dynamic Client Registration first for HTTP transports. When our server returns 404 on OAuth discovery endpoints (`/.well-known/oauth-authorization-server`, etc.), Claude Code fails with "Invalid OAuth error response" and doesn't fall back to the configured headers. The documented workaround is to configure **multiple headers** - this bypasses the OAuth discovery flow entirely. | claude - 2026-02-03 |
| Added `X-API-Key: qms-internal` alongside existing `Authorization: Bearer internal-trusted` header in both `docker/.mcp.json` (project-scoped config) and `docker/entrypoint.sh` (user-scoped registration). The combination of two headers triggers the workaround. | claude - 2026-02-03 |
| **FINAL STATE:** All objectives achieved. Zero-friction container startup: `./claude-session.sh` starts MCP server, starts container, launches Claude with (1) persistent authentication and (2) auto-connected MCP server. No manual intervention required. | claude - 2026-02-03 |
| **FINAL VERIFICATION EVIDENCE (EI-19):** Clean slate test executed: `docker-compose down`, `docker volume rm docker_claude-config`, then `./claude-session.sh`. Upon running `/mcp` inside Claude, output confirmed success. See Section 10.1 for full evidence. | lead - 2026-02-03 |
| **Documentation Updates (EI-20):** Updated both `docker/CONTAINER-GUIDE.md` (+32 lines) and `docker/README.md` (+70/-32 lines) to document: (1) single-command Quick Start via `./claude-session.sh`, (2) auth persistence via `CLAUDE_CONFIG_DIR` + named volume, (3) MCP auto-connect via dual headers workaround, (4) updated filesystem structure and mounts table. Added CR-052 and GitHub issue references. | claude - 2026-02-03 |

---

### 10.1 Final Verification Evidence

**Test Protocol Executed:**
```bash
# Clean slate
cd docker
docker-compose down
docker volume rm docker_claude-config
cd ..

# Single-command startup
./claude-session.sh
```

**Result:** Inside Claude, `/mcp` command output:

```
╭─────────────────────────────────────────────────────────────────────────╮
│ Qms MCP Server                                                          │
│                                                                         │
│ Status: ✔ connected                                                     │
│ Auth: ✔ authenticated                                                   │
│ URL: http://host.docker.internal:8000/mcp                               │
│ Config location: /pipe-dream/.mcp.json                                  │
│ Capabilities: tools                                                     │
│ Tools: 19 tools                                                         │
╰─────────────────────────────────────────────────────────────────────────╯
```

**Verification:**
- `Status: ✔ connected` — MCP auto-connected without manual `/mcp` reconnection
- `Auth: ✔ authenticated` — Authentication successful
- `Config location: /pipe-dream/.mcp.json` — Correct config discovered
- `Tools: 19 tools` — All QMS MCP tools available

**Second Run (Auth Persistence Test):**

After exiting the first session, executed `./claude-session.sh` again:

- **No browser authentication required** — Claude started immediately without OAuth prompt
- **MCP auto-connected** — Same `Status: ✔ connected` result

This confirms both CR objectives are fully achieved:

1. **Auth persistence** — First run requires browser OAuth (expected), subsequent runs skip authentication entirely
2. **MCP auto-connect** — Every run auto-connects to QMS MCP server without manual `/mcp` intervention

The single command `./claude-session.sh` now provides true zero-friction container session startup.

---

## 11. Execution Summary

**Objective:** Reduce container session startup from a multi-step, multi-terminal process to a single command with automatic MCP connectivity.

**Outcome:** All objectives achieved. `./claude-session.sh` provides zero-friction container startup.

**Key Technical Solutions:**

| Problem | Root Cause | Solution | Reference |
|---------|------------|----------|-----------|
| Auth required every session | Claude Code needs full config directory, not just credentials | `CLAUDE_CONFIG_DIR=/claude-config` + named Docker volume | [GitHub #1736](https://github.com/anthropics/claude-code/issues/1736) |
| MCP requires manual reconnect | Claude Code ignores auth headers, attempts OAuth discovery first | Multiple headers (`X-API-Key` + `Authorization`) bypass OAuth flow | [GitHub #7290](https://github.com/anthropics/claude-code/issues/7290) |

**Files Created/Modified:**

| File | Change |
|------|--------|
| `claude-session.sh` | Created - unified startup script |
| `docker/docker-compose.yml` | Added `working_dir`, `CLAUDE_CONFIG_DIR`, named volume |
| `docker/entrypoint.sh` | Created - first-run MCP config initialization |
| `docker/.mcp.json` | Added dual headers for OAuth bypass |
| `docker/.claude-settings.json` | Created - project-scoped MCP enablement |

**Verification:** Clean slate test (`docker volume rm`) followed by `./claude-session.sh` confirmed:
- First run: Browser auth (expected), MCP auto-connected
- Second run: No auth prompt, MCP auto-connected

See Section 10.1 for detailed evidence.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **CR-042:** Add Remote Transport Support to QMS MCP Server
- **CR-043:** Implement Containerized Claude Agent Infrastructure
- **CR-046:** Containerization Infrastructure Operational Verification
- **CR-047:** MCP Server Streamable-HTTP Transport Support
- **docker/CONTAINER-GUIDE.md:** Current manual process documentation
- **Claude Code Settings Documentation:** https://code.claude.com/docs/en/settings
- **GitHub Issue #4976:** MCP configuration file location
- **GitHub Issue #1736:** Container auth persistence solution (CLAUDE_CONFIG_DIR)
- **GitHub Issue #7290:** HTTP/SSE MCP transport ignores authentication headers (multiple headers workaround)

---

**END OF DOCUMENT**
