---
title: 'MCP Server Alignment: Add Withdraw Tool'
revision_summary: Updated for combined requalification with CR-065. Removed unit test
  fix (already corrected). Updated file paths (qms_mcp module restructured). Updated
  RS/RTM version numbers and qualified baseline.
---

# CR-049: MCP Server Alignment: Add Withdraw Tool

## 1. Purpose

Align the QMS MCP server with CR-048 by adding the `qms_withdraw` tool.

---

## 2. Scope

### 2.1 Context

CR-048 added the `withdraw` CLI command but did not add the corresponding MCP tool. Per REQ-MCP-007 (Functional Equivalence), each CLI command should have a corresponding MCP tool.

- **Parent Document:** CR-048 (follow-up alignment)

### 2.2 Changes Summary

1. **qms_withdraw MCP tool** - Add new tool to expose withdraw functionality via MCP
2. **RS update** - Add `qms_withdraw` to REQ-MCP-004 workflow tools list
3. **Equivalence test** - Add qualification test for `qms_withdraw`

### 2.3 Files Affected

- `qms-cli/qms_mcp/tools.py` -- Add `qms_withdraw` tool registration
- `qms-cli/tests/qualification/test_mcp.py` -- Add `qms_withdraw` equivalence test, update tool count assertion

---

## 3. Current State

1. The MCP server exposes 19 tools but does not include `qms_withdraw`
2. The `withdraw` CLI command exists (added in CR-048) but has no MCP equivalent
3. REQ-MCP-004 lists 5 workflow tools (`qms_route`, `qms_assign`, `qms_review`, `qms_approve`, `qms_reject`) but does not include `qms_withdraw`

---

## 4. Proposed State

1. The MCP server exposes 20 tools including `qms_withdraw`
2. `qms_withdraw` provides functional equivalence to the CLI `withdraw` command
3. REQ-MCP-004 lists 6 workflow tools including `qms_withdraw`

---

## 5. Change Description

### 5.1 REQ-MCP-004 Update: Add qms_withdraw Tool

Add `qms_withdraw` to the workflow tools category in the Requirements Specification. The tool shall:
- Accept parameters: `doc_id` (required), `user` (optional, default "claude")
- Map to CLI: `["withdraw", doc_id]`
- Return structured response matching CLI output

### 5.2 Implementation Pattern

The implementation follows the same pattern as other workflow tools in `tools.py`:

```python
async def qms_withdraw(doc_id: str, user: str = "claude") -> str:
    args = ["withdraw", doc_id]
    return await run_qms_command(args, user)
```

---

## 6. Justification

- **MCP alignment:** REQ-MCP-007 requires functional equivalence between CLI and MCP tools. The withdraw command is the only CLI command without an MCP equivalent.
- **Low risk:** Straightforward addition following established patterns.

Impact of not making this change:
- MCP users (containerized agents) cannot use withdraw functionality, requiring CLI fallback.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms-cli/qms_mcp/tools.py` | Modify | Add `qms_withdraw` tool |
| `qms-cli/tests/qualification/test_mcp.py` | Modify | Add withdraw equivalence test, update tool count (19 -> 20) |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Modify | Update REQ-MCP-004 to include `qms_withdraw` (v7.0 -> v8.0) |
| SDLC-QMS-RTM | Modify | Update qualified baseline and verification evidence (v9.0 -> v10.0) |

### 7.3 Other Impacts

None -- backward compatible addition.

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development follows established controls:

1. **Test environment isolation:** Development in a non-QMS-controlled directory (e.g., `.test-env/` or `/projects/` for containerized agents)
2. **Branch isolation:** All development on branch `cr-049-065-requalification` (shared with CR-065)
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new/modified requirements must have passing tests before merge
5. **CI verification:** Tests must pass on GitHub Actions for dev branch
6. **PR gate:** Changes merge to main only via PR after RS/RTM approval
7. **Submodule update:** Parent repo updates pointer only after PR merge

### 7.5 Qualified State Continuity

| Phase | main branch | RS/RTM Status | Qualified Release |
|-------|-------------|---------------|-------------------|
| Before CR | Commit 63123fe | EFFECTIVE RS v7.0 / RTM v9.0 | QMS-CLI current |
| During execution | Unchanged | RS/RTM checked out for updates | QMS-CLI current (unchanged) |
| Post-approval | Merged from cr-049-065-requalification | EFFECTIVE RS v8.0 / RTM v10.0 | QMS-CLI next |

Note: This CR shares a requalification branch, CI run, RTM update, and PR merge with CR-065. Both CRs reference the same qualified commit hash.

---

## 8. Testing Summary

Qualification tests will verify:

1. `test_qms_withdraw_equivalence` -- MCP tool produces equivalent results to CLI
2. `test_register_tools_creates_all_tools` -- Updated to verify 20 tools (was 19)
3. Full requalification: all tests passing at qualified commit (combined with CR-065 changes)

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Clone/update qms-cli to a non-QMS-controlled working directory
2. Create and checkout branch `cr-049-065-requalification` (shared with CR-065)
3. Verify clean test environment (all existing tests pass)

### 9.2 Phase 2: Requirements (RS Update)

1. Checkout SDLC-QMS-RS
2. Update REQ-MCP-004 to include `qms_withdraw` in workflow tools list
3. Checkin RS, route for review and approval

### 9.3 Phase 3: Implementation

1. Add `qms_withdraw` tool to `qms_mcp/tools.py`
2. Add `test_qms_withdraw_equivalence` to `test_mcp.py`
3. Update tool count assertion in `test_register_tools_creates_all_tools` (19 -> 20)

### 9.4 Phase 4: Qualification

1. Run full test suite, verify all tests pass (combined with CR-065 changes)
2. Push to dev branch
3. Verify GitHub Actions CI passes
4. Document qualified commit hash

### 9.5 Phase 5: RTM Update and Approval

1. Checkout SDLC-QMS-RTM
2. Update qualified baseline with CI-verified commit, updated test counts, and RS version
3. Checkin RTM, route for review and approval
4. **Verify RTM reaches EFFECTIVE status before proceeding to Phase 6**

### 9.6 Phase 6: Merge and Submodule Update

**Prerequisite:** RS and RTM must be EFFECTIVE before proceeding (per SOP-006 Section 7.4).

1. Verify RS and RTM are EFFECTIVE
2. Create PR to merge `cr-049-065-requalification` to main
3. Merge PR
4. Update submodule pointer in parent repo
5. Verify MCP withdraw works in production context

Note: Phases 1, 4, 5, and 6 are shared with CR-065 and executed once for both CRs.

---

## 10. Execution

<!--
EXECUTION PHASE INSTRUCTIONS
============================
NOTE: Do NOT delete this comment block. It provides guidance for execution.

- Sections 1-9 are PRE-APPROVED content - do NOT modify during execution
- Only THIS TABLE and the comment sections below should be edited during execution phase

COLUMNS:
- EI: Execution item identifier
- Task Description: What to do (static, from Implementation Plan)
- Execution Summary: Narrative of what was done, evidence, observations (editable)
- Task Outcome: Pass or Fail (editable)
- Performed By - Date: Signature (editable)

TASK OUTCOME:
- Pass: Task completed as planned
- Fail: Task could not be completed as planned - attach VAR with explanation

VAR TYPES (see VAR-TEMPLATE):
- Type 1: Use when the failed task is critical to CR objectives
- Type 2: Use when impact is contained and CR can conceptually close

EXECUTION SUMMARY EXAMPLES:
- "Implemented per plan. Commit abc123."
- "Modified src/module.py:45-67. Unit tests passing."
- "Created SOP-007 (now EFFECTIVE)."
-->

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Setup test environment: create shared branch `cr-049-065-requalification` | Updated `.test-env/qms-cli` to main (b3d0c58), created branch `cr-049-065-requalification`. Baseline: 364/364 tests passing. | Pass | claude - 2026-02-08 |
| EI-2 | RS update: add `qms_withdraw` to REQ-MCP-004, route for review/approval | Added `qms_withdraw` to REQ-MCP-004 workflow tools list. SDLC-QMS-RS reviewed (QA recommend), approved: v7.0 -> v8.0 EFFECTIVE. | Pass | claude - 2026-02-08 |
| EI-3 | Implement `qms_withdraw` in `qms_mcp/tools.py` | Added `qms_withdraw` tool following established pattern: `["withdraw", doc_id]`. Placed in REQ-MCP-004 section. | Pass | claude - 2026-02-08 |
| EI-4 | Add `qms_withdraw` equivalence test, update tool count assertion (19 -> 20) | Added `test_qms_withdraw_equivalence` (CLI) and `test_qms_withdraw_mcp_layer` (arg mapping). Updated expected tool count 19 -> 20. | Pass | claude - 2026-02-08 |
| EI-5 | Run full test suite, push to dev branch, verify CI passes (combined with CR-065) | 369/369 tests passing locally and on CI. Commit 2fed599. CI run: 21803124788. | Pass | claude - 2026-02-08 |
| EI-6 | Update SDLC-QMS-RTM qualified baseline, route for review/approval (combined with CR-065) | Updated baseline to commit 2fed599, 369/369 tests, RS v8.0. QA found 3 corrections needed (per-file counts, Section 1 RS version, REQ-MCP-001 tool count). Corrected and re-reviewed. RTM v9.0 -> v10.0 EFFECTIVE. | Pass | claude - 2026-02-08 |
| EI-7 | Merge PR to main, update submodule pointer in parent repo (combined with CR-065) | PR #8 merged (admin, branch protection). Merge commit 32324af. Submodule updated in parent repo. | Pass | claude - 2026-02-08 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| Combined requalification with CR-065. Shared branch, CI, RTM, and PR. Qualified commit: 2fed599. | claude - 2026-02-08 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 7 execution items completed successfully. Added `qms_withdraw` MCP tool, updated RS REQ-MCP-004 (v8.0), verified with 369/369 tests passing (CI run 21803124788, commit 2fed599). RTM updated to v10.0. PR #8 merged to main. Combined requalification with CR-065.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-005:** Code Governance
- **SOP-006:** SDLC Governance
- **CR-048:** Workflow Improvements (parent -- added withdraw CLI command)
- **CR-065:** Fix MCP qms_review argument mapping (combined requalification)
- **SDLC-QMS-RS v7.0:** QMS CLI Requirements Specification (REQ-MCP-004, REQ-MCP-007)
- **SDLC-QMS-RTM v9.0:** QMS CLI Requirements Traceability Matrix
- **Session 2026-02-08-001:** Combined requalification planning

---

**END OF DOCUMENT**
