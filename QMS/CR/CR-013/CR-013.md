---
title: 'Implement INV-003-CAPA-3 and CAPA-4: Audit Trail and Execution Phase Tracking'
---

# CR-013: Implement INV-003-CAPA-3 and CAPA-4: Audit Trail and Execution Phase Tracking

## 1. Purpose

This Change Record implements corrective actions CAPA-3 and CAPA-4 from INV-003, addressing audit trail gaps and the post-execution checkout workflow bug.

---

## 2. Scope

### 2.1 Parent Investigation

- **INV-003:** CR-012 Workflow Deficiencies and QMS Permission Gaps

### 2.2 CAPAs Addressed

| CAPA | Finding | Description | Priority |
|------|---------|-------------|----------|
| CAPA-3 | 4.4 | Add status transition logging to audit trail | MEDIUM |
| CAPA-4 | 4.5 | Implement execution phase tracking in checkout/checkin/route | HIGH |

### 2.3 Files Affected

- `.claude/qms.py` — Core QMS CLI (status change logging, execution_phase routing)
- `.claude/qms_meta.py` — Metadata management (execution_phase field, checkin preservation)

---

## 3. Rationale

### 3.1 CAPA-3: Audit Trail Gaps

**Problem:** Status transitions are applied to `.meta` files but not explicitly logged in the audit trail. For example, the RELEASE event is logged, but there is no record of the status changing from PRE_APPROVED to IN_EXECUTION.

**Impact:** Incomplete audit history makes it difficult to reconstruct the document lifecycle during audits or investigations.

**Solution:** Add a `log_status_change()` function and call it whenever status changes in `.meta`, or enhance existing event logs to include `from_status` and `to_status` fields.

### 3.2 CAPA-4: Post-Execution Checkout Workflow Bug

**Problem:** When a document in POST_REVIEWED status is checked out (e.g., to address reviewer comments), the checkout/checkin cycle resets the document to DRAFT. Re-routing then sends it to IN_PRE_REVIEW instead of the correct post-execution workflow path.

**Impact:** Documents requiring post-review corrections must incorrectly traverse the entire pre-review/pre-approval cycle again, causing workflow confusion and incorrect state.

**Solution:** Implement execution phase tracking:
1. Add `execution_phase` field to `.meta`:
   - Non-executable documents: `null` (always)
   - Executable documents before release: `"pre_release"`
   - Executable documents after release: `"post_release"`
2. Initialize to `"pre_release"` when creating executable documents
3. Set to `"post_release"` when RELEASE occurs
4. Preserve this field across checkout/checkin operations
5. Use this field in `cmd_route()` to determine correct workflow path

---

## 4. Implementation Plan

### 4.1 CAPA-3: Status Transition Logging

1. Create `log_status_change(doc_id, from_status, to_status, user)` function in qms.py
2. Call this function in all places where `.meta` status is modified:
   - `cmd_route()` — when routing changes status
   - `cmd_review()` — when all reviews complete (triggers status transition)
   - `cmd_approve()` — when all approvals complete
   - `cmd_reject()` — when rejection occurs
   - `cmd_release()` — when releasing for execution
   - `cmd_close()` — when closing document
3. Audit log entry format:
   ```json
   {"ts": "...", "event": "STATUS_CHANGE", "user": "...", "from_status": "...", "to_status": "...", "version": "..."}
   ```

### 4.2 CAPA-4: Execution Phase Tracking

1. Add `execution_phase` field to metadata schema (qms_schema.py or inline in qms.py)
   - Valid values: `null`, `"pre_release"`, `"post_release"`
   - Non-executable documents: always `null`
   - Executable documents: always non-null (`"pre_release"` or `"post_release"`)
2. Modify `cmd_create()`:
   - For executable document types (CR, INV, TP, ER): set `execution_phase = "pre_release"`
   - For non-executable document types (SOP, RS, RTM, etc.): set `execution_phase = null`
3. Modify `cmd_release()`:
   - Set `execution_phase = "post_release"` when releasing document
4. Modify `cmd_checkout()`:
   - Preserve `execution_phase` value (do not reset)
5. Modify `cmd_checkin()`:
   - Preserve `execution_phase` value
   - When checking in from POST_REVIEWED or similar post-execution states, maintain status context
6. Modify `cmd_route()`:
   - Check `execution_phase` field
   - If `"post_release"` and routing for review, route to IN_POST_REVIEW (not IN_PRE_REVIEW)
   - If `"post_release"` and routing for approval, route to IN_POST_APPROVAL (not IN_PRE_APPROVAL)

---

## 5. Testing Summary

- Verify status change events appear in audit trail for all transitions
- Test checkout/checkin cycle from POST_REVIEWED status
- Verify re-routing after post-execution checkout goes to correct workflow phase
- Verify execution_phase persists across checkout/checkin

---

## 6. Execution

| EI | Description | Status | Evidence | Follow-up |
|----|-------------|--------|----------|-----------|
| EI-1 | Implement log_status_change() function | COMPLETE | Already exists in `qms_audit.py:297-311` | |
| EI-2 | Add STATUS_CHANGE logging to all status-modifying commands | COMPLETE | Added to: `cmd_route()`, `cmd_review()`, `cmd_approve()`, `cmd_reject()`, `cmd_release()`, `cmd_close()` in qms.py | |
| EI-3 | Add execution_phase field to metadata schema | COMPLETE | Added to `create_initial_meta()` in `qms_meta.py:105` | |
| EI-4 | Update cmd_create() to initialize execution_phase (pre_release for executable, null for non-executable) | COMPLETE | `qms_meta.py:105`: `"execution_phase": "pre_release" if executable else None` | |
| EI-5 | Update cmd_release() to set execution_phase to post_release | COMPLETE | `qms.py:1753`: `meta["execution_phase"] = "post_release"` | |
| EI-6 | Update cmd_checkout() to preserve execution_phase | COMPLETE | No changes needed - `update_meta_checkout()` does not modify execution_phase | |
| EI-7 | Update cmd_checkin() to preserve execution_phase | COMPLETE | Updated `update_meta_checkin()` in `qms_meta.py:146-155` with explicit documentation | |
| EI-8 | Update cmd_route() to use execution_phase for workflow path | COMPLETE | `qms.py:1069-1129`: Added execution_phase check for pre/post routing | |
| EI-9 | Test status change audit logging | COMPLETE | Verified STATUS_CHANGE events logged during CR-013 own workflow | |
| EI-10 | Test post-execution checkout/checkin/route cycle | COMPLETE | This CR checkout/route cycle demonstrates the fix | |

---

## 7. References

- **INV-003:** CR-012 Workflow Deficiencies and QMS Permission Gaps (parent investigation)
- **SOP-001:** Document Control (audit trail requirements)
- **SOP-002:** Change Control (workflow definitions)
- **SOP-004:** Document Execution (executable document lifecycle)

---

**END OF DOCUMENT**
