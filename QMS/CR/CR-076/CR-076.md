---
title: Harden MCP Identity Management
revision_summary: Initial draft
---

# CR-076: Harden MCP Identity Management

## 1. Purpose

Eliminate silent identity defaulting, silent override on mismatch, and exception-swallowing fallbacks in the MCP server's identity resolution system. After this CR, every MCP tool call must explicitly declare the caller's identity, mismatches in enforced mode are errors (not warnings), and non-HTTP contexts are handled through an explicit code path rather than exception fallback.

---

## 2. Scope

### 2.1 Context

Discovered during Session-2026-02-10-004 UAT (P1-T3 observation). The `resolve_identity()` function and all 20 tool definitions use `user: str = "claude"` defaults, creating multiple security vulnerabilities. INV-011 CAPA-003 tracks the ADD document type separately; this CR addresses identity hardening directly.

- **Parent Document:** INV-011 (P1-T3 observation)

### 2.2 Changes Summary

1. Remove `= "claude"` default from `resolve_identity()` and `run_qms_command()`
2. Remove `= "claude"` default from all 16 tool definitions that have it
3. Add `user: str` parameter to 4 read-only tools that lack it entirely
4. Replace silent mismatch warning with `ValueError` in enforced mode
5. Replace `try/except (AttributeError, LookupError)` fallback with explicit `if/else`
6. Add empty/whitespace `user` validation
7. Update REQ-MCP-015 in the RS
8. Update RTM with new/renamed/removed tests

### 2.3 Files Affected

- `qms_mcp/server.py` — `resolve_identity()` rewrite, `run_qms_command()` default removal
- `qms_mcp/tools.py` — all 20 tool definitions updated
- `tests/qualification/test_mcp.py` — delete 1, rename 3, add 5, rewrite 1, fix ~20 identity mismatches
- `QMS/SDLC-QMS/SDLC-QMS-RS.md` — REQ-MCP-015 revision
- `QMS/SDLC-QMS/SDLC-QMS-RTM.md` — test traceability updates

---

## 3. Current State

The MCP server's `resolve_identity()` function defaults `user_param` to `"claude"` (an administrator). All 16 write tools default `user` to `"claude"`. Four read-only tools (`qms_status`, `qms_read`, `qms_history`, `qms_comments`) have no `user` parameter at all and call `resolve_identity(ctx)` with only the default. In enforced mode, a mismatch between the HTTP header identity and the `user` parameter produces only a log warning and silently uses the header value. A `try/except (AttributeError, LookupError): pass` block silently falls through to a defensive fallback when request context is unavailable. REQ-MCP-015 does not specify mandatory `user` parameters or mismatch rejection behavior.

---

## 4. Proposed State

`resolve_identity()` requires an explicit `user_param` with no default; empty/whitespace values raise `ValueError`. All 20 MCP tools require `user: str` with no default. In enforced mode, a mismatch between header and `user` param raises `ValueError` with a helpful message identifying the caller's real identity and warning about impersonation. Non-HTTP contexts (stdio, testing) are handled via an explicit `if/else` branch using `getattr`, not exception swallowing. REQ-MCP-015 specifies all hardened behaviors.

---

## 5. Change Description

### 5.1 `resolve_identity()` Rewrite (server.py)

**Signature change:** `user_param: str = "claude"` → `user_param: str`

**Validation:** Raise `ValueError` if `user_param` is empty or whitespace-only.

**Enforced mode mismatch:** Replace the warning-and-continue pattern (lines 181-185) with a `ValueError` that includes:
- The caller's authenticated identity (from header)
- The claimed identity (from param)
- Instruction to use `user='<real_identity>'`
- Warning that impersonation is a QMS violation

Remove the `if user_param != "claude"` carve-out that suppressed warnings for the most common case.

**Exception fallback removal:** Replace `try/except (AttributeError, LookupError): pass` (lines 206-209) with explicit `getattr`-based checks: `request_ctx = getattr(ctx, 'request_context', None)` and similar. The logic becomes a clean `if/elif/else` structure where non-HTTP contexts are an explicit trusted-mode path.

### 5.2 `run_qms_command()` Default Removal (server.py)

**Signature change:** `user: str = "claude"` → `user: str`

### 5.3 Tool Definitions (tools.py)

**16 tools — remove default:** Remove `= "claude"` from `user` parameter and remove `(default: "claude")` from docstrings for: `qms_inbox`, `qms_workspace`, `qms_create`, `qms_checkout`, `qms_checkin`, `qms_cancel`, `qms_route`, `qms_assign`, `qms_review`, `qms_approve`, `qms_reject`, `qms_withdraw`, `qms_release`, `qms_revert`, `qms_close`, `qms_fix`.

**4 tools — add `user: str`:** Add required `user: str` parameter to `qms_status`, `qms_read`, `qms_history`, `qms_comments`. Change their `resolve_identity(ctx)` calls to `resolve_identity(ctx, user)`. Add `user` to docstring Args sections. Place `user: str` before optional parameters in signatures.

### 5.4 Test Suite (test_mcp.py)

**Delete 1 test:** `test_resolve_identity_no_context_default` — calls `resolve_identity(ctx)` with no user; now TypeError.

**Rename 3 tests** (behavior unchanged, semantics clarified):
- `test_resolve_identity_no_context_custom_user` → `test_resolve_identity_stdio_mode_custom_user`
- `test_resolve_identity_attribute_error_defensive_fallback` → `test_resolve_identity_non_starlette_context_uses_trusted_mode`
- `test_identity_collision_enforced_locks_fallback` → `test_identity_collision_enforced_locks_stdio_mode`

**Add 5 new tests:**
- `test_resolve_identity_missing_user_raises_error` — TypeError when user omitted
- `test_resolve_identity_empty_user_raises_error` — ValueError for `""` and `"   "`
- `test_resolve_identity_enforced_mode_mismatch_raises_error` — ValueError when header != param
- `test_resolve_identity_enforced_mode_match_succeeds` — success when header == param
- `test_resolve_identity_mismatch_error_message_helpful` — error text includes real identity, claimed identity, `user='<real>'` instruction, and "violation" warning

**Rewrite 1 test:** `test_resolve_identity_http_header_overrides_user_param` — was: assert returns header (silent override). Now: assert raises ValueError (mismatch rejection).

**Fix ~20 tests with identity mismatches:** All tests where `resolve_identity(http_ctx, "claude")` is called but the header contains a different identity (e.g., `"qa"`) must be updated so the `user` param matches the header.

**Fix mock/helper defaults:** Remove `user="claude"` defaults from `make_mock_resolve_identity()`, all `mock_run`/`capturing_run` functions, and add explicit `user` to test cases that relied on defaults.

**Net test count:** 393 - 1 + 5 = 397 (71 → 75 in test_mcp.py)

---

## 6. Justification

- **Silent defaulting to administrator:** Omitting `user` silently assumes `claude` identity (an administrator), violating least-privilege. Agents should fail explicitly, not succeed silently as admin.
- **Silent override breaks mental models:** Agents calling `qms_inbox(user="qa")` through a container header believe they're acting as QA, but the warning-only mismatch means the header silently wins. This creates incorrect expectations about which identity is in use.
- **Exception swallowing hides bugs:** The `except (AttributeError, LookupError): pass` pattern means any unexpected context state silently falls through rather than surfacing the issue.
- **Read-only tools inconsistency:** Four tools don't accept `user` at all, making audit trail attribution impossible for read operations and creating an inconsistent API surface.

---

## 7. Impact Assessment

### 7.1 Files Affected

| File | Change Type | Description |
|------|-------------|-------------|
| `qms_mcp/server.py` | Modify | Rewrite `resolve_identity()`, remove `run_qms_command()` default |
| `qms_mcp/tools.py` | Modify | Update all 20 tool signatures and docstrings |
| `tests/qualification/test_mcp.py` | Modify | Delete 1, add 5, rename 3, rewrite 1, fix ~20 tests |

### 7.2 Documents Affected

| Document | Change Type | Description |
|----------|-------------|-------------|
| SDLC-QMS-RS | Modify | Revise REQ-MCP-015 text |
| SDLC-QMS-RTM | Modify | Update test tables for REQ-MCP-015 and REQ-MCP-016 |

### 7.3 Other Impacts

**Breaking change for MCP callers:** Any tool call omitting `user` or providing an empty value will now fail with a helpful error instead of silently defaulting. This is intentional — callers must be updated to provide explicit identity. The error messages are designed to guide callers to the correct usage.

### 7.4 Development Controls

This CR implements changes to qms-cli, a controlled submodule. Development follows established controls:

1. **Test environment isolation:** Development in a non-QMS-controlled directory (e.g., `.test-env/`)
2. **Branch isolation:** All development on branch `cr-076-harden-identity`
3. **Write protection:** `.claude/settings.local.json` blocks direct writes to `qms-cli/`
4. **Qualification required:** All new/modified requirements must have passing tests before merge
5. **CI verification:** Tests must pass on GitHub Actions for dev branch
6. **PR gate:** Changes merge to main only via PR after RS/RTM approval
7. **Submodule update:** Parent repo updates pointer only after PR merge

### 7.5 Qualified State Continuity

| Phase | main branch | RS/RTM Status | Qualified Release |
|-------|-------------|---------------|-------------------|
| Before CR | Current commit | EFFECTIVE v11.0 / v13.0 | QMS-13.0 |
| During execution | Unchanged | DRAFT (checked out) | QMS-13.0 (unchanged) |
| Post-approval | Merged from cr-076-harden-identity | EFFECTIVE v12.0 / v14.0 | QMS-14.0 |

---

## 8. Testing Summary

- **Existing tests verified:** 392 existing tests continue to pass (1 deleted)
- **New tests:** 5 new tests verify hardened behaviors (missing user, empty user, mismatch error, match success, helpful error message)
- **Renamed tests:** 3 tests renamed for semantic clarity, behavior unchanged
- **Rewritten test:** 1 test updated from "silent override" to "mismatch rejection" assertion
- **Total:** 397 tests, 75 in test_mcp.py

---

## 9. Implementation Plan

### 9.1 Phase 1: Test Environment Setup

1. Create `.test-env/` working directory
2. Clone/update qms-cli from GitHub
3. Create and checkout branch `cr-076-harden-identity`
4. Verify clean baseline: 393 tests, 71 in test_mcp.py, all passing

### 9.2 Phase 2: Requirements (RS Update)

1. Checkout SDLC-QMS-RS in production QMS
2. Revise REQ-MCP-015 to specify: mandatory `user` parameter, mismatch rejection, explicit non-HTTP handling
3. Checkin RS, route for review and approval

### 9.3 Phase 3: Implementation

1. Rewrite `resolve_identity()` in server.py per Section 5.1
2. Remove `run_qms_command()` default per Section 5.2
3. Update all 20 tool definitions in tools.py per Section 5.3
4. Test locally

### 9.4 Phase 4: Qualification

1. Update test suite per Section 5.4 (delete 1, add 5, rename 3, rewrite 1, fix ~20)
2. Run full test suite, verify 397 tests pass
3. Push to branch
4. Verify GitHub Actions CI passes
5. Document qualified commit hash

### 9.5 Phase 5: RTM Update and Approval

1. Checkout SDLC-QMS-RTM in production QMS
2. Update REQ-MCP-015 and REQ-MCP-016 test tables
3. Update Qualified Baseline section with commit hash and test counts
4. Checkin RTM, route for review and approval
5. **Verify RTM reaches EFFECTIVE status before proceeding to Phase 6**

### 9.6 Phase 6: Merge and Submodule Update

**Prerequisite:** RS and RTM must both be EFFECTIVE before proceeding.

1. Verify RS is EFFECTIVE
2. Verify RTM is EFFECTIVE
3. Create PR to merge cr-076-harden-identity to main
4. Merge PR
5. Update submodule pointer in pipe-dream
6. Verify MCP server starts and identity hardening works

---

## 10. Execution

| EI | Task Description | Execution Summary | Task Outcome | Performed By - Date |
|----|------------------|-------------------|--------------|---------------------|
| EI-1 | Test environment setup: branch qms-cli, verify 393 tests pass | Created branch `cr-076-harden-identity` from main (94345fa). Baseline: 393 tests, 71 in test_mcp.py, all passing. | Pass | claude - 2026-02-10 |
| EI-2 | RS update: revise REQ-MCP-015, route for review/approval | SDLC-QMS-RS v11.1 updated with hardened REQ-MCP-015 text. QA reviewed and approved. Now EFFECTIVE at v12.0. | Pass | claude - 2026-02-10 |
| EI-3 | Implementation: rewrite resolve_identity(), update tools.py | Rewrote `resolve_identity()`: removed default, added empty validation, replaced mismatch warning with ValueError, replaced try/except with getattr. Removed `run_qms_command()` default. Updated all 20 tool definitions (16 removed defaults, 4 added `user` param). Commit a0b1c19. | Pass | claude - 2026-02-10 |
| EI-4 | Qualification: update tests, verify 396 pass, CI green | Deleted 1 test, added 4 new tests, renamed 3, rewrote 1, fixed ~20 identity mismatches. 396 tests pass (74 in test_mcp.py). CI green: run 21891224329. Variance from plan: 396 vs planned 397 — the rewritten test was double-counted as both "rewrite" and "add" in the plan. | Pass | claude - 2026-02-10 |
| EI-5 | RTM update: update test tables and baseline, route for review/approval | SDLC-QMS-RTM v13.1 updated with new test tables and baseline (a0b1c19, 396 tests). QA reviewed and approved. Now EFFECTIVE at v14.0. | Pass | claude - 2026-02-10 |
| EI-6 | Merge and submodule update | PR #12 merged to main (fbe6e22). Submodule pointer updated in pipe-dream. | Pass | claude - 2026-02-10 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Add rows as needed. When adding rows, fill columns 3-5 during execution.
-->

---

### Execution Comments

| Comment | Performed By - Date |
|---------|---------------------|
| Plan estimated 397 total tests (75 in test_mcp.py). Actual is 396 (74 in test_mcp.py). Root cause: the rewritten test (`test_resolve_identity_http_header_overrides_user_param` → `test_resolve_identity_enforced_mode_mismatch_raises_error`) was counted as both "Rewrite 1" and included in "Add 5 new tests" in the plan. The rewrite replaced an existing test (net 0), so actual net change is -1 + 4 = +3, yielding 396. No material impact on scope or quality. | claude - 2026-02-10 |

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Record observations, decisions, or issues encountered during execution.
Add rows as needed.

This section is the appropriate place to attach VARs that do not apply
to any individual execution item, but apply to the CR as a whole.
-->

---

## 11. Execution Summary

<!--
NOTE: Do NOT delete this comment. It provides guidance during document execution.

Complete this section after all EIs are executed.
Summarize the overall outcome and any deviations from the plan.
-->

All 6 execution items completed successfully. Identity hardening implemented per plan: `resolve_identity()` rewritten with mandatory `user` param, empty validation, enforced-mode mismatch rejection, and explicit non-HTTP context handling. All 20 MCP tool definitions updated. 396 tests pass (CI verified). RS v12.0 and RTM v14.0 both EFFECTIVE. PR #12 merged, submodule updated. One minor variance: plan predicted 397 tests but actual is 396 due to a counting error in the plan (rewritten test was double-counted). No impact on completeness.

---

## 12. References

- **SOP-001:** Document Control
- **SOP-002:** Change Control
- **SOP-006:** Software Development Lifecycle
- **INV-011:** CR-075 Incomplete Execution — .mcp.json Transport Change Omitted
- **REQ-MCP-015:** Header-Based Identity Resolution
- **REQ-MCP-016:** Identity Collision Prevention

---

**END OF DOCUMENT**
